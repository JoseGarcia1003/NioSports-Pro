name: Sistema HÃ­brido NBA - ActualizaciÃ³n Diaria

on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC = 1 AM Ecuador
  workflow_dispatch:

jobs:
  update-hybrid-data:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ğŸ Python Setup
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Instalar Dependencias
        run: |
          pip install requests pandas numpy --break-system-packages
          pip install basketball-reference-scraper --break-system-packages
      
      - name: ğŸŸ¢ BALLDONTLIE - ActualizaciÃ³n Diaria
        env:
          BALLDONTLIE_API_KEY: ${{ secrets.BALLDONTLIE_API_KEY }}
        run: python scripts/balldontlie_update.py
        timeout-minutes: 30
      
      - name: ğŸ”µ Basketball Reference - Top 50 (Opcional)
        run: |
          if [ -f "nba_balldontlie_data.json" ]; then
            echo "Ejecutando Basketball Reference para top jugadores..."
            timeout 15m python scripts/basketball_ref_scraper.py || echo "Basketball Reference timeout - continuando"
          fi
        continue-on-error: true
      
      - name: ğŸ”— Consolidar Datos
        run: python scripts/consolidate_data.py
      
      - name: ğŸ“Š Verificar Archivo Final
        run: |
          if [ ! -f "nba_players_database.json" ]; then
            echo "âŒ Error: nba_players_database.json no creado"
            exit 1
          fi
          
          JUGADORES=$(cat nba_players_database.json | grep -o '"nombre":' | wc -l)
          TAMANIO=$(ls -lh nba_players_database.json | awk '{print $5}')
          
          echo "âœ… Base de datos consolidada"
          echo "ğŸ“Š Jugadores: $JUGADORES"
          echo "ğŸ’¾ TamaÃ±o: $TAMANIO"
      
      - name: ğŸ’¾ Commit y Push
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions Hybrid"
          
          git add nba_players_database.json
          git add nba_balldontlie_data.json || true
          git add nba_basketball_ref_data.json || true
          
          git diff --quiet || git commit -m "ğŸ¤– ActualizaciÃ³n hÃ­brida NBA - $(date +'%Y-%m-%d %H:%M')"
          git push
      
      - name: âœ… Resumen Final
        if: always()
        run: |
          echo "=================================="
          if [ -f "nba_players_database.json" ]; then
            JUGADORES=$(cat nba_players_database.json | grep -o '"nombre":' | wc -l)
            TAMANIO=$(ls -lh nba_players_database.json | awk '{print $5}')
            
            echo "âœ… ActualizaciÃ³n completada"
            echo "ğŸ“Š Jugadores: $JUGADORES"
            echo "ğŸ’¾ TamaÃ±o: $TAMANIO"
            echo "ğŸ• Hora: $(date)"
            
            # Verificar fuentes
            if grep -q '"balldontlie": true' nba_players_database.json; then
              echo "ğŸŸ¢ BALLDONTLIE: Activo"
            fi
            
            if grep -q '"basketball_reference": true' nba_players_database.json; then
              echo "ğŸ”µ Basketball Reference: Datos disponibles"
            fi
          else
            echo "âŒ Error: No se generÃ³ la base de datos"
          fi
          echo "=================================="
