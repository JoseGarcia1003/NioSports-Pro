<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NioSports Pro v1.1 - Tendencias NBA</title>
    
    <!-- FAVICON - Logo NioSports -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300c8ff'/%3E%3Cstop offset='50%25' style='stop-color:%23ff3366'/%3E%3Cstop offset='100%25' style='stop-color:%23ff6b35'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%231a1a2e'/%3E%3Ccircle cx='32' cy='32' r='28' fill='none' stroke='url(%23g1)' stroke-width='3'/%3E%3Cpath d='M32 12c-11 0-20 9-20 20s9 20 20 20 20-9 20-20-9-20-20-20zm0 36c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16z' fill='%23ff6b35'/%3E%3Cpath d='M32 18c-7.7 0-14 6.3-14 14h4c0-5.5 4.5-10 10-10V18z' fill='%2300c8ff'/%3E%3Cpath d='M32 18v4c5.5 0 10 4.5 10 10h4c0-7.7-6.3-14-14-14z' fill='%23ff3366'/%3E%3Ctext x='32' y='38' text-anchor='middle' font-family='Arial Black' font-size='14' font-weight='bold' fill='white'%3EN%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Chart.js para grÃ¡ficos del Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { font-family: 'Rajdhani', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(135deg, #00c8ff 0%, #ff3366 50%, #ff6b35 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .slide-in { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .h2h-card { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); }
        .score-input { background: #1a1a2e; border: 2px solid #4a4a6a; }
        .score-input:focus { border-color: #00c8ff; outline: none; }
        .ot-input { border-color: #eab308 !important; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .firebase-status { position: fixed; bottom: 10px; left: 10px; padding: 5px 10px; border-radius: 20px; font-size: 11px; z-index: 1000; }
        .firebase-connected { background: #22c55e; color: white; }
        .firebase-disconnected { background: #ef4444; color: white; }
        .firebase-loading { background: #f59e0b; color: white; }
        
        /* LOADING SPINNER */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 35, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #00c8ff;
            border-right: 4px solid #ff3366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 18px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideInRight 0.4s ease, fadeOut 0.4s ease 4.6s forwards;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .notification.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification.value { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
        
        /* LOGO ANIMATION */
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .logo-icon {
            animation: logoFloat 3s ease-in-out infinite;
        }
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* PICKS CARDS */
        .pick-card {
            transition: all 0.3s ease;
        }
        .pick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .win-badge { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .loss-badge { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .pending-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        /* BEST PICKS HIGHLIGHT */
        .best-pick {
            position: relative;
            overflow: hidden;
        }
        .best-pick::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Cargando NioSports Pro...</div>
    </div>
    
    <!-- NOTIFICATIONS CONTAINER -->
    <div id="notificationContainer"></div>
    
    <div id="firebaseStatus" class="firebase-status firebase-loading">ğŸ”„ Conectando...</div>
    <div id="app"></div>
    
    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyCpddyEiWIE6VBe5u8JRPYBHlnYRMgljCs",
    authDomain: "niosports-pro.firebaseapp.com",
    databaseURL: "https://niosports-pro-default-rtdb.firebaseio.com",
    projectId: "niosports-pro",
    storageBucket: "niosports-pro.firebasestorage.app",
    messagingSenderId: "669355459084",
    appId: "1:669355459084:web:6c11965f3940bae9c8a429"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGO SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOGO_SVG = `
<svg class="logo-icon" width="50" height="50" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#00c8ff"/>
            <stop offset="50%" style="stop-color:#ff3366"/>
            <stop offset="100%" style="stop-color:#ff6b35"/>
        </linearGradient>
    </defs>
    <circle cx="32" cy="32" r="30" fill="#1a1a2e"/>
    <circle cx="32" cy="32" r="28" fill="none" stroke="url(#logoGrad)" stroke-width="3"/>
    <path d="M32 12c-11 0-20 9-20 20s9 20 20 20 20-9 20-20-9-20-20-20zm0 36c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16z" fill="#ff6b35"/>
    <path d="M32 18c-7.7 0-14 6.3-14 14h4c0-5.5 4.5-10 10-10V18z" fill="#00c8ff"/>
    <path d="M32 18v4c5.5 0 10 4.5 10 10h4c0-7.7-6.3-14-14-14z" fill="#ff3366"/>
    <text x="32" y="38" text-anchor="middle" font-family="Arial Black" font-size="14" font-weight="bold" fill="white">N</text>
</svg>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM STATS - CARGA DINÃMICA DESDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NBA_STATS_API = 'https://nba-stats-api.joseluisgarciafonseca.workers.dev/';
let TEAM_STATS = {};
let statsLastUpdated = null;
let statsSource = 'Cargando...';
let apiConnected = false;

// Cargar estadÃ­sticas desde la API
async function loadTeamStatsFromAPI() {
    try {
        showLoading('Cargando estadÃ­sticas NBA...');
        const response = await fetch(NBA_STATS_API);
        const data = await response.json();
        
        if (data.teams && Object.keys(data.teams).length > 0) {
            TEAM_STATS = data.teams;
            statsLastUpdated = data.lastUpdated;
            statsSource = data.source || 'TeamRankings.com';
            apiConnected = true;
            
            // Mostrar si los datos vinieron del cachÃ©
            if (data.cached) {
                console.log('ğŸ“Š Stats cargadas desde cachÃ© (' + data.cacheAge + ')');
            } else {
                console.log('ğŸ“Š Stats actualizadas desde TeamRankings');
            }
            
            showNotification('ğŸ“Š EstadÃ­sticas NBA actualizadas', 'success');
        } else {
            throw new Error('No se recibieron datos de equipos');
        }
    } catch (error) {
        console.error('Error cargando stats:', error);
        apiConnected = false;
        showNotification('âš ï¸ Error cargando stats: usando datos de respaldo', 'warning');
        
        // Datos de respaldo en caso de error
        TEAM_STATS = {
            "Nuggets": { fullHome: 126.1, fullAway: 125.5, full: 125.8, q1Home: 32.9, q1Away: 30.5, q1: 31.7, halfHome: 65.7, halfAway: 59.8, half: 62.4 },
            "Thunder": { fullHome: 121.8, fullAway: 120.8, full: 121.3, q1Home: 30.0, q1Away: 31.4, q1: 30.8, halfHome: 60.8, halfAway: 59.3, half: 60.0 },
            "Rockets": { fullHome: 121.2, fullAway: 120.1, full: 120.5, q1Home: 29.6, q1Away: 30.6, q1: 30.3, halfHome: 61.0, halfAway: 58.1, half: 59.3 },
            "Knicks": { fullHome: 123.1, fullAway: 117.1, full: 120.4, q1Home: 32.0, q1Away: 28.2, q1: 30.2, halfHome: 62.6, halfAway: 58.0, half: 60.8 },
            "Cavaliers": { fullHome: 118.1, fullAway: 123.2, full: 120.2, q1Home: 29.0, q1Away: 32.6, q1: 30.4, halfHome: 54.7, halfAway: 61.3, half: 57.4 },
            "Spurs": { fullHome: 120.4, fullAway: 119.8, full: 120.1, q1Home: 30.2, q1Away: 31.2, q1: 30.7, halfHome: 60.7, halfAway: 59.5, half: 60.1 },
            "Jazz": { fullHome: 126.4, fullAway: 110.7, full: 119.9, q1Home: 34.2, q1Away: 23.9, q1: 30.0, halfHome: 64.1, halfAway: 49.2, half: 57.3 },
            "Bulls": { fullHome: 114.8, fullAway: 123.8, full: 119.7, q1Home: 30.7, q1Away: 29.1, q1: 29.8, halfHome: 59.2, halfAway: 59.2, half: 59.2 },
            "Heat": { fullHome: 119.1, fullAway: 119.3, full: 119.2, q1Home: 28.9, q1Away: 34.0, q1: 31.5, halfHome: 62.1, halfAway: 65.5, half: 63.7 },
            "Pistons": { fullHome: 119.5, fullAway: 118.9, full: 119.2, q1Home: 29.6, q1Away: 30.8, q1: 30.2, halfHome: 59.4, halfAway: 60.9, half: 60.2 },
            "Timberwolves": { fullHome: 115.9, fullAway: 123.0, full: 119.1, q1Home: 29.5, q1Away: 28.5, q1: 29.1, halfHome: 61.4, halfAway: 56.4, half: 58.8 },
            "Hawks": { fullHome: 116.8, fullAway: 120.5, full: 118.8, q1Home: 31.4, q1Away: 29.5, q1: 30.4, halfHome: 58.0, halfAway: 59.3, half: 58.8 },
            "Magic": { fullHome: 115.9, fullAway: 118.3, full: 117.2, q1Home: 29.9, q1Away: 31.3, q1: 30.6, halfHome: 58.2, halfAway: 62.8, half: 60.3 },
            "Trail Blazers": { fullHome: 117.2, fullAway: 117.0, full: 117.1, q1Home: 27.8, q1Away: 29.6, q1: 28.8, halfHome: 57.9, halfAway: 60.1, half: 59.3 },
            "Lakers": { fullHome: 121.1, fullAway: 114.0, full: 116.9, q1Home: 31.8, q1Away: 28.5, q1: 29.8, halfHome: 63.5, halfAway: 57.8, half: 60.4 },
            "76ers": { fullHome: 115.0, fullAway: 119.0, full: 116.6, q1Home: 30.5, q1Away: 32.0, q1: 31.1, halfHome: 60.2, halfAway: 64.6, half: 62.0 },
            "Celtics": { fullHome: 118.6, fullAway: 113.2, full: 116.0, q1Home: 29.8, q1Away: 31.3, q1: 30.5, halfHome: 61.4, halfAway: 59.4, half: 60.4 },
            "Pelicans": { fullHome: 119.9, fullAway: 109.5, full: 115.5, q1Home: 30.1, q1Away: 24.9, q1: 27.9, halfHome: 58.8, halfAway: 52.5, half: 56.0 },
            "Hornets": { fullHome: 116.1, fullAway: 114.8, full: 115.4, q1Home: 32.1, q1Away: 28.3, q1: 30.2, halfHome: 59.8, halfAway: 57.2, half: 58.5 },
            "Grizzlies": { fullHome: 117.2, fullAway: 113.1, full: 115.0, q1Home: 28.9, q1Away: 28.2, q1: 28.5, halfHome: 59.7, halfAway: 52.7, half: 56.2 },
            "Suns": { fullHome: 116.4, fullAway: 113.2, full: 114.9, q1Home: 28.1, q1Away: 30.8, q1: 29.4, halfHome: 57.7, halfAway: 59.1, half: 58.3 },
            "Warriors": { fullHome: 118.3, fullAway: 111.5, full: 114.5, q1Home: 27.6, q1Away: 25.8, q1: 26.6, halfHome: 57.2, halfAway: 51.6, half: 54.0 },
            "Mavericks": { fullHome: 114.6, fullAway: 112.6, full: 113.7, q1Home: 28.9, q1Away: 28.3, q1: 28.6, halfHome: 53.3, halfAway: 54.0, half: 53.6 },
            "Raptors": { fullHome: 113.0, fullAway: 113.8, full: 113.4, q1Home: 28.6, q1Away: 29.2, q1: 28.9, halfHome: 57.9, halfAway: 57.3, half: 57.6 },
            "Bucks": { fullHome: 117.1, fullAway: 108.4, full: 113.0, q1Home: 28.3, q1Away: 28.9, q1: 28.6, halfHome: 57.3, halfAway: 55.4, half: 56.4 },
            "Wizards": { fullHome: 115.3, fullAway: 110.6, full: 112.6, q1Home: 30.2, q1Away: 28.9, q1: 29.5, halfHome: 60.5, halfAway: 54.8, half: 57.4 },
            "Kings": { fullHome: 110.4, fullAway: 113.4, full: 112.0, q1Home: 27.7, q1Away: 29.1, q1: 28.4, halfHome: 53.0, halfAway: 60.2, half: 57.1 },
            "Clippers": { fullHome: 112.8, fullAway: 109.9, full: 111.2, q1Home: 30.5, q1Away: 29.5, q1: 30.0, halfHome: 60.7, halfAway: 54.9, half: 57.3 },
            "Nets": { fullHome: 108.7, fullAway: 109.9, full: 109.3, q1Home: 28.7, q1Away: 27.7, q1: 28.2, halfHome: 54.9, halfAway: 57.5, half: 56.1 },
            "Pacers": { fullHome: 112.7, fullAway: 105.1, full: 109.2, q1Home: 28.3, q1Away: 26.8, q1: 27.6, halfHome: 56.3, halfAway: 52.4, half: 54.4 }
        };
        statsSource = 'Datos de respaldo (offline)';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VARIABLES DE ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let H2H_DATABASE = {};
let PICKS_DATABASE = {};
let currentView = 'home';
let localTeam = '', visitingTeam = '';
let lineQ1 = '', lineHalf = '', lineFull = '';
let typeQ1 = 'OVER', typeHalf = 'OVER', typeFull = 'OVER';
// NUEVO: Variables para cuotas (odds decimales)
let oddsQ1 = '', oddsHalf = '', oddsFull = '';
// NUEVO v1.1: Variables para Back-to-Back
let b2bLocal = false, b2bVisiting = false;
let ingestTeam1 = '', ingestTeam2 = '', ingestLocalTeam = '', ingestDate = '';
let ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
let firebaseConnected = false;
let isLoading = true;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACK-TO-BACK DETECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleB2B(team) {
    if (team === 'local') {
        b2bLocal = !b2bLocal;
    } else {
        b2bVisiting = !b2bVisiting;
    }
    render();
}

// Ajustar tendencias por B2B (-5% rendimiento en 2H y Full)
function adjustForB2B(trends, period) {
    if (!b2bLocal && !b2bVisiting) return trends;
    
    let adjustedTrends = { ...trends };
    
    // ReducciÃ³n tÃ­pica por B2B: ~3-5 puntos menos para el equipo en B2B
    // Especialmente notorio en 2da mitad
    const b2bPenalty = {
        q1: 1.0,   // Menor impacto en Q1
        half: 1.5, // Algo de impacto en 1H
        full: 3.0  // Mayor impacto en Full
    };
    
    let penalty = 0;
    if (b2bLocal) penalty += b2bPenalty[period] || 0;
    if (b2bVisiting) penalty += b2bPenalty[period] || 0;
    
    if (period === 'q1') adjustedTrends.q1 = (parseFloat(trends.q1) - penalty).toFixed(1);
    if (period === 'half') adjustedTrends.half = (parseFloat(trends.half) - penalty).toFixed(1);
    if (period === 'full') adjustedTrends.full = (parseFloat(trends.full) - penalty).toFixed(1);
    
    return adjustedTrends;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING & NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(text = 'Cargando...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = overlay.querySelector('.loading-text');
    loadingText.textContent = text;
    overlay.classList.remove('hidden');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('hidden');
    isLoading = false;
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = message;
    container.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE DATABASE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateFirebaseStatus(status) {
    const el = document.getElementById('firebaseStatus');
    if (status === 'connected') {
        el.textContent = 'ğŸŸ¢ Firebase Conectado';
        el.className = 'firebase-status firebase-connected';
        firebaseConnected = true;
    } else if (status === 'disconnected') {
        el.textContent = 'ğŸ”´ Sin ConexiÃ³n';
        el.className = 'firebase-status firebase-disconnected';
        firebaseConnected = false;
    } else {
        el.textContent = 'ğŸ”„ Conectando...';
        el.className = 'firebase-status firebase-loading';
    }
}

// Listener de conexiÃ³n
database.ref('.info/connected').on('value', (snap) => {
    updateFirebaseStatus(snap.val() ? 'connected' : 'disconnected');
});

// Cargar datos de Firebase al iniciar
function loadH2HFromFirebase() {
    showLoading('Cargando datos H2H...');
    database.ref('h2h_games').on('value', (snapshot) => {
        if (snapshot.exists()) {
            H2H_DATABASE = snapshot.val();
        } else {
            H2H_DATABASE = {};
        }
        loadPicksFromFirebase();
    }, (error) => {
        console.error('Error cargando datos:', error);
        updateFirebaseStatus('disconnected');
        hideLoading();
    });
}

// Cargar picks de Firebase
function loadPicksFromFirebase() {
    showLoading('Cargando historial de picks...');
    database.ref('picks').on('value', (snapshot) => {
        if (snapshot.exists()) {
            PICKS_DATABASE = snapshot.val();
        } else {
            PICKS_DATABASE = {};
        }
        hideLoading();
        render();
        checkForValuePicks();
    }, (error) => {
        console.error('Error cargando picks:', error);
        hideLoading();
        render();
    });
}

// Guardar H2H en Firebase
function saveH2HToFirebase() {
    showLoading('Guardando en Firebase...');
    database.ref('h2h_games').set(H2H_DATABASE)
        .then(() => {
            console.log('âœ… H2H Guardado en Firebase');
            hideLoading();
            showNotification('âœ… Partido guardado correctamente', 'success');
        })
        .catch((error) => {
            console.error('Error guardando:', error);
            hideLoading();
            showNotification('âŒ Error guardando: ' + error.message, 'warning');
        });
}

// Guardar picks en Firebase
function savePicksToFirebase() {
    database.ref('picks').set(PICKS_DATABASE)
        .then(() => console.log('âœ… Picks guardados'))
        .catch((error) => console.error('Error guardando picks:', error));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES H2H DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getH2HKey(t1, t2) { return [t1, t2].sort().join('_'); }

function addH2HGame(t1, t2, data) { 
    const k = getH2HKey(t1, t2); 
    if (!H2H_DATABASE[k]) H2H_DATABASE[k] = []; 
    H2H_DATABASE[k].unshift(data); 
    saveH2HToFirebase();
}

function deleteH2HGame(t1, t2, idx) { 
    const k = getH2HKey(t1, t2); 
    if (H2H_DATABASE[k]) { 
        H2H_DATABASE[k].splice(idx, 1); 
        if (H2H_DATABASE[k].length === 0) delete H2H_DATABASE[k]; 
        saveH2HToFirebase();
    } 
}

function getH2HData(team1, team2) {
    const k = getH2HKey(team1, team2), games = H2H_DATABASE[k] || [];
    if (games.length === 0) return null;
    let t1W = 0, t2W = 0, t1Pts = 0, t2Pts = 0;
    const proc = games.slice(0, 10).map(g => {
        const isT1L = g.localTeam === team1;
        const t1Q1 = isT1L ? g.localQ1 : g.awayQ1, t1Q2 = isT1L ? g.localQ2 : g.awayQ2;
        const t1Q3 = isT1L ? g.localQ3 : g.awayQ3, t1Q4 = isT1L ? g.localQ4 : g.awayQ4;
        const t2Q1 = isT1L ? g.awayQ1 : g.localQ1, t2Q2 = isT1L ? g.awayQ2 : g.localQ2;
        const t2Q3 = isT1L ? g.awayQ3 : g.localQ3, t2Q4 = isT1L ? g.awayQ4 : g.localQ4;
        const t1OT = isT1L ? ((g.localOT1||0)+(g.localOT2||0)+(g.localOT3||0)) : ((g.awayOT1||0)+(g.awayOT2||0)+(g.awayOT3||0));
        const t2OT = isT1L ? ((g.awayOT1||0)+(g.awayOT2||0)+(g.awayOT3||0)) : ((g.localOT1||0)+(g.localOT2||0)+(g.localOT3||0));
        const t1T = t1Q1+t1Q2+t1Q3+t1Q4+t1OT, t2T = t2Q1+t2Q2+t2Q3+t2Q4+t2OT;
        t1Pts += t1T; t2Pts += t2T;
        if (t1T > t2T) t1W++; else t2W++;
        return { date: g.date, localTeam: g.localTeam, awayTeam: g.awayTeam, t1Q1, t1Q2, t1Q3, t1Q4, t2Q1, t2Q2, t2Q3, t2Q4, t1Half: t1Q1+t1Q2, t2Half: t2Q1+t2Q2, t1Total: t1T, t2Total: t2T, totalPts: t1T+t2T, winner: t1T>t2T ? team1 : team2, overtimes: g.overtimes||0 };
    });
    const n = proc.length;
    return {
        team1, team2,
        record: { team1Wins: t1W, team2Wins: t2W },
        avgPts: { team1: n ? t1Pts/n : 0, team2: n ? t2Pts/n : 0 },
        avgQ1: { team1: n ? proc.reduce((s,g) => s+g.t1Q1, 0)/n : 0, team2: n ? proc.reduce((s,g) => s+g.t2Q1, 0)/n : 0 },
        avgHalf: { team1: n ? proc.reduce((s,g) => s+g.t1Half, 0)/n : 0, team2: n ? proc.reduce((s,g) => s+g.t2Half, 0)/n : 0 },
        games: proc,
        totalGames: games.length
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKS TRACKING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPick(pickData) {
    const pickId = Date.now().toString();
    PICKS_DATABASE[pickId] = {
        ...pickData,
        id: pickId,
        createdAt: new Date().toISOString(),
        status: 'pending' // pending, win, loss
    };
    savePicksToFirebase();
    showNotification('ğŸ“ Pick registrado correctamente', 'success');
    render();
}

function updatePickResult(pickId, result) {
    if (PICKS_DATABASE[pickId]) {
        PICKS_DATABASE[pickId].status = result;
        PICKS_DATABASE[pickId].resolvedAt = new Date().toISOString();
        savePicksToFirebase();
        showNotification(result === 'win' ? 'âœ… Â¡Pick ganado!' : 'âŒ Pick perdido', result === 'win' ? 'success' : 'warning');
        render();
    }
}

function deletePick(pickId) {
    if (PICKS_DATABASE[pickId]) {
        delete PICKS_DATABASE[pickId];
        savePicksToFirebase();
        showNotification('ğŸ—‘ï¸ Pick eliminado', 'info');
        render();
    }
}

// Agregar lÃ­nea de cierre para CLV
function addClosingLine(pickId, originalLine) {
    const closingLine = prompt(`LÃ­nea de cierre para este pick:\n(LÃ­nea original: ${originalLine})`);
    if (closingLine === null) return;
    
    const closing = parseFloat(closingLine);
    if (isNaN(closing)) {
        showNotification('âš ï¸ Ingresa un nÃºmero vÃ¡lido', 'warning');
        return;
    }
    
    if (PICKS_DATABASE[pickId]) {
        PICKS_DATABASE[pickId].closingLine = closing;
        savePicksToFirebase();
        
        const original = parseFloat(originalLine);
        const pick = PICKS_DATABASE[pickId];
        const clv = pick.betType === 'OVER' 
            ? (closing - original).toFixed(1)
            : (original - closing).toFixed(1);
        
        const clvText = parseFloat(clv) >= 0 ? `+${clv}` : clv;
        showNotification(`ğŸ¯ CLV registrado: ${clvText} puntos`, parseFloat(clv) >= 0 ? 'success' : 'info');
        render();
    }
}

function getPicksStats() {
    const picks = Object.values(PICKS_DATABASE);
    const total = picks.length;
    const wins = picks.filter(p => p.status === 'win').length;
    const losses = picks.filter(p => p.status === 'loss').length;
    const pending = picks.filter(p => p.status === 'pending').length;
    const resolved = wins + losses;
    const winRate = resolved > 0 ? ((wins / resolved) * 100).toFixed(1) : 0;
    
    // Stats por tipo de apuesta
    const byType = {};
    picks.forEach(p => {
        const key = `${p.period}_${p.betType}`;
        if (!byType[key]) byType[key] = { wins: 0, losses: 0, total: 0, profit: 0 };
        byType[key].total++;
        if (p.status === 'win') {
            byType[key].wins++;
            byType[key].profit += p.odds ? (parseFloat(p.odds) - 1) : 0;
        }
        if (p.status === 'loss') {
            byType[key].losses++;
            byType[key].profit -= 1;
        }
    });
    
    // Stats por perÃ­odo (1Q, 1H, FULL)
    const byPeriod = { '1Q': { wins: 0, losses: 0, total: 0, profit: 0 }, '1H': { wins: 0, losses: 0, total: 0, profit: 0 }, 'FULL': { wins: 0, losses: 0, total: 0, profit: 0 } };
    picks.forEach(p => {
        if (byPeriod[p.period]) {
            byPeriod[p.period].total++;
            if (p.status === 'win') {
                byPeriod[p.period].wins++;
                byPeriod[p.period].profit += p.odds ? (parseFloat(p.odds) - 1) : 0;
            }
            if (p.status === 'loss') {
                byPeriod[p.period].losses++;
                byPeriod[p.period].profit -= 1;
            }
        }
    });
    
    // Stats por equipo
    const byTeam = {};
    picks.forEach(p => {
        [p.localTeam, p.awayTeam].forEach(team => {
            if (!byTeam[team]) byTeam[team] = { wins: 0, losses: 0, total: 0 };
            byTeam[team].total++;
            if (p.status === 'win') byTeam[team].wins++;
            if (p.status === 'loss') byTeam[team].losses++;
        });
    });
    
    // Profit/Loss calculation
    let profit = 0;
    let totalStaked = 0;
    picks.forEach(p => {
        if (p.status === 'win' && p.odds) {
            profit += (parseFloat(p.odds) - 1);
            totalStaked += 1;
        } else if (p.status === 'loss') {
            profit -= 1;
            totalStaked += 1;
        }
    });
    
    // ROI calculation
    const roi = totalStaked > 0 ? ((profit / totalStaked) * 100).toFixed(1) : 0;
    
    // Racha actual (streak)
    const sortedPicks = picks
        .filter(p => p.status !== 'pending')
        .sort((a, b) => new Date(b.resolvedAt || b.createdAt) - new Date(a.resolvedAt || a.createdAt));
    
    let streak = 0;
    let streakType = null;
    for (const pick of sortedPicks) {
        if (streakType === null) {
            streakType = pick.status;
            streak = 1;
        } else if (pick.status === streakType) {
            streak++;
        } else {
            break;
        }
    }
    
    // Mejor y peor racha histÃ³rica
    let currentStreak = 0;
    let currentType = null;
    let bestWinStreak = 0;
    let worstLossStreak = 0;
    
    const chronologicalPicks = [...sortedPicks].reverse();
    chronologicalPicks.forEach(p => {
        if (currentType === p.status) {
            currentStreak++;
        } else {
            currentType = p.status;
            currentStreak = 1;
        }
        if (p.status === 'win' && currentStreak > bestWinStreak) bestWinStreak = currentStreak;
        if (p.status === 'loss' && currentStreak > worstLossStreak) worstLossStreak = currentStreak;
    });
    
    return { 
        total, wins, losses, pending, winRate, byType, byTeam, byPeriod,
        profit: profit.toFixed(2), 
        roi,
        streak: { count: streak, type: streakType },
        bestWinStreak,
        worstLossStreak
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEST PICKS ALGORITHM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBestPicks() {
    const teams = getTeams();
    const bestPicks = [];
    
    // Analizar todos los matchups posibles
    teams.forEach(local => {
        teams.forEach(away => {
            if (local === away) return;
            
            const lD = TEAM_STATS[local];
            const vD = TEAM_STATS[away];
            
            if (!lD || !vD) return;
            
            // Calcular tendencias
            const trends = {
                q1: lD.q1Home + vD.q1Away,
                half: lD.halfHome + vD.halfAway,
                full: lD.fullHome + vD.fullAway
            };
            
            // H2H data
            const h2h = getH2HData(local, away);
            
            // Analizar cada perÃ­odo
            ['q1', 'half', 'full'].forEach(period => {
                const trend = trends[period];
                const periodLabel = period === 'q1' ? '1Q' : period === 'half' ? '1H' : 'FULL';
                
                // LÃ­neas sugeridas basadas en tendencia
                const suggestedLine = Math.round(trend * 2) / 2;
                
                // Calcular probabilidad OVER
                const probOver = calcProb(trend.toString(), suggestedLine.toString(), 'OVER');
                
                if (probOver && probOver >= 60) {
                    let confidence = probOver;
                    let reason = `Tendencia: ${trend.toFixed(1)}`;
                    
                    // Bonus por H2H
                    if (h2h && h2h.games.length >= 3) {
                        const h2hAvg = period === 'q1' 
                            ? h2h.avgQ1.team1 + h2h.avgQ1.team2
                            : period === 'half'
                            ? h2h.avgHalf.team1 + h2h.avgHalf.team2
                            : h2h.avgPts.team1 + h2h.avgPts.team2;
                        
                        if (h2hAvg > suggestedLine) {
                            confidence += 5;
                            reason += ` | H2H: ${h2hAvg.toFixed(1)}`;
                        }
                    }
                    
                    bestPicks.push({
                        local,
                        away,
                        period: periodLabel,
                        betType: 'OVER',
                        line: suggestedLine,
                        trend: trend.toFixed(1),
                        confidence: Math.min(confidence, 95),
                        reason,
                        h2hGames: h2h ? h2h.games.length : 0
                    });
                }
            });
        });
    });
    
    // Ordenar por confianza y retornar top 5
    return bestPicks.sort((a, b) => b.confidence - a.confidence).slice(0, 5);
}

function checkForValuePicks() {
    if (!localTeam || !visitingTeam) return;
    
    const lD = TEAM_STATS[localTeam];
    const vD = TEAM_STATS[visitingTeam];
    
    if (!lD || !vD) return;
    
    const trends = {
        q1: (lD.q1Home + vD.q1Away).toFixed(1),
        half: (lD.halfHome + vD.halfAway).toFixed(1),
        full: (lD.fullHome + vD.fullAway).toFixed(1)
    };
    
    // Verificar si hay valores altos
    [
        { period: '1Q', trend: trends.q1, line: lineQ1, type: typeQ1 },
        { period: '1H', trend: trends.half, line: lineHalf, type: typeHalf },
        { period: 'FULL', trend: trends.full, line: lineFull, type: typeFull }
    ].forEach(({ period, trend, line, type }) => {
        if (line) {
            const prob = calcProb(trend, line, type);
            if (prob && prob >= 70) {
                showNotification(`ğŸ”¥ VALOR ALTO en ${period}: ${prob}% ${type} ${line}`, 'value');
            }
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTeams() { return Object.keys(TEAM_STATS).sort(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA PROFESIONAL DE EXPECTED VALUE (EV)
// Basado en: Gabel & Redner (2012), MartÃ­n-GonzÃ¡lez et al. (2016)
// Paper: "Random Walk Picture of Basketball Scoring"
// Fuente: Journal of Quantitative Analysis in Sports
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Desviaciones estÃ¡ndar calibradas para TOTALES COMBINADOS en NBA
// Basado en coeficiente de difusiÃ³n D = 0.0363 puntosÂ²/segundo
// La varianza escala con âˆšt (raÃ­z cuadrada del tiempo), no linealmente
const NBA_STD_DEVS = {
    Q1: 8.0,    // 1er Cuarto: ~7-9 puntos SD (usamos 8)
    HALF: 13.0, // 1era Mitad: ~12-14 puntos SD (usamos 13)
    FULL: 18.5  // Partido Completo: ~17-20 puntos SD (usamos 18.5)
};

// Determinar quÃ© SD usar basado en el rango de tendencia
function getStdDev(trendValue) {
    // Rangos tÃ­picos de totales combinados:
    // 1Q: 50-65 puntos â†’ tendencia < 70
    // 1H: 100-130 puntos â†’ tendencia 70-160
    // Full: 200-250 puntos â†’ tendencia >= 160
    if (trendValue < 70) return NBA_STD_DEVS.Q1;
    if (trendValue < 160) return NBA_STD_DEVS.HALF;
    return NBA_STD_DEVS.FULL;
}

// Calcular probabilidad usando distribuciÃ³n normal
// MÃ©todo: CDF de distribuciÃ³n normal estÃ¡ndar
function calcProb(trend, line, type) {
    if (!trend || trend === '-' || !line) return null;
    const trendNum = parseFloat(trend);
    const lineNum = parseFloat(line);
    const diff = trendNum - lineNum;
    
    // Obtener desviaciÃ³n estÃ¡ndar apropiada para el perÃ­odo
    const std = getStdDev(trendNum);
    
    // Calcular Z-score
    const z = diff / std;
    
    // CDF de distribuciÃ³n normal estÃ¡ndar (aproximaciÃ³n de Abramowitz-Stegun)
    // PrecisiÃ³n: error < 7.5Ã—10â»â¸
    const cdf = x => {
        const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
        const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
        const sign = x < 0 ? -1 : 1;
        const absX = Math.abs(x);
        const t = 1.0 / (1.0 + p * absX);
        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX / 2);
        return 0.5 * (1.0 + sign * y);
    };
    
    // Para OVER: probabilidad de que el resultado sea > lÃ­nea
    // Para UNDER: probabilidad de que el resultado sea < lÃ­nea
    let prob = type === 'OVER' ? cdf(z) : 1 - cdf(z);
    
    // Aplicar factor de regresiÃ³n conservador para evitar sobreconfianza
    // Los extremos tienden a normalizarse (regresiÃ³n a la media)
    // Factor 0.95 = conservador, evita probabilidades extremas irreales
    const regressionFactor = 0.95;
    prob = prob * regressionFactor + 0.5 * (1 - regressionFactor);
    
    // Limitar entre 5% y 95% para ser realistas
    prob = Math.max(0.05, Math.min(0.95, prob));
    
    return Math.round(prob * 100);
}

// Calcular Expected Value (EV) - LA MÃ‰TRICA MÃS IMPORTANTE
function calcEV(prob, odds) {
    if (!prob || !odds) return null;
    const p = prob / 100;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // EV = (Prob Ã— Ganancia) - (1-Prob Ã— PÃ©rdida)
    // Ganancia si ganas = (odds - 1) por unidad
    // PÃ©rdida si pierdes = 1 unidad
    const ev = (p * (oddsNum - 1)) - ((1 - p) * 1);
    return (ev * 100).toFixed(1); // Retorna como porcentaje
}

// Calcular Edge (Ventaja sobre la casa)
function calcEdge(prob, odds) {
    if (!prob || !odds) return null;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // Probabilidad implÃ­cita de la casa (sin vig)
    const impliedProb = 1 / oddsNum;
    const ourProb = prob / 100;
    
    // Edge = Nuestra probabilidad - Probabilidad implÃ­cita
    const edge = (ourProb - impliedProb) * 100;
    return edge.toFixed(1);
}

// Calcular Cuota Justa (Fair Odds)
function calcFairOdds(prob) {
    if (!prob || prob <= 0 || prob >= 100) return null;
    // Cuota Justa = 1 / Probabilidad
    return (100 / prob).toFixed(2);
}

// Calcular Kelly Criterion (% Ã³ptimo de bankroll a apostar)
function calcKelly(prob, odds) {
    if (!prob || !odds) return null;
    const p = prob / 100;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // Kelly = (p Ã— (odds - 1) - (1-p)) / (odds - 1)
    // Simplificado: Kelly = (p Ã— odds - 1) / (odds - 1)
    const kelly = ((p * oddsNum) - 1) / (oddsNum - 1);
    
    // Kelly fraccionario (mÃ¡s conservador, usar 25% del Kelly completo)
    const fractionalKelly = kelly * 0.25;
    
    if (fractionalKelly <= 0) return 0;
    return (fractionalKelly * 100).toFixed(1);
}

// AnÃ¡lisis completo de una apuesta (incluye mÃ©tricas de transparencia)
function analyzebet(trend, line, type, odds) {
    if (!trend || trend === '-' || !line) return null;
    
    const trendNum = parseFloat(trend);
    const lineNum = parseFloat(line);
    const diff = trendNum - lineNum;
    const std = getStdDev(trendNum);
    const zScore = diff / std;
    
    const prob = calcProb(trend, line, type);
    if (!prob) return null;
    
    const fairOdds = calcFairOdds(prob);
    const ev = odds ? calcEV(prob, odds) : null;
    const edge = odds ? calcEdge(prob, odds) : null;
    const kelly = odds ? calcKelly(prob, odds) : null;
    
    // Incluir mÃ©tricas de transparencia
    return { 
        prob, 
        fairOdds, 
        ev, 
        edge, 
        kelly,
        // MÃ©tricas adicionales para transparencia
        diff: diff.toFixed(1),
        std: std.toFixed(1),
        zScore: zScore.toFixed(2)
    };
}

// Color basado en EV (no solo probabilidad)
function evColor(ev, prob) {
    if (ev === null) {
        // Sin cuota ingresada, usar probabilidad
        if (!prob) return 'bg-gray-600';
        if (prob >= 65) return 'bg-blue-600';
        if (prob >= 55) return 'bg-blue-500';
        if (prob >= 45) return 'bg-gray-500';
        return 'bg-gray-600';
    }
    
    const evNum = parseFloat(ev);
    if (evNum >= 15) return 'bg-gradient-to-r from-emerald-500 to-green-600'; // Elite
    if (evNum >= 7) return 'bg-gradient-to-r from-green-500 to-emerald-600';  // Alto Valor
    if (evNum >= 3) return 'bg-gradient-to-r from-lime-500 to-green-500';     // Valor
    if (evNum >= 0) return 'bg-gradient-to-r from-yellow-500 to-amber-500';   // Marginal
    return 'bg-gradient-to-r from-red-500 to-rose-600';                       // Sin Valor
}

// Veredicto profesional basado en EV
function evVerdict(ev, prob, edge) {
    if (ev === null) {
        // Sin cuota, dar indicaciÃ³n basada en probabilidad
        if (!prob) return { icon: 'â“', text: 'Ingresa lÃ­nea', class: 'text-gray-400' };
        if (prob >= 65) return { icon: 'ğŸ“Š', text: 'PROB. ALTA', class: 'text-blue-400' };
        if (prob >= 55) return { icon: 'ğŸ“ˆ', text: 'PROB. MEDIA', class: 'text-blue-300' };
        if (prob >= 45) return { icon: 'âš–ï¸', text: 'NEUTRAL', class: 'text-gray-300' };
        return { icon: 'ğŸ“‰', text: 'PROB. BAJA', class: 'text-gray-400' };
    }
    
    const evNum = parseFloat(ev);
    const edgeNum = parseFloat(edge);
    
    if (evNum >= 15) return { icon: 'ğŸ”¥', text: 'ELITE VALUE', class: 'text-emerald-400', stars: 'â˜…â˜…â˜…â˜…â˜…' };
    if (evNum >= 10) return { icon: 'ğŸ’', text: 'ALTO VALOR', class: 'text-green-400', stars: 'â˜…â˜…â˜…â˜…â˜†' };
    if (evNum >= 7) return { icon: 'âœ…', text: 'MUY BUENO', class: 'text-green-300', stars: 'â˜…â˜…â˜…â˜…â˜†' };
    if (evNum >= 5) return { icon: 'âœ…', text: 'BUEN VALOR', class: 'text-lime-400', stars: 'â˜…â˜…â˜…â˜†â˜†' };
    if (evNum >= 3) return { icon: 'ğŸ‘', text: 'VALOR', class: 'text-lime-300', stars: 'â˜…â˜…â˜…â˜†â˜†' };
    if (evNum >= 0) return { icon: 'âš ï¸', text: 'MARGINAL', class: 'text-yellow-400', stars: 'â˜…â˜…â˜†â˜†â˜†' };
    if (evNum >= -3) return { icon: 'â›”', text: 'SIN VALOR', class: 'text-orange-400', stars: 'â˜…â˜†â˜†â˜†â˜†' };
    return { icon: 'ğŸš«', text: 'NO APOSTAR', class: 'text-red-400', stars: 'â˜†â˜†â˜†â˜†â˜†' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODELO DE MACHINE LEARNING v1.1
// Aprende de tu historial para mejorar predicciones
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ML_MODEL = {
    // Coeficientes del modelo (se actualizan con los datos)
    coefficients: {
        zScore: 0.3,      // Peso del Z-Score
        evWeight: 0.25,   // Peso del EV
        h2hWeight: 0.2,   // Peso del historial H2H
        periodBias: {     // Bias por perÃ­odo (se aprende)
            '1Q': 0,
            '1H': 0,
            'FULL': 0
        },
        typeBias: {       // Bias por tipo (se aprende)
            'OVER': 0,
            'UNDER': 0
        }
    },
    
    // Entrenar modelo con datos histÃ³ricos
    train: function() {
        const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending');
        if (picks.length < 10) return; // Necesitamos mÃ­nimo 10 picks
        
        // Calcular bias por perÃ­odo
        const periodStats = { '1Q': {wins:0, total:0}, '1H': {wins:0, total:0}, 'FULL': {wins:0, total:0} };
        picks.forEach(p => {
            if (periodStats[p.period]) {
                periodStats[p.period].total++;
                if (p.status === 'win') periodStats[p.period].wins++;
            }
        });
        
        Object.keys(periodStats).forEach(period => {
            if (periodStats[period].total >= 5) {
                const winRate = periodStats[period].wins / periodStats[period].total;
                // Bias positivo si ganas mÃ¡s del 52.4% (breakeven), negativo si menos
                this.coefficients.periodBias[period] = (winRate - 0.524) * 0.1;
            }
        });
        
        // Calcular bias por tipo (Over/Under)
        const typeStats = { 'OVER': {wins:0, total:0}, 'UNDER': {wins:0, total:0} };
        picks.forEach(p => {
            if (typeStats[p.betType]) {
                typeStats[p.betType].total++;
                if (p.status === 'win') typeStats[p.betType].wins++;
            }
        });
        
        Object.keys(typeStats).forEach(type => {
            if (typeStats[type].total >= 5) {
                const winRate = typeStats[type].wins / typeStats[type].total;
                this.coefficients.typeBias[type] = (winRate - 0.524) * 0.1;
            }
        });
        
        console.log('ğŸ¤– ML Model trained with', picks.length, 'picks');
    },
    
    // Predecir ajuste de probabilidad
    predict: function(period, betType, baseProb, zScore, ev) {
        // Entrenar si no se ha hecho
        this.train();
        
        let adjustment = 0;
        
        // Aplicar bias de perÃ­odo aprendido
        adjustment += (this.coefficients.periodBias[period] || 0) * 100;
        
        // Aplicar bias de tipo aprendido
        adjustment += (this.coefficients.typeBias[betType] || 0) * 100;
        
        // Ajuste por Z-Score extremo
        if (Math.abs(zScore) > 2) {
            // Z-Scores muy altos suelen revertir a la media
            adjustment -= Math.sign(zScore) * 2;
        }
        
        // Ajuste por EV (si es muy alto, puede ser trampa)
        if (ev && parseFloat(ev) > 20) {
            adjustment -= 3; // Penalizar EV excesivamente alto
        }
        
        return Math.round(adjustment);
    },
    
    // Obtener score de confianza del modelo (0-100)
    getConfidence: function() {
        const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending');
        if (picks.length < 10) return 0;
        if (picks.length < 20) return 30;
        if (picks.length < 50) return 60;
        return 80;
    }
};

// Aplicar modelo ML a la probabilidad base
function applyMLAdjustment(baseProb, period, betType, zScore, ev) {
    const adjustment = ML_MODEL.predict(period, betType, baseProb, zScore, ev);
    const mlProb = Math.max(5, Math.min(95, baseProb + adjustment));
    return {
        prob: mlProb,
        adjustment,
        confidence: ML_MODEL.getConfidence()
    };
}

// RecomendaciÃ³n de stake basada en Kelly
function stakeRec(kelly) {
    if (!kelly || kelly <= 0) return { text: 'No apostar', class: 'text-red-400' };
    const k = parseFloat(kelly);
    if (k >= 5) return { text: '3-5% bankroll', class: 'text-green-400' };
    if (k >= 3) return { text: '2-3% bankroll', class: 'text-lime-400' };
    if (k >= 1.5) return { text: '1-2% bankroll', class: 'text-yellow-400' };
    if (k >= 0.5) return { text: '0.5-1% bankroll', class: 'text-orange-400' };
    return { text: 'MÃ­nimo', class: 'text-gray-400' };
}

function getScores() {
    return {
        lQ1: parseInt(ingestScores.localQ1) || 0, lQ2: parseInt(ingestScores.localQ2) || 0,
        lQ3: parseInt(ingestScores.localQ3) || 0, lQ4: parseInt(ingestScores.localQ4) || 0,
        aQ1: parseInt(ingestScores.awayQ1) || 0, aQ2: parseInt(ingestScores.awayQ2) || 0,
        aQ3: parseInt(ingestScores.awayQ3) || 0, aQ4: parseInt(ingestScores.awayQ4) || 0,
        lOT1: parseInt(ingestScores.localOT1) || 0, aOT1: parseInt(ingestScores.awayOT1) || 0,
        lOT2: parseInt(ingestScores.localOT2) || 0, aOT2: parseInt(ingestScores.awayOT2) || 0,
        lOT3: parseInt(ingestScores.localOT3) || 0, aOT3: parseInt(ingestScores.awayOT3) || 0
    };
}

function checkOT() {
    const s = getScores();
    const lReg = s.lQ1+s.lQ2+s.lQ3+s.lQ4, aReg = s.aQ1+s.aQ2+s.aQ3+s.aQ4;
    const filled = s.lQ1>0 && s.lQ2>0 && s.lQ3>0 && s.lQ4>0 && s.aQ1>0 && s.aQ2>0 && s.aQ3>0 && s.aQ4>0;
    const need1 = filled && lReg === aReg;
    const lA1 = lReg+s.lOT1, aA1 = aReg+s.aOT1;
    const need2 = need1 && s.lOT1>0 && s.aOT1>0 && lA1 === aA1;
    const lA2 = lA1+s.lOT2, aA2 = aA1+s.aOT2;
    const need3 = need2 && s.lOT2>0 && s.aOT2>0 && lA2 === aA2;
    return { needOT1: need1, needOT2: need2, needOT3: need3 };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    const app = document.getElementById('app');
    if (currentView === 'home') app.innerHTML = renderHome();
    else if (currentView === 'tendencia') app.innerHTML = renderTendencia();
    else if (currentView === 'ingesta') app.innerHTML = renderIngesta();
    else if (currentView === 'picks') app.innerHTML = renderPicks();
    else if (currentView === 'bestPicks') app.innerHTML = renderBestPicks();
    else if (currentView === 'dashboard') app.innerHTML = renderDashboard();
    attachEvents();
    
    // Inicializar grÃ¡ficos si estamos en dashboard
    if (currentView === 'dashboard') {
        setTimeout(() => initDashboardCharts(), 100);
    }
}

function renderHome() {
    const teams = getTeams();
    const top5 = [...teams].sort((a,b) => (TEAM_STATS[b]?.full||0) - (TEAM_STATS[a]?.full||0)).slice(0,5);
    const h2hC = Object.keys(H2H_DATABASE).length;
    const totalG = Object.values(H2H_DATABASE).reduce((s,a) => s + (Array.isArray(a) ? a.length : 0), 0);
    const picksStats = getPicksStats();
    
    let topH = top5.map((t,i) => `
        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3 mb-2">
            <span class="text-white font-semibold">${i+1}. ${t}</span>
            <div class="text-right">
                <span class="text-yellow-400 font-bold text-lg">${TEAM_STATS[t]?.full?.toFixed(1)}</span>
                <span class="text-gray-500 text-xs ml-2">(H:${TEAM_STATS[t]?.fullHome} / A:${TEAM_STATS[t]?.fullAway})</span>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <div class="rounded-lg p-3 mb-6 ${apiConnected ? 'bg-green-500/20 border border-green-500/30' : 'bg-yellow-500/20 border border-yellow-500/30'}">
                <div class="flex flex-col items-center text-center">
                    <span class="font-semibold text-sm ${apiConnected ? 'text-green-400' : 'text-yellow-400'}">
                        ${apiConnected ? 'ğŸ”„ Datos en TIEMPO REAL' : 'âš ï¸ Usando datos de respaldo'}
                    </span>
                    <span class="text-xs text-gray-400 mt-1">
                        Fuente: ${statsSource}
                        ${statsLastUpdated ? ' â€¢ Actualizado: ' + new Date(statsLastUpdated).toLocaleString('es-ES', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : ''}
                    </span>
                </div>
            </div>
            
            <!-- LOGO -->
            <div class="text-center mb-8">
                <div class="logo-container mb-4">
                    ${LOGO_SVG}
                    <div>
                        <h1 class="text-4xl md:text-5xl font-black text-white font-orbitron">NIOSPORTS</h1>
                        <h2 class="text-xl font-bold gradient-text font-orbitron">PRO v1.1</h2>
                    </div>
                </div>
                <p class="text-gray-400 text-sm">Tu herramienta profesional de anÃ¡lisis NBA con IA</p>
            </div>
            
            <!-- BOTONES PRINCIPALES -->
            <button onclick="navigateTo('tendencia')" class="w-full bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-2xl hover:scale-[1.02] transition mb-4">
                <div class="flex flex-col items-center">
                    <div class="text-5xl mb-3">ğŸ“ˆ</div>
                    <h3 class="text-xl font-bold text-white mb-1">Tendencia + H2H</h3>
                    <p class="text-yellow-200 text-xs mt-2">1Q â€¢ 1H â€¢ Full Game â€¢ IA Predictor</p>
                </div>
            </button>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="navigateTo('bestPicks')" class="bg-gradient-to-br from-yellow-500 to-orange-600 p-5 rounded-2xl shadow-2xl hover:scale-[1.02] transition">
                    <div class="text-3xl mb-2">ğŸ”¥</div>
                    <h3 class="text-lg font-bold text-white">Mejores Picks</h3>
                    <p class="text-yellow-100 text-xs">Algoritmo sugiere</p>
                </button>
                
                <button onclick="navigateTo('picks')" class="bg-gradient-to-br from-pink-500 to-rose-600 p-5 rounded-2xl shadow-2xl hover:scale-[1.02] transition">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <h3 class="text-lg font-bold text-white">Mis Picks</h3>
                    <p class="text-pink-100 text-xs">Historial completo</p>
                </button>
            </div>
            
            <!-- NUEVO: Dashboard de Rendimiento -->
            <button onclick="navigateTo('dashboard')" class="w-full bg-gradient-to-br from-cyan-500 to-blue-600 p-5 rounded-2xl shadow-2xl hover:scale-[1.02] transition mb-4 border-2 border-cyan-400/50">
                <div class="flex items-center justify-center gap-4">
                    <div class="text-4xl">ğŸ“‰</div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-white">Dashboard Pro</h3>
                        <p class="text-cyan-200 text-sm">GrÃ¡ficos â€¢ CLV â€¢ AnÃ¡lisis Avanzado</p>
                    </div>
                </div>
            </button>
            
            <button onclick="navigateTo('ingesta')" class="w-full bg-gradient-to-br from-purple-600 to-indigo-700 p-5 rounded-2xl shadow-2xl hover:scale-[1.02] transition mb-6 border-2 border-purple-400/50">
                <div class="flex items-center justify-center gap-4">
                    <div class="text-4xl">ğŸ“</div>
                    <div class="text-left">
                        <h3 class="text-xl font-bold text-white">Ingesta de Datos H2H</h3>
                        <p class="text-purple-200 text-sm">Agregar partidos manualmente</p>
                    </div>
                </div>
            </button>
            
            <!-- MI RÃ‰CORD PERSONAL - Movido abajo -->
            <div class="bg-gradient-to-br from-purple-600/30 to-pink-600/30 rounded-2xl p-5 mb-6 border border-purple-500/50">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-white">ğŸ† Mi RÃ©cord Personal</h3>
                    <button onclick="navigateTo('picks')" class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg">Ver todo</button>
                </div>
                
                <!-- Fila principal: Win Rate, Ganados, Perdidos, Pendientes -->
                <div class="grid grid-cols-4 gap-3 text-center">
                    <div class="bg-white/10 rounded-xl p-3">
                        <p class="text-3xl font-black ${parseFloat(picksStats.winRate) >= 55 ? 'text-green-400' : parseFloat(picksStats.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${picksStats.winRate}%</p>
                        <p class="text-gray-400 text-xs">Efectividad</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <p class="text-3xl font-black text-green-400">${picksStats.wins}</p>
                        <p class="text-gray-400 text-xs">Ganados</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <p class="text-3xl font-black text-red-400">${picksStats.losses}</p>
                        <p class="text-gray-400 text-xs">Perdidos</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <p class="text-3xl font-black text-yellow-400">${picksStats.pending}</p>
                        <p class="text-gray-400 text-xs">Pendientes</p>
                    </div>
                </div>
                
                <!-- Fila secundaria: Profit, ROI, Racha -->
                <div class="grid grid-cols-3 gap-3 text-center mt-3">
                    <div class="bg-black/20 rounded-xl p-3">
                        <p class="text-2xl font-black ${parseFloat(picksStats.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(picksStats.profit) > 0 ? '+' : ''}${picksStats.profit}</p>
                        <p class="text-gray-400 text-xs">${parseFloat(picksStats.profit) >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} Profit (u)</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-3">
                        <p class="text-2xl font-black ${parseFloat(picksStats.roi) >= 0 ? 'text-cyan-400' : 'text-red-400'}">${parseFloat(picksStats.roi) > 0 ? '+' : ''}${picksStats.roi}%</p>
                        <p class="text-gray-400 text-xs">ğŸ’° ROI</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-3">
                        ${picksStats.streak.count > 0 ? `
                            <p class="text-2xl font-black ${picksStats.streak.type === 'win' ? 'text-green-400' : 'text-red-400'}">${picksStats.streak.count}${picksStats.streak.type === 'win' ? 'W' : 'L'}</p>
                            <p class="text-gray-400 text-xs">${picksStats.streak.type === 'win' ? 'ğŸ”¥' : 'â„ï¸'} Racha</p>
                        ` : `
                            <p class="text-2xl font-black text-gray-500">-</p>
                            <p class="text-gray-400 text-xs">ğŸ¯ Racha</p>
                        `}
                    </div>
                </div>
                
                <!-- Desglose por perÃ­odo -->
                ${picksStats.total > 0 ? `
                <div class="mt-4 pt-3 border-t border-white/10">
                    <p class="text-xs text-gray-500 mb-2 text-center">ğŸ“Š Por PerÃ­odo</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-yellow-500/10 rounded-lg p-2 text-center">
                            <p class="text-yellow-400 font-bold text-sm">1Q</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['1Q'].wins}W-${picksStats.byPeriod['1Q'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['1Q'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['1Q'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['1Q'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-pink-500/10 rounded-lg p-2 text-center">
                            <p class="text-pink-400 font-bold text-sm">1H</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['1H'].wins}W-${picksStats.byPeriod['1H'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['1H'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['1H'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['1H'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-green-500/10 rounded-lg p-2 text-center">
                            <p class="text-green-400 font-bold text-sm">FULL</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['FULL'].wins}W-${picksStats.byPeriod['FULL'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['FULL'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['FULL'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['FULL'].profit.toFixed(2)}u</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="glass rounded-xl p-4 mb-6">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ“Š Base de Datos H2H <span class="text-green-400 text-sm">(Firebase)</span></h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                        <p class="text-3xl font-black text-purple-400">${h2hC}</p>
                        <p class="text-gray-400 text-sm">Matchups</p>
                    </div>
                    <div class="bg-green-500/20 rounded-lg p-3 text-center">
                        <p class="text-3xl font-black text-green-400">${totalG}</p>
                        <p class="text-gray-400 text-sm">Partidos</p>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-4">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ”¥ Top 5 Equipos PPG 2024-25</h3>
                ${topH}
            </div>
        </div>
    `;
}

function renderTendencia() {
    const teams = getTeams();
    const lD = localTeam ? TEAM_STATS[localTeam] : null;
    const vD = visitingTeam ? TEAM_STATS[visitingTeam] : null;
    let trends = { q1: '-', half: '-', full: '-' };
    if (lD && vD) {
        trends = {
            q1: (lD.q1Home + vD.q1Away).toFixed(1),
            half: (lD.halfHome + vD.halfAway).toFixed(1),
            full: (lD.fullHome + vD.fullAway).toFixed(1)
        };
    }
    const pQ1 = calcProb(trends.q1, lineQ1, typeQ1);
    const pHalf = calcProb(trends.half, lineHalf, typeHalf);
    const pFull = calcProb(trends.full, lineFull, typeFull);
    
    let opts = '<option value="">Seleccionar...</option>';
    teams.forEach(t => { opts += `<option value="${t}">${t}</option>`; });
    
    let html = `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">TENDENCIA + H2H</h1>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gradient-to-br from-cyan-600 to-blue-700 p-4 rounded-xl">
                    <h2 class="text-lg font-bold text-white mb-2 text-center">ğŸ  LOCAL</h2>
                    <select id="localSelect" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">
                        ${opts.replace(`value="${localTeam}"`, `value="${localTeam}" selected`)}
                    </select>
                    ${lD ? `
                        <div class="mt-3 bg-black/30 rounded-lg p-3">
                            <div class="text-cyan-200 text-sm text-center mb-2 font-semibold">ğŸ“Š Temporada 2024-25</div>
                            <div class="text-white text-sm text-center font-medium">1Q: ${lD.q1} | 1H: ${lD.half} | Full: ${lD.full}</div>
                            <div class="text-yellow-300 text-sm text-center mt-2 font-bold">ğŸ  HOME: 1Q: ${lD.q1Home} | 1H: ${lD.halfHome} | Full: ${lD.fullHome}</div>
                        </div>
                        <label class="flex items-center gap-2 mt-2 bg-red-500/20 rounded-lg p-2 cursor-pointer hover:bg-red-500/30 border border-red-500/30">
                            <input type="checkbox" id="b2b_local" onchange="toggleB2B('local')" ${b2bLocal ? 'checked' : ''} class="w-4 h-4 accent-red-500">
                            <span class="text-red-300 text-xs font-semibold">âš ï¸ Back-to-Back (jugÃ³ ayer)</span>
                        </label>
                    ` : ''}
                </div>
                <div class="bg-gradient-to-br from-orange-600 to-red-700 p-4 rounded-xl">
                    <h2 class="text-lg font-bold text-white mb-2 text-center">âœˆï¸ VISITANTE</h2>
                    <select id="visitingSelect" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">
                        ${opts.replace(`value="${visitingTeam}"`, `value="${visitingTeam}" selected`)}
                    </select>
                    ${vD ? `
                        <div class="mt-3 bg-black/30 rounded-lg p-3">
                            <div class="text-orange-200 text-sm text-center mb-2 font-semibold">ğŸ“Š Temporada 2024-25</div>
                            <div class="text-white text-sm text-center font-medium">1Q: ${vD.q1} | 1H: ${vD.half} | Full: ${vD.full}</div>
                            <div class="text-yellow-300 text-sm text-center mt-2 font-bold">âœˆï¸ AWAY: 1Q: ${vD.q1Away} | 1H: ${vD.halfAway} | Full: ${vD.fullAway}</div>
                        </div>
                        <label class="flex items-center gap-2 mt-2 bg-red-500/20 rounded-lg p-2 cursor-pointer hover:bg-red-500/30 border border-red-500/30">
                            <input type="checkbox" id="b2b_visiting" onchange="toggleB2B('visiting')" ${b2bVisiting ? 'checked' : ''} class="w-4 h-4 accent-red-500">
                            <span class="text-red-300 text-xs font-semibold">âš ï¸ Back-to-Back (jugÃ³ ayer)</span>
                        </label>
                    ` : ''}
                </div>
            </div>
            
            <!-- ALERTA B2B -->
            ${(b2bLocal || b2bVisiting) ? `
                <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mb-4">
                    <p class="text-red-400 text-sm font-semibold text-center">
                        âš ï¸ <strong>ALERTA B2B:</strong> 
                        ${b2bLocal && b2bVisiting ? `Ambos equipos en Back-to-Back` : 
                          b2bLocal ? `${localTeam} estÃ¡ en Back-to-Back (-5% rendimiento esperado)` :
                          `${visitingTeam} estÃ¡ en Back-to-Back (-5% rendimiento esperado)`}
                    </p>
                    <p class="text-red-300 text-xs text-center mt-1">Los equipos en B2B suelen rendir ~5% menos, especialmente en 2da mitad</p>
                </div>
            ` : ''}
    `;
    
    if (localTeam && visitingTeam) {
        html += `
            <div class="bg-white rounded-2xl p-5 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2 text-center">ğŸ“ˆ TENDENCIA TEMPORADA 2024-25</h2>
                <p class="text-center text-gray-500 text-sm mb-4">${localTeam} (HOME) + ${visitingTeam} (AWAY)</p>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-4 text-center">
                        <p class="text-sm font-bold text-white/90">1Q</p>
                        <p class="text-4xl font-black text-white">${trends.q1}</p>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-purple-600 rounded-xl p-4 text-center">
                        <p class="text-sm font-bold text-white/90">1H</p>
                        <p class="text-4xl font-black text-white">${trends.half}</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 text-center">
                        <p class="text-sm font-bold text-white/90">FULL</p>
                        <p class="text-4xl font-black text-white">${trends.full}</p>
                    </div>
                </div>
            </div>
            ${renderH2HSection()}
            <div class="bg-gradient-to-br from-purple-700 to-indigo-800 rounded-2xl p-5 shadow-xl mt-6">
                <h2 class="text-xl font-bold text-white mb-4 text-center">ğŸ¯ CALCULADORA PRO - Expected Value</h2>
                <div class="grid grid-cols-3 gap-4">
                    ${renderCalc('Q1', '1Q', trends.q1, pQ1, typeQ1, lineQ1, oddsQ1)}
                    ${renderCalc('Half', '1H', trends.half, pHalf, typeHalf, lineHalf, oddsHalf)}
                    ${renderCalc('Full', 'FULL', trends.full, pFull, typeFull, lineFull, oddsFull)}
                </div>
                
                <!-- Leyenda EV -->
                <div class="mt-4 bg-white/10 rounded-xl p-4">
                    <details class="text-white">
                        <summary class="font-bold cursor-pointer text-sm">ğŸ“– Â¿CÃ³mo interpretar? (clic para expandir)</summary>
                        <div class="mt-3 text-xs space-y-2 text-gray-300">
                            <p><strong class="text-white">ğŸ“Š Prob. Ganar:</strong> Probabilidad estadÃ­stica de que el pick gane</p>
                            <p><strong class="text-white">ğŸ’° Cuota Justa:</strong> La cuota mÃ­nima que deberÃ­as aceptar. Si la casa ofrece mÃ¡s = valor</p>
                            <p><strong class="text-white">ğŸ“ˆ Expected Value (EV):</strong> Ganancia esperada por cada $100 apostados. EV +5% = ganas $5 por cada $100 a largo plazo</p>
                            <p><strong class="text-white">âš¡ Edge:</strong> Tu ventaja sobre la casa. Edge +10% = 10% mÃ¡s probabilidad de lo que la casa cree</p>
                            <div class="mt-2 pt-2 border-t border-white/20">
                                <p class="text-yellow-300 font-bold">ğŸ¯ REGLA DE ORO:</p>
                                <p>â€¢ EV â‰¥ +3% = âœ… APOSTAR</p>
                                <p>â€¢ EV â‰¥ +7% = ğŸ’ ALTO VALOR</p>
                                <p>â€¢ EV â‰¥ +15% = ğŸ”¥ ELITE (raro)</p>
                                <p>â€¢ EV < 0% = âŒ NO APOSTAR</p>
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- ExplicaciÃ³n del Modelo EstadÃ­stico -->
                <div class="mt-3 bg-indigo-900/50 rounded-xl p-4">
                    <details class="text-white">
                        <summary class="font-bold cursor-pointer text-sm">ğŸ”¬ Modelo EstadÃ­stico (clic para ver)</summary>
                        <div class="mt-3 text-xs space-y-2 text-gray-300">
                            <p class="text-cyan-300 font-bold">ğŸ“š Basado en: Gabel & Redner (2012) - "Random Walk Picture of Basketball Scoring"</p>
                            <p>El scoring NBA sigue un <strong class="text-white">random walk</strong> donde la varianza escala con âˆšt (raÃ­z cuadrada del tiempo).</p>
                            
                            <div class="mt-2 bg-black/30 rounded-lg p-3">
                                <p class="text-yellow-300 font-bold mb-2">ğŸ“Š DesviaciÃ³n EstÃ¡ndar por PerÃ­odo:</p>
                                <p>â€¢ <strong class="text-orange-400">1Q:</strong> Â±8 puntos de variaciÃ³n tÃ­pica</p>
                                <p>â€¢ <strong class="text-pink-400">1H:</strong> Â±13 puntos de variaciÃ³n tÃ­pica</p>
                                <p>â€¢ <strong class="text-green-400">FULL:</strong> Â±18.5 puntos de variaciÃ³n tÃ­pica</p>
                            </div>
                            
                            <div class="mt-2 pt-2 border-t border-white/20">
                                <p class="text-lime-300 font-bold">ğŸ’¡ Â¿Por quÃ© 1H puede tener mayor % que FULL?</p>
                                <p>La probabilidad depende de la <strong class="text-white">diferencia RELATIVA</strong> a la variabilidad, no solo de la diferencia absoluta.</p>
                                <p class="mt-1">Ejemplo: +20 pts sobre lÃ­nea con SD=13 (1H) es Z=1.54 â†’ 93%</p>
                                <p>Ejemplo: +22 pts sobre lÃ­nea con SD=18.5 (Full) es Z=1.19 â†’ 88%</p>
                                <p class="mt-1 text-yellow-300">Aunque Full tiene mÃ¡s puntos de "colchÃ³n", la variabilidad es proporcionalmente mayor.</p>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            
            <!-- BET BUILDER - PICKS COMBINADOS -->
            ${(() => {
                const hasQ1 = lineQ1 && pQ1;
                const hasHalf = lineHalf && pHalf;
                const hasFull = lineFull && pFull;
                const validPicks = [hasQ1, hasHalf, hasFull].filter(Boolean).length;
                
                if (validPicks >= 2) {
                    return `
                    <div class="mt-6 bg-gradient-to-br from-amber-600 to-orange-700 rounded-2xl p-5">
                        <h3 class="text-lg font-bold text-white mb-4 text-center">ğŸ”¥ BET BUILDER - Combo</h3>
                        <p class="text-white/70 text-xs text-center mb-4">Selecciona los picks para tu combinada</p>
                        
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${hasQ1 ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_q1" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">1Q ${typeQ1}</div>
                                        <div class="text-xs opacity-80">${lineQ1} (${pQ1}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                            ${hasHalf ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_half" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">1H ${typeHalf}</div>
                                        <div class="text-xs opacity-80">${lineHalf} (${pHalf}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                            ${hasFull ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_full" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">FULL ${typeFull}</div>
                                        <div class="text-xs opacity-80">${lineFull} (${pFull}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                        </div>
                        
                        <div class="bg-black/20 rounded-xl p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white/80 text-sm">Cuota Combinada:</span>
                                <input type="number" step="0.01" id="combo_odds" placeholder="ej: 2.05" 
                                    class="w-24 p-2 rounded-lg text-center font-bold bg-white text-gray-800">
                            </div>
                            <p class="text-white/60 text-xs">Ingresa la cuota total del Bet Builder de tu casa de apuestas</p>
                        </div>
                        
                        <button onclick="registerBetBuilder()" 
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg transition-all">
                            ğŸ¯ Registrar Bet Builder
                        </button>
                    </div>
                    `;
                }
                return '';
            })()}
            
            <!-- BOTÃ“N REGISTRAR PICK INDIVIDUAL -->
            <div class="mt-6 bg-gradient-to-br from-pink-600 to-rose-700 rounded-2xl p-5">
                <h3 class="text-lg font-bold text-white mb-4 text-center">ğŸ“ Registrar Pick</h3>
                <div class="grid grid-cols-3 gap-3">
                    ${lineQ1 && pQ1 ? (() => {
                        const evQ1 = oddsQ1 ? calcEV(pQ1, oddsQ1) : null;
                        const verdictQ1 = evVerdict(evQ1, pQ1, null);
                        return `
                        <button onclick="registerPick('1Q', '${typeQ1}', '${lineQ1}', ${pQ1}, '${oddsQ1 || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evQ1 && parseFloat(evQ1) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">1Q ${typeQ1}</div>
                            <div class="text-xs">${lineQ1} (${pQ1}%)</div>
                            ${evQ1 ? `<div class="text-xs mt-1 ${parseFloat(evQ1) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evQ1) >= 0 ? '+' : ''}${evQ1}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                    ${lineHalf && pHalf ? (() => {
                        const evHalf = oddsHalf ? calcEV(pHalf, oddsHalf) : null;
                        const verdictHalf = evVerdict(evHalf, pHalf, null);
                        return `
                        <button onclick="registerPick('1H', '${typeHalf}', '${lineHalf}', ${pHalf}, '${oddsHalf || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evHalf && parseFloat(evHalf) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">1H ${typeHalf}</div>
                            <div class="text-xs">${lineHalf} (${pHalf}%)</div>
                            ${evHalf ? `<div class="text-xs mt-1 ${parseFloat(evHalf) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evHalf) >= 0 ? '+' : ''}${evHalf}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                    ${lineFull && pFull ? (() => {
                        const evFull = oddsFull ? calcEV(pFull, oddsFull) : null;
                        const verdictFull = evVerdict(evFull, pFull, null);
                        return `
                        <button onclick="registerPick('FULL', '${typeFull}', '${lineFull}', ${pFull}, '${oddsFull || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evFull && parseFloat(evFull) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">FULL ${typeFull}</div>
                            <div class="text-xs">${lineFull} (${pFull}%)</div>
                            ${evFull ? `<div class="text-xs mt-1 ${parseFloat(evFull) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evFull) >= 0 ? '+' : ''}${evFull}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                </div>
            </div>
        `;
    } else {
        html += `<div class="glass rounded-xl p-10 text-center"><p class="text-white font-bold text-xl">ğŸ‘† Selecciona dos equipos</p></div>`;
    }
    
    html += '</div>';
    return html;
}

function renderH2HSection() {
    const h2h = getH2HData(localTeam, visitingTeam);
    if (!h2h) {
        return `
            <div class="h2h-card rounded-2xl p-5 shadow-2xl mt-6 border border-yellow-500/30">
                <div class="text-center py-6">
                    <div class="text-5xl mb-4">ğŸ“</div>
                    <p class="text-yellow-400 font-bold">No hay datos H2H para ${localTeam} vs ${visitingTeam}</p>
                    <button onclick="goToIngestWithTeams()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">â• Agregar Partidos</button>
                </div>
            </div>
        `;
    }
    
    const t1W = h2h.record.team1Wins, t2W = h2h.record.team2Wins;
    let gh = h2h.games.map((g,i) => `
        <div class="grid grid-cols-5 gap-2 text-sm py-2 ${i%2===0?'bg-white/5':''} rounded">
            <span class="text-gray-300 text-xs">${g.date}${g.overtimes>0?` <span class="text-yellow-400">(${g.overtimes}OT)</span>`:''}</span>
            <span class="text-center text-yellow-400 font-bold">${g.t1Q1+g.t2Q1}</span>
            <span class="text-center text-pink-400 font-bold">${g.t1Half+g.t2Half}</span>
            <span class="text-center text-green-400 font-bold">${g.totalPts}</span>
            <span class="text-center font-bold ${g.winner===localTeam?'text-cyan-400':'text-orange-400'}">${g.winner}</span>
        </div>
    `).join('');
    
    return `
        <div class="h2h-card rounded-2xl p-5 shadow-2xl slide-in border border-purple-500/30 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">âš”ï¸ H2H - Ãšltimos ${h2h.games.length} Partidos</h2>
                <span class="text-xs px-3 py-1 rounded bg-green-500/20 text-green-300">â˜ï¸ Firebase</span>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-white/10 rounded-xl p-4 text-center ${t1W>t2W?'border-2 border-green-500/50':''}">
                    <p class="text-white font-bold text-sm">${localTeam}</p>
                    <p class="text-4xl font-black ${t1W>t2W?'text-green-400':'text-white'}">${t1W}</p>
                </div>
                <div class="bg-white/5 rounded-xl p-4 text-center flex flex-col justify-center">
                    <p class="text-yellow-400 font-bold">VS</p>
                    <p class="text-gray-300">${t1W}-${t2W}</p>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center ${t2W>t1W?'border-2 border-green-500/50':''}">
                    <p class="text-white font-bold text-sm">${visitingTeam}</p>
                    <p class="text-4xl font-black ${t2W>t1W?'text-green-400':'text-white'}">${t2W}</p>
                </div>
            </div>
            
            <div class="bg-purple-900/50 rounded-xl p-4 mb-5">
                <h3 class="text-white font-bold text-center mb-3">ğŸ“Š PROMEDIOS H2H</h3>
                <div class="grid grid-cols-3 gap-2 text-center text-sm">
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">1er Cuarto</p>
                        <p class="text-yellow-400 font-bold">${(h2h.avgQ1.team1+h2h.avgQ1.team2).toFixed(1)}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">1er Tiempo</p>
                        <p class="text-pink-400 font-bold">${(h2h.avgHalf.team1+h2h.avgHalf.team2).toFixed(1)}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">Full Game</p>
                        <p class="text-green-400 font-bold">${(h2h.avgPts.team1+h2h.avgPts.team2).toFixed(1)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center mt-3">
                    <p class="text-cyan-400 font-bold">${localTeam}: ${h2h.avgPts.team1.toFixed(1)} PPG</p>
                    <p class="text-orange-400 font-bold">${visitingTeam}: ${h2h.avgPts.team2.toFixed(1)} PPG</p>
                </div>
            </div>
            
            <div class="bg-black/30 rounded-xl p-4">
                <h3 class="text-white font-bold text-sm mb-3">ğŸ“‹ HISTORIAL</h3>
                <div class="space-y-1 max-h-64 overflow-y-auto">
                    <div class="grid grid-cols-5 gap-2 text-xs text-gray-500 font-bold pb-2 border-b border-white/10">
                        <span>FECHA</span><span class="text-center">1Q</span><span class="text-center">1H</span><span class="text-center">FULL</span><span class="text-center">GANÃ“</span>
                    </div>
                    ${gh}
                </div>
            </div>
            
            <button onclick="goToIngestWithTeams()" class="w-full mt-4 bg-purple-600/50 hover:bg-purple-600 text-white py-2 rounded-lg text-sm">â• Agregar mÃ¡s partidos</button>
        </div>
    `;
}

function renderCalc(id, label, trend, prob, type, line, odds) {
    const analysis = analyzebet(trend, line, type, odds);
    const verdict = analysis ? evVerdict(analysis.ev, analysis.prob, analysis.edge) : evVerdict(null, prob, null);
    const stake = analysis && analysis.kelly ? stakeRec(analysis.kelly) : null;
    
    let resultsHtml = '';
    if (analysis && analysis.prob) {
        const hasOdds = odds && parseFloat(odds) > 1;
        const diffNum = parseFloat(analysis.diff);
        const zNum = parseFloat(analysis.zScore);
        
        resultsHtml = `
            <div class="mt-3 space-y-2">
                <!-- MÃ©tricas de Transparencia -->
                <div class="bg-indigo-50 rounded-lg px-3 py-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-indigo-600">Diferencia</span>
                        <span class="font-bold ${diffNum >= 0 ? 'text-green-600' : 'text-red-600'}">${diffNum >= 0 ? '+' : ''}${analysis.diff} pts</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <span class="text-indigo-600">SD (Â±variaciÃ³n)</span>
                        <span class="font-bold text-indigo-700">Â±${analysis.std} pts</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <span class="text-indigo-600">Z-Score</span>
                        <span class="font-bold ${zNum >= 1.5 ? 'text-green-600' : zNum >= 0.5 ? 'text-yellow-600' : 'text-red-600'}">${zNum >= 0 ? '+' : ''}${analysis.zScore}</span>
                    </div>
                </div>
                
                <!-- Probabilidad -->
                <div class="flex justify-between items-center bg-gray-100 rounded-lg px-3 py-2">
                    <span class="text-xs text-gray-600">Prob. Ganar</span>
                    <span class="font-black text-lg ${analysis.prob >= 55 ? 'text-green-600' : analysis.prob >= 45 ? 'text-yellow-600' : 'text-red-600'}">${analysis.prob}%</span>
                </div>
                
                <!-- Cuota Justa -->
                <div class="flex justify-between items-center bg-gray-50 rounded-lg px-3 py-1">
                    <span class="text-xs text-gray-500">Cuota Justa</span>
                    <span class="font-bold text-sm text-gray-700">${analysis.fairOdds}</span>
                </div>
                
                ${hasOdds ? `
                    <!-- EV% -->
                    <div class="flex justify-between items-center ${parseFloat(analysis.ev) >= 0 ? 'bg-green-100' : 'bg-red-100'} rounded-lg px-3 py-2">
                        <span class="text-xs ${parseFloat(analysis.ev) >= 0 ? 'text-green-700' : 'text-red-700'}">Expected Value</span>
                        <span class="font-black text-lg ${parseFloat(analysis.ev) >= 0 ? 'text-green-600' : 'text-red-600'}">${parseFloat(analysis.ev) >= 0 ? '+' : ''}${analysis.ev}%</span>
                    </div>
                    
                    <!-- Edge -->
                    <div class="flex justify-between items-center bg-gray-50 rounded-lg px-3 py-1">
                        <span class="text-xs text-gray-500">Edge vs Casa</span>
                        <span class="font-bold text-sm ${parseFloat(analysis.edge) >= 0 ? 'text-green-600' : 'text-red-600'}">${parseFloat(analysis.edge) >= 0 ? '+' : ''}${analysis.edge}%</span>
                    </div>
                    
                    <!-- Indicador ML -->
                    ${ML_MODEL.getConfidence() > 0 ? `
                    <div class="flex justify-between items-center bg-emerald-50 rounded-lg px-3 py-1 border border-emerald-200">
                        <span class="text-xs text-emerald-700">ğŸ¤– IA Ajuste</span>
                        <span class="font-bold text-xs text-emerald-600">${ML_MODEL.getConfidence()}% confianza</span>
                    </div>
                    ` : ''}
                ` : `
                    <div class="bg-blue-50 rounded-lg px-3 py-2 text-center">
                        <span class="text-xs text-blue-600">â¬‡ï¸ Ingresa la cuota para ver EV</span>
                    </div>
                `}
                
                <!-- Veredicto -->
                <div class="${evColor(hasOdds ? analysis.ev : null, analysis.prob)} rounded-xl p-3 text-center shadow-lg">
                    <p class="text-2xl">${verdict.icon}</p>
                    <p class="text-white font-black text-sm">${verdict.text}</p>
                    ${verdict.stars ? `<p class="text-yellow-300 text-xs">${verdict.stars}</p>` : ''}
                </div>
                
                ${hasOdds && stake ? `
                    <div class="text-center">
                        <span class="text-xs ${stake.class}">ğŸ’° ${stake.text}</span>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    return `
        <div class="bg-white rounded-xl p-3 shadow-lg">
            <p class="text-sm font-black text-center text-gray-800 mb-1">${label}: <span class="text-purple-600">${trend}</span></p>
            
            <!-- Selector Over/Under -->
            <div class="flex gap-1 my-2">
                <button onclick="setType('${id}','OVER')" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all ${type==='OVER'?'bg-green-600 text-white shadow-md':'bg-gray-200 hover:bg-gray-300'}">OVER</button>
                <button onclick="setType('${id}','UNDER')" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all ${type==='UNDER'?'bg-red-600 text-white shadow-md':'bg-gray-200 hover:bg-gray-300'}">UNDER</button>
            </div>
            
            <!-- Input LÃ­nea -->
            <div class="mb-2">
                <label class="text-xs text-gray-500 block mb-1">ğŸ“ LÃ­nea</label>
                <input type="number" step="0.5" value="${line}" placeholder="ej: ${label === '1Q' ? '53.5' : label === '1H' ? '104.5' : '221.5'}" 
                    class="w-full p-2 border-2 border-gray-200 rounded-lg text-center text-sm font-bold focus:border-purple-500 focus:outline-none" 
                    onchange="updateLine('${id}',this.value)">
            </div>
            
            <!-- Input Cuota -->
            <div class="mb-2">
                <label class="text-xs text-gray-500 block mb-1">ğŸ’° Cuota (decimal)</label>
                <input type="number" step="0.01" value="${odds || ''}" placeholder="ej: 1.85" 
                    class="w-full p-2 border-2 border-amber-200 rounded-lg text-center text-sm font-bold bg-amber-50 focus:border-amber-500 focus:outline-none" 
                    onchange="updateOdds('${id}',this.value)">
            </div>
            
            ${resultsHtml}
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPicks() {
    const stats = getPicksStats();
    const picks = Object.values(PICKS_DATABASE).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // Stats por tipo
    let typeStatsHtml = '';
    Object.entries(stats.byType).forEach(([key, data]) => {
        const [period, betType] = key.split('_');
        const winRate = data.wins + data.losses > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(0) : 0;
        typeStatsHtml += `
            <div class="bg-white/5 rounded-lg p-2 text-center">
                <p class="text-xs text-gray-300 font-semibold">${period} ${betType}</p>
                <p class="text-lg font-bold ${winRate >= 55 ? 'text-green-400' : winRate >= 45 ? 'text-yellow-400' : 'text-red-400'}">${winRate}%</p>
                <p class="text-xs text-gray-400 font-medium">${data.wins}W-${data.losses}L</p>
            </div>
        `;
    });
    
    // Picks list
    let picksHtml = picks.length === 0 ? '<p class="text-center text-gray-400 py-10">No hay picks registrados aÃºn</p>' : '';
    picks.forEach(pick => {
        const statusClass = pick.status === 'win' ? 'win-badge' : pick.status === 'loss' ? 'loss-badge' : 'pending-badge';
        const statusIcon = pick.status === 'win' ? 'âœ…' : pick.status === 'loss' ? 'âŒ' : 'â³';
        const date = new Date(pick.createdAt).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        
        // Calcular CLV si tenemos lÃ­nea de cierre
        let clvDisplay = '';
        if (pick.closingLine && pick.line && !pick.isCombo) {
            const clv = pick.betType === 'OVER' 
                ? (parseFloat(pick.closingLine) - parseFloat(pick.line)).toFixed(1)
                : (parseFloat(pick.line) - parseFloat(pick.closingLine)).toFixed(1);
            const clvClass = parseFloat(clv) >= 0 ? 'text-green-400' : 'text-red-400';
            clvDisplay = `<span class="font-semibold ${clvClass}">CLV: ${parseFloat(clv) >= 0 ? '+' : ''}${clv}</span>`;
        }
        
        picksHtml += `
            <div class="pick-card bg-white/5 rounded-xl p-4 mb-3 border ${pick.isCombo ? 'border-amber-500/50' : 'border-white/10'}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        ${pick.isCombo ? '<span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full mb-1 inline-block font-bold">ğŸ”¥ BET BUILDER</span>' : ''}
                        <p class="text-white font-bold">${pick.localTeam} vs ${pick.awayTeam}</p>
                        <p class="text-gray-200 text-sm font-semibold">${pick.isCombo ? pick.line : `${pick.period} ${pick.betType} ${pick.line}`}</p>
                    </div>
                    <span class="${statusClass} px-3 py-1 rounded-full text-white text-sm font-bold">${statusIcon}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <div class="flex flex-wrap gap-3 font-medium">
                        <span class="text-gray-300 font-medium">${date}</span>
                        ${pick.odds ? `<span class="text-yellow-300 font-semibold">@${pick.odds}</span>` : ''}
                        <span class="text-purple-300 font-semibold">${pick.probability}% prob</span>
                        ${pick.ev ? `<span class="font-semibold ${parseFloat(pick.ev) >= 0 ? 'text-green-400' : 'text-red-400'}">EV: ${parseFloat(pick.ev) >= 0 ? '+' : ''}${pick.ev}%</span>` : ''}
                        ${clvDisplay}
                    </div>
                    <div class="flex gap-2 items-center">
                        ${pick.status === 'pending' ? `
                            <button onclick="updatePickResult('${pick.id}', 'win')" class="text-green-400 hover:text-green-300 text-lg">âœ“</button>
                            <button onclick="updatePickResult('${pick.id}', 'loss')" class="text-red-400 hover:text-red-300 text-lg">âœ—</button>
                        ` : ''}
                        ${!pick.isCombo && !pick.closingLine ? `<button onclick="addClosingLine('${pick.id}', '${pick.line}')" class="text-cyan-400 hover:text-cyan-300 text-xs bg-cyan-500/20 px-2 py-1 rounded" title="Agregar lÃ­nea de cierre">+CLV</button>` : ''}
                        <button onclick="deletePick('${pick.id}')" class="text-gray-500 hover:text-red-400 text-lg">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">MIS PICKS</h1>
                </div>
            </div>
            
            <!-- RESUMEN PRINCIPAL -->
            <div class="bg-gradient-to-br from-purple-600/30 to-pink-600/30 rounded-2xl p-5 mb-6 border border-purple-500/50">
                <!-- Fila 1: Efectividad, Ganados, Perdidos -->
                <div class="grid grid-cols-3 gap-3 text-center mb-4">
                    <div class="bg-white/10 rounded-xl p-4">
                        <p class="text-5xl font-black ${parseFloat(stats.winRate) >= 55 ? 'text-green-400' : parseFloat(stats.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${stats.winRate}%</p>
                        <p class="text-gray-300 text-sm font-semibold">Efectividad</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4">
                        <p class="text-5xl font-black text-green-400">${stats.wins}<span class="text-lg text-gray-400">/${stats.wins + stats.losses}</span></p>
                        <p class="text-gray-300 text-sm font-semibold">Ganados</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4">
                        <p class="text-5xl font-black text-red-400">${stats.losses}<span class="text-lg text-gray-400">/${stats.wins + stats.losses}</span></p>
                        <p class="text-gray-300 text-sm font-semibold">Perdidos</p>
                    </div>
                </div>
                
                <!-- Fila 2: Profit, ROI, Racha, Pendientes -->
                <div class="grid grid-cols-4 gap-3 text-center mb-4">
                    <div class="bg-black/20 rounded-xl p-3">
                        <p class="text-2xl font-black ${parseFloat(stats.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(stats.profit) > 0 ? '+' : ''}${stats.profit}u</p>
                        <p class="text-gray-300 text-xs font-semibold">${parseFloat(stats.profit) >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} Profit</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-3">
                        <p class="text-2xl font-black ${parseFloat(stats.roi) >= 0 ? 'text-cyan-400' : 'text-red-400'}">${parseFloat(stats.roi) > 0 ? '+' : ''}${stats.roi}%</p>
                        <p class="text-gray-300 text-xs font-semibold">ğŸ’° ROI</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-3">
                        ${stats.streak.count > 0 ? `
                            <p class="text-2xl font-black ${stats.streak.type === 'win' ? 'text-green-400' : 'text-red-400'}">${stats.streak.count}${stats.streak.type === 'win' ? 'W' : 'L'}</p>
                            <p class="text-gray-300 text-xs font-semibold">${stats.streak.type === 'win' ? 'ğŸ”¥' : 'â„ï¸'} Racha Actual</p>
                        ` : `
                            <p class="text-2xl font-black text-gray-500">-</p>
                            <p class="text-gray-300 text-xs font-semibold">ğŸ¯ Racha</p>
                        `}
                    </div>
                    <div class="bg-black/20 rounded-xl p-3">
                        <p class="text-2xl font-black text-yellow-400">${stats.pending}</p>
                        <p class="text-gray-300 text-xs font-semibold">â³ Pendientes</p>
                    </div>
                </div>
                
                <!-- Rachas histÃ³ricas -->
                ${stats.bestWinStreak > 0 || stats.worstLossStreak > 0 ? `
                <div class="grid grid-cols-2 gap-3 text-center mb-4">
                    <div class="bg-green-500/10 rounded-lg p-2 border border-green-500/20">
                        <span class="text-green-400 text-sm font-semibold">ğŸ† Mejor racha: <strong>${stats.bestWinStreak}W</strong></span>
                    </div>
                    <div class="bg-red-500/10 rounded-lg p-2 border border-red-500/20">
                        <span class="text-red-400 text-sm font-semibold">ğŸ’€ Peor racha: <strong>${stats.worstLossStreak}L</strong></span>
                    </div>
                </div>
                ` : ''}
                
                <!-- Desglose por perÃ­odo -->
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-sm font-bold text-gray-300 mb-3">ğŸ“Š Rendimiento por PerÃ­odo</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-yellow-500/10 rounded-xl p-3 text-center border border-yellow-500/20">
                            <p class="text-yellow-400 font-bold text-lg">1Q</p>
                            <p class="text-white font-bold">${stats.byPeriod['1Q'].wins}W - ${stats.byPeriod['1Q'].losses}L</p>
                            <p class="text-sm font-semibold ${stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses > 0 ? (stats.byPeriod['1Q'].wins / (stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses > 0 ? ((stats.byPeriod['1Q'].wins / (stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['1Q'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['1Q'].profit >= 0 ? '+' : ''}${stats.byPeriod['1Q'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-pink-500/10 rounded-xl p-3 text-center border border-pink-500/20">
                            <p class="text-pink-400 font-bold text-lg">1H</p>
                            <p class="text-white font-bold">${stats.byPeriod['1H'].wins}W - ${stats.byPeriod['1H'].losses}L</p>
                            <p class="text-sm font-semibold ${stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses > 0 ? (stats.byPeriod['1H'].wins / (stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses > 0 ? ((stats.byPeriod['1H'].wins / (stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['1H'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['1H'].profit >= 0 ? '+' : ''}${stats.byPeriod['1H'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-green-500/10 rounded-xl p-3 text-center border border-green-500/20">
                            <p class="text-green-400 font-bold text-lg">FULL</p>
                            <p class="text-white font-bold">${stats.byPeriod['FULL'].wins}W - ${stats.byPeriod['FULL'].losses}L</p>
                            <p class="text-sm font-semibold ${stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses > 0 ? (stats.byPeriod['FULL'].wins / (stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses > 0 ? ((stats.byPeriod['FULL'].wins / (stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['FULL'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['FULL'].profit >= 0 ? '+' : ''}${stats.byPeriod['FULL'].profit.toFixed(2)}u</p>
                        </div>
                    </div>
                </div>
                
                ${typeStatsHtml ? `
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-300 mb-3">ğŸ¯ Por Tipo (Over/Under)</h4>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                        ${typeStatsHtml}
                    </div>
                </div>
                ` : ''}
            </div>
            
            <!-- LISTA DE PICKS -->
            <div class="glass rounded-xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white">ğŸ“‹ Historial de Picks</h3>
                    <span class="text-sm text-gray-400">${stats.total} total</span>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    ${picksHtml}
                </div>
            </div>
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEST PICKS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBestPicks() {
    const bestPicks = getBestPicks();
    
    let picksHtml = bestPicks.length === 0 ? '<p class="text-center text-gray-400 py-10">No hay picks sugeridos en este momento</p>' : '';
    
    bestPicks.forEach((pick, index) => {
        picksHtml += `
            <div class="best-pick bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-xl p-4 mb-3 border ${index === 0 ? 'border-yellow-500' : 'border-purple-500/30'}">
                ${index === 0 ? '<div class="text-yellow-400 text-xs font-bold mb-2">ğŸ¥‡ MEJOR PICK DEL DÃA</div>' : ''}
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-white font-bold text-lg">${pick.local} vs ${pick.away}</p>
                        <p class="text-purple-300 font-semibold">${pick.period} ${pick.betType} ${pick.line}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-black ${pick.confidence >= 70 ? 'text-green-400' : 'text-yellow-400'}">${pick.confidence}%</p>
                        <p class="text-xs text-gray-400 font-medium">confianza</p>
                    </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3 mb-3">
                    <p class="text-gray-300 text-sm font-medium">${pick.reason}</p>
                    ${pick.h2hGames > 0 ? `<p class="text-purple-400 text-xs mt-1 font-medium">ğŸ“Š ${pick.h2hGames} partidos H2H analizados</p>` : ''}
                </div>
                <button onclick="selectBestPick('${pick.local}', '${pick.away}')" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm font-bold">
                    ğŸ“ˆ Analizar este matchup
                </button>
            </div>
        `;
    });
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">ğŸ”¥ MEJORES PICKS</h1>
                </div>
                <p class="text-gray-400 text-sm">Algoritmo basado en tendencias + H2H</p>
            </div>
            
            <div class="glass rounded-xl p-4">
                ${picksHtml}
            </div>
            
            <div class="mt-6 bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                <p class="text-yellow-400 text-sm">âš ï¸ <strong>Disclaimer:</strong> Estas sugerencias son basadas en anÃ¡lisis estadÃ­stico. Siempre haz tu propia investigaciÃ³n y apuesta responsablemente.</p>
            </div>
        </div>
    `;
}

function selectBestPick(local, away) {
    localTeam = local;
    visitingTeam = away;
    navigateTo('tendencia');
}

function registerPick(period, betType, line, probability, oddsFromForm) {
    let odds = oddsFromForm ? parseFloat(oddsFromForm) : null;
    
    // Si no hay cuota del formulario, pedirla
    if (!odds || odds <= 1) {
        const oddsInput = prompt('Ingresa la cuota (ej: 1.85):');
        if (oddsInput === null) return;
        odds = parseFloat(oddsInput) || null;
    }
    
    // Calcular EV para guardar
    const ev = odds ? calcEV(probability, odds) : null;
    
    addPick({
        localTeam,
        awayTeam: visitingTeam,
        period,
        betType,
        line,
        probability,
        odds,
        ev // Guardar EV para anÃ¡lisis posterior
    });
}

// Registrar Bet Builder (picks combinados)
function registerBetBuilder() {
    const comboOdds = document.getElementById('combo_odds')?.value;
    if (!comboOdds || parseFloat(comboOdds) <= 1) {
        showNotification('âš ï¸ Ingresa la cuota combinada del Bet Builder', 'warning');
        return;
    }
    
    const odds = parseFloat(comboOdds);
    const legs = []; // Patas del bet builder
    let combinedProb = 1; // Probabilidad combinada (multiplicar)
    
    // Verificar cuÃ¡les estÃ¡n seleccionados
    const q1Checked = document.getElementById('combo_q1')?.checked;
    const halfChecked = document.getElementById('combo_half')?.checked;
    const fullChecked = document.getElementById('combo_full')?.checked;
    
    // Agregar Q1 si estÃ¡ seleccionado
    if (q1Checked && lineQ1) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.q1Home || 0) + (TEAM_STATS[visitingTeam]?.q1Away || 0),
            lineQ1, typeQ1
        );
        if (prob) {
            legs.push({ period: '1Q', betType: typeQ1, line: lineQ1, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    // Agregar 1H si estÃ¡ seleccionado
    if (halfChecked && lineHalf) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.halfHome || 0) + (TEAM_STATS[visitingTeam]?.halfAway || 0),
            lineHalf, typeHalf
        );
        if (prob) {
            legs.push({ period: '1H', betType: typeHalf, line: lineHalf, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    // Agregar FULL si estÃ¡ seleccionado
    if (fullChecked && lineFull) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.fullHome || 0) + (TEAM_STATS[visitingTeam]?.fullAway || 0),
            lineFull, typeFull
        );
        if (prob) {
            legs.push({ period: 'FULL', betType: typeFull, line: lineFull, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    if (legs.length < 2) {
        showNotification('âš ï¸ Selecciona al menos 2 picks para el Bet Builder', 'warning');
        return;
    }
    
    // Calcular probabilidad combinada y EV
    const combinedProbPercent = Math.round(combinedProb * 100);
    const ev = calcEV(combinedProbPercent, odds);
    
    // Crear descripciÃ³n del combo
    const comboDesc = legs.map(l => `${l.period} ${l.betType} ${l.line}`).join(' + ');
    
    addPick({
        localTeam,
        awayTeam: visitingTeam,
        period: 'COMBO',
        betType: 'BET BUILDER',
        line: comboDesc,
        probability: combinedProbPercent,
        odds,
        ev,
        legs, // Guardar detalles de cada pata
        isCombo: true
    });
    
    showNotification(`ğŸ”¥ Bet Builder registrado: ${legs.length} picks combinados`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD PRO - GRÃFICOS Y ANÃLISIS AVANZADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let profitChart = null;
let teamChart = null;

function renderDashboard() {
    try {
    const stats = getPicksStats();
    const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending').sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    // Calcular profit acumulado para el grÃ¡fico
    let profitAcum = 0;
    const profitData = picks.map(pick => {
        if (pick.status === 'win') {
            profitAcum += (pick.odds - 1);
        } else if (pick.status === 'loss') {
            profitAcum -= 1;
        }
        return {
            date: new Date(pick.createdAt).toLocaleDateString('es-ES', {day:'2-digit', month:'short'}),
            profit: parseFloat(profitAcum.toFixed(2)),
            status: pick.status
        };
    });
    
    // Calcular rendimiento por equipo
    const teamStats = {};
    picks.forEach(pick => {
        const teams = [pick.localTeam, pick.awayTeam];
        teams.forEach(team => {
            if (!team) return;
            if (!teamStats[team]) teamStats[team] = { wins: 0, losses: 0, profit: 0 };
            if (pick.status === 'win') {
                teamStats[team].wins++;
                teamStats[team].profit += (pick.odds - 1);
            } else if (pick.status === 'loss') {
                teamStats[team].losses++;
                teamStats[team].profit -= 1;
            }
        });
    });
    
    // Top 5 equipos mÃ¡s rentables
    const topTeams = Object.entries(teamStats)
        .map(([team, data]) => ({
            team,
            ...data,
            winRate: data.wins + data.losses > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(0) : 0,
            total: data.wins + data.losses
        }))
        .filter(t => t.total >= 2)
        .sort((a,b) => b.profit - a.profit)
        .slice(0, 8);
    
    // CLV Stats (si tenemos datos)
    const picksWithCLV = Object.values(PICKS_DATABASE).filter(p => p.closingLine && p.line);
    let avgCLV = 0;
    if (picksWithCLV.length > 0) {
        const totalCLV = picksWithCLV.reduce((sum, p) => {
            const clv = parseFloat(p.line) - parseFloat(p.closingLine);
            return sum + (p.betType === 'OVER' ? clv : -clv);
        }, 0);
        avgCLV = (totalCLV / picksWithCLV.length).toFixed(2);
    }
    
    // AnÃ¡lisis por cuartos extendido (Q2, Q3, Q4)
    const quarterAnalysis = {
        '1Q': { wins: 0, losses: 0, profit: 0 },
        '2Q': { wins: 0, losses: 0, profit: 0 },
        '3Q': { wins: 0, losses: 0, profit: 0 },
        '4Q': { wins: 0, losses: 0, profit: 0 },
        '1H': { wins: 0, losses: 0, profit: 0 },
        '2H': { wins: 0, losses: 0, profit: 0 },
        'FULL': { wins: 0, losses: 0, profit: 0 }
    };
    
    picks.forEach(pick => {
        const period = pick.period;
        if (quarterAnalysis[period]) {
            if (pick.status === 'win') {
                quarterAnalysis[period].wins++;
                quarterAnalysis[period].profit += (pick.odds - 1);
            } else {
                quarterAnalysis[period].losses++;
                quarterAnalysis[period].profit -= 1;
            }
        }
    });
    
    const teamStatsHtml = topTeams.length > 0 ? topTeams.map(t => `
        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3 mb-2">
            <div>
                <span class="text-white font-bold">${t.team}</span>
                <span class="text-gray-400 text-xs ml-2">(${t.total} picks)</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm ${parseFloat(t.winRate) >= 55 ? 'text-green-400' : parseFloat(t.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${t.winRate}%</span>
                <span class="font-bold ${t.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${t.profit >= 0 ? '+' : ''}${t.profit.toFixed(2)}u</span>
            </div>
        </div>
    `).join('') : '<p class="text-gray-400 text-center py-4">Necesitas mÃ¡s picks para ver estadÃ­sticas por equipo</p>';
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">ğŸ“‰ DASHBOARD PRO</h1>
                </div>
                <p class="text-cyan-400 text-sm">AnÃ¡lisis avanzado de rendimiento</p>
            </div>
            
            <!-- RESUMEN RÃPIDO -->
            <div class="grid grid-cols-4 gap-3 mb-6">
                <div class="bg-gradient-to-br from-green-500/20 to-emerald-600/20 rounded-xl p-4 text-center border border-green-500/30">
                    <p class="text-3xl font-black text-green-400">${stats.winRate}%</p>
                    <p class="text-gray-300 text-xs font-semibold">Win Rate</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-600/20 rounded-xl p-4 text-center border border-cyan-500/30">
                    <p class="text-3xl font-black ${parseFloat(stats.profit) >= 0 ? 'text-cyan-400' : 'text-red-400'}">${parseFloat(stats.profit) >= 0 ? '+' : ''}${stats.profit}u</p>
                    <p class="text-gray-300 text-xs font-semibold">Profit</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-600/20 rounded-xl p-4 text-center border border-purple-500/30">
                    <p class="text-3xl font-black ${parseFloat(stats.roi) >= 0 ? 'text-purple-400' : 'text-red-400'}">${parseFloat(stats.roi) >= 0 ? '+' : ''}${stats.roi}%</p>
                    <p class="text-gray-300 text-xs font-semibold">ROI</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-500/20 to-orange-600/20 rounded-xl p-4 text-center border border-yellow-500/30">
                    <p class="text-3xl font-black text-yellow-400">${picks.length}</p>
                    <p class="text-gray-300 text-xs font-semibold">Picks</p>
                </div>
            </div>
            
            <!-- GRÃFICO DE PROFIT ACUMULADO -->
            <div class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-2xl p-5 mb-6 border border-gray-700">
                <h3 class="text-lg font-bold text-white mb-4">ğŸ“ˆ EvoluciÃ³n de Profit</h3>
                <div style="height: 250px;">
                    <canvas id="profitChart"></canvas>
                </div>
                ${picks.length < 3 ? '<p class="text-gray-400 text-center text-sm mt-2">Necesitas al menos 3 picks resueltos para ver el grÃ¡fico</p>' : ''}
            </div>
            
            <!-- CLV TRACKER -->
            <div class="bg-gradient-to-br from-indigo-600/20 to-purple-700/20 rounded-2xl p-5 mb-6 border border-indigo-500/50">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ¯ CLV Tracker (Closing Line Value)</h3>
                <p class="text-gray-300 text-sm mb-4">El CLV mide si apuestas antes de que la lÃ­nea se mueva a tu favor. <strong class="text-yellow-400">CLV positivo = pensÃ¡s como un sharp.</strong></p>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-black/30 rounded-xl p-4 text-center">
                        <p class="text-2xl font-black ${parseFloat(avgCLV) >= 0 ? 'text-green-400' : 'text-red-400'}">${avgCLV > 0 ? '+' : ''}${avgCLV} pts</p>
                        <p class="text-gray-400 text-xs font-semibold">CLV Promedio</p>
                    </div>
                    <div class="bg-black/30 rounded-xl p-4 text-center">
                        <p class="text-2xl font-black text-cyan-400">${picksWithCLV.length}</p>
                        <p class="text-gray-400 text-xs font-semibold">Picks con CLV</p>
                    </div>
                </div>
                
                <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/30">
                    <p class="text-yellow-400 text-xs">ğŸ’¡ <strong>Tip:</strong> En "Mis Picks" puedes agregar la lÃ­nea de cierre a cada pick para calcular tu CLV.</p>
                </div>
            </div>
            
            <!-- RENDIMIENTO POR EQUIPO -->
            <div class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-2xl p-5 mb-6 border border-gray-700">
                <h3 class="text-lg font-bold text-white mb-4">ğŸ€ Rendimiento por Equipo</h3>
                ${teamStatsHtml}
            </div>
            
            <!-- ANÃLISIS POR PERÃODO EXTENDIDO -->
            <div class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-2xl p-5 mb-6 border border-purple-500/50">
                <h3 class="text-lg font-bold text-white mb-4">ğŸ“Š AnÃ¡lisis por PerÃ­odo</h3>
                <div class="grid grid-cols-4 gap-2 mb-3">
                    ${['1Q', '2Q', '3Q', '4Q'].map(q => {
                        const data = quarterAnalysis[q];
                        const total = data.wins + data.losses;
                        const wr = total > 0 ? ((data.wins / total) * 100).toFixed(0) : '-';
                        const wrNum = total > 0 ? (data.wins / total) * 100 : 0;
                        return `
                            <div class="bg-black/30 rounded-xl p-3 text-center">
                                <p class="text-yellow-400 font-bold">${q}</p>
                                <p class="text-white font-bold">${data.wins}W-${data.losses}L</p>
                                <p class="text-sm font-semibold ${total > 0 && wrNum >= 50 ? 'text-green-400' : total > 0 ? 'text-red-400' : 'text-gray-500'}">${wr}%</p>
                                <p class="text-xs font-semibold ${data.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${data.profit >= 0 ? '+' : ''}${data.profit.toFixed(2)}u</p>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="grid grid-cols-3 gap-2">
                    ${['1H', '2H', 'FULL'].map(p => {
                        const data = quarterAnalysis[p];
                        const total = data.wins + data.losses;
                        const wr = total > 0 ? ((data.wins / total) * 100).toFixed(0) : '-';
                        const wrNum = total > 0 ? (data.wins / total) * 100 : 0;
                        const colors = { '1H': 'pink', '2H': 'orange', 'FULL': 'green' };
                        const color = colors[p];
                        return `
                            <div class="bg-${color}-500/10 rounded-xl p-3 text-center border border-${color}-500/30">
                                <p class="text-${color}-400 font-bold">${p}</p>
                                <p class="text-white font-bold">${data.wins}W-${data.losses}L</p>
                                <p class="text-sm font-semibold ${total > 0 && wrNum >= 50 ? 'text-green-400' : total > 0 ? 'text-red-400' : 'text-gray-500'}">${wr}%</p>
                                <p class="text-xs font-semibold ${data.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${data.profit >= 0 ? '+' : ''}${data.profit.toFixed(2)}u</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <!-- MODELO DE IA - PREDICTOR -->
            <div class="bg-gradient-to-br from-emerald-600/20 to-teal-700/20 rounded-2xl p-5 mb-6 border border-emerald-500/50">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ¤– Modelo IA - Predictor de Valor</h3>
                <p class="text-gray-300 text-sm mb-4">Modelo de regresiÃ³n entrenado con tus datos para predecir quÃ© picks tienen mayor probabilidad de Ã©xito.</p>
                
                <div class="bg-black/30 rounded-xl p-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-emerald-400 font-bold text-lg">Variables del Modelo:</p>
                            <ul class="text-gray-300 text-xs text-left mt-2 space-y-1">
                                <li>â€¢ Tendencia combinada</li>
                                <li>â€¢ Diferencia vs lÃ­nea</li>
                                <li>â€¢ Z-Score calculado</li>
                                <li>â€¢ EV esperado</li>
                                <li>â€¢ Historial H2H</li>
                            </ul>
                        </div>
                        <div class="text-center">
                            <p class="text-emerald-400 font-bold text-lg">Estado:</p>
                            <p class="text-2xl mt-2">${picks.length >= 20 ? 'âœ…' : 'â³'}</p>
                            <p class="text-gray-400 text-xs mt-1">${picks.length >= 20 ? 'Modelo activo' : `${picks.length}/20 picks para activar`}</p>
                        </div>
                    </div>
                    ${picks.length >= 20 ? `
                        <div class="bg-emerald-500/20 rounded-lg p-3 border border-emerald-500/30">
                            <p class="text-emerald-400 text-sm text-center">ğŸ¯ El modelo estÃ¡ analizando tus patrones de Ã©xito y ajustando las predicciones.</p>
                        </div>
                    ` : `
                        <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/30">
                            <p class="text-yellow-400 text-xs text-center">ğŸ“Š Registra mÃ¡s picks para que el modelo aprenda de tus resultados.</p>
                        </div>
                    `}
                </div>
            </div>
            
            <!-- CRÃ‰DITOS -->
            <div class="bg-white/5 rounded-xl p-4 text-center">
                <p class="text-gray-400 text-xs">NioSports Pro v1.1 - Desarrollado con IA por Claude (Anthropic)</p>
                <p class="text-gray-500 text-xs mt-1">Dashboard, CLV Tracker, AnÃ¡lisis Extendido, Modelo Predictivo</p>
            </div>
        </div>
    `;
    } catch (error) {
        console.error('Error en renderDashboard:', error);
        return `
            <div class="p-4 max-w-4xl mx-auto">
                <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
                <div class="bg-red-500/20 border border-red-500 rounded-xl p-6 text-center">
                    <p class="text-red-400 text-xl mb-2">âš ï¸ Error al cargar Dashboard</p>
                    <p class="text-gray-300 text-sm">${error.message}</p>
                </div>
            </div>
        `;
    }
}

// Inicializar grÃ¡ficos del Dashboard
function initDashboardCharts() {
    const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending').sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    if (picks.length < 3) return;
    
    // Calcular datos para el grÃ¡fico
    let profitAcum = 0;
    const labels = [];
    const data = [];
    const colors = [];
    
    picks.forEach((pick, i) => {
        if (pick.status === 'win') {
            profitAcum += (pick.odds - 1);
            colors.push('rgba(34, 197, 94, 0.8)');
        } else if (pick.status === 'loss') {
            profitAcum -= 1;
            colors.push('rgba(239, 68, 68, 0.8)');
        }
        labels.push(`#${i + 1}`);
        data.push(parseFloat(profitAcum.toFixed(2)));
    });
    
    // Crear grÃ¡fico de lÃ­nea
    const ctx = document.getElementById('profitChart');
    if (!ctx) return;
    
    // Destruir grÃ¡fico anterior si existe
    if (profitChart) {
        profitChart.destroy();
    }
    
    profitChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Profit Acumulado (u)',
                data: data,
                borderColor: profitAcum >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)',
                backgroundColor: profitAcum >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: colors,
                pointBorderColor: colors,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Profit: ${context.raw >= 0 ? '+' : ''}${context.raw}u`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: function(value) {
                            return value + 'u';
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INGESTA VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIngesta() {
    const teams = getTeams();
    const existH2H = ingestTeam1 && ingestTeam2 ? getH2HData(ingestTeam1, ingestTeam2) : null;
    
    let o1 = '<option value="">Seleccionar...</option>';
    let o2 = '<option value="">Seleccionar...</option>';
    teams.forEach(t => {
        o1 += `<option value="${t}"${t===ingestTeam1?' selected':''}>${t}</option>`;
        if (t !== ingestTeam1) o2 += `<option value="${t}"${t===ingestTeam2?' selected':''}>${t}</option>`;
    });
    
    let html = `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">INGESTA H2H</h1>
                </div>
                <p class="text-green-400 text-sm mt-2">â˜ï¸ Los datos se guardan en Firebase automÃ¡ticamente</p>
            </div>
            
            <div class="glass rounded-xl p-5 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">1ï¸âƒ£ Seleccionar Equipos</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Equipo 1</label>
                        <select id="ingestTeam1" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">${o1}</select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Equipo 2</label>
                        <select id="ingestTeam2" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">${o2}</select>
                    </div>
                </div>
            </div>
    `;
    
    if (ingestTeam1 && ingestTeam2) {
        html += `
            <div class="glass rounded-xl p-5 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">2ï¸âƒ£ Fecha y LocalÃ­a</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Fecha del Partido</label>
                        <input type="date" id="ingestDate" value="${ingestDate}" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Â¿QuiÃ©n es LOCAL? ğŸ </label>
                        <select id="ingestLocal" class="w-full p-3 font-bold rounded-lg text-gray-800 bg-white">
                            <option value="">Seleccionar...</option>
                            <option value="${ingestTeam1}"${ingestLocalTeam===ingestTeam1?' selected':''}>${ingestTeam1}</option>
                            <option value="${ingestTeam2}"${ingestLocalTeam===ingestTeam2?' selected':''}>${ingestTeam2}</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        if (ingestLocalTeam && ingestDate) {
            html += `
                <div class="bg-slate-800 rounded-2xl p-5 mb-6 border border-slate-600">
                    <h2 class="text-lg font-bold text-white mb-4 text-center">3ï¸âƒ£ Puntos por Cuarto</h2>
                    <div class="score-grid">${renderScoreInputs()}</div>
                    ${renderTotals()}
                </div>
                <button onclick="saveGame()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl text-xl hover:scale-[1.02] transition mb-6">ğŸ’¾ GUARDAR EN FIREBASE</button>
            `;
        }
        
        if (existH2H) {
            let gh = existH2H.games.map((g,i) => `
                <div class="bg-slate-800/50 rounded-lg p-3 flex justify-between items-center">
                    <div>
                        <p class="text-gray-400 text-xs">${g.date}${g.overtimes>0?` <span class="text-yellow-400">(${g.overtimes}OT)</span>`:''}</p>
                        <p class="text-white font-bold">${g.localTeam} ${g.t1Total}-${g.t2Total} ${g.awayTeam}</p>
                        <p class="text-gray-500 text-xs">1H: ${g.t1Half}-${g.t2Half} | Total: ${g.totalPts}</p>
                    </div>
                    <button onclick="deleteGame('${ingestTeam1}','${ingestTeam2}',${i})" class="text-red-400 hover:text-red-300 text-xl">ğŸ—‘ï¸</button>
                </div>
            `).join('');
            
            html += `
                <div class="glass rounded-xl p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">ğŸ“‹ Historial ${ingestTeam1} vs ${ingestTeam2}</h2>
                        <span class="text-sm text-purple-400">${existH2H.totalGames} partidos</span>
                    </div>
                    <div class="bg-purple-900/30 rounded-lg p-3 mb-4">
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div><p class="text-gray-400">Prom 1Q</p><p class="text-white font-bold">${(existH2H.avgQ1.team1+existH2H.avgQ1.team2).toFixed(1)}</p></div>
                            <div><p class="text-gray-400">Prom 1H</p><p class="text-white font-bold">${(existH2H.avgHalf.team1+existH2H.avgHalf.team2).toFixed(1)}</p></div>
                            <div><p class="text-gray-400">Prom Full</p><p class="text-white font-bold">${(existH2H.avgPts.team1+existH2H.avgPts.team2).toFixed(1)}</p></div>
                        </div>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">${gh}</div>
                </div>
            `;
        } else if (ingestTeam1 && ingestTeam2) {
            html += `<div class="glass rounded-xl p-5 text-center"><p class="text-gray-400">No hay partidos registrados</p></div>`;
        }
    }
    
    html += '</div>';
    return html;
}

function renderScoreInputs() {
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const ot = checkOT();
    let cols = 5;
    if (ot.needOT1) cols++;
    if (ot.needOT2) cols++;
    if (ot.needOT3) cols++;
    
    const gs = `display:grid;grid-template-columns:80px repeat(${cols-1},minmax(50px,1fr));gap:0.4rem;`;
    
    let h = `<div style="${gs}" class="mb-3 text-center items-center">
        <div class="text-gray-500 text-xs font-bold">EQUIPO</div>
        <div class="text-gray-400 text-xs font-bold">1Â° C</div>
        <div class="text-gray-400 text-xs font-bold">2Â° C</div>
        <div class="text-gray-400 text-xs font-bold">3Â° C</div>
        <div class="text-gray-400 text-xs font-bold">4Â° C</div>`;
    if (ot.needOT1) h += `<div class="text-yellow-400 text-xs font-bold animate-pulse">OT1</div>`;
    if (ot.needOT2) h += `<div class="text-orange-400 text-xs font-bold animate-pulse">OT2</div>`;
    if (ot.needOT3) h += `<div class="text-red-400 text-xs font-bold animate-pulse">OT3</div>`;
    h += '</div>';
    
    let lr = `<div style="${gs}" class="mb-3 items-center">
        <div class="text-cyan-400 font-bold text-xs truncate">ğŸ  ${ingestLocalTeam}</div>
        <input type="number" id="localQ1" value="${ingestScores.localQ1}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ1',this.value)">
        <input type="number" id="localQ2" value="${ingestScores.localQ2}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ2',this.value)">
        <input type="number" id="localQ3" value="${ingestScores.localQ3}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ3',this.value)">
        <input type="number" id="localQ4" value="${ingestScores.localQ4}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ4',this.value)">`;
    if (ot.needOT1) lr += `<input type="number" id="localOT1" value="${ingestScores.localOT1}" placeholder="0" class="score-input ot-input p-2 rounded-lg text-yellow-400 text-center text-lg font-bold w-full" oninput="updateScore('localOT1',this.value)">`;
    if (ot.needOT2) lr += `<input type="number" id="localOT2" value="${ingestScores.localOT2}" placeholder="0" class="score-input p-2 rounded-lg text-orange-400 text-center text-lg font-bold border-orange-500 w-full" oninput="updateScore('localOT2',this.value)">`;
    if (ot.needOT3) lr += `<input type="number" id="localOT3" value="${ingestScores.localOT3}" placeholder="0" class="score-input p-2 rounded-lg text-red-400 text-center text-lg font-bold border-red-500 w-full" oninput="updateScore('localOT3',this.value)">`;
    lr += '</div>';
    
    let ar = `<div style="${gs}" class="mb-4 items-center">
        <div class="text-orange-400 font-bold text-xs truncate">âœˆï¸ ${away}</div>
        <input type="number" id="awayQ1" value="${ingestScores.awayQ1}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ1',this.value)">
        <input type="number" id="awayQ2" value="${ingestScores.awayQ2}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ2',this.value)">
        <input type="number" id="awayQ3" value="${ingestScores.awayQ3}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ3',this.value)">
        <input type="number" id="awayQ4" value="${ingestScores.awayQ4}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ4',this.value)">`;
    if (ot.needOT1) ar += `<input type="number" id="awayOT1" value="${ingestScores.awayOT1}" placeholder="0" class="score-input ot-input p-2 rounded-lg text-yellow-400 text-center text-lg font-bold w-full" oninput="updateScore('awayOT1',this.value)">`;
    if (ot.needOT2) ar += `<input type="number" id="awayOT2" value="${ingestScores.awayOT2}" placeholder="0" class="score-input p-2 rounded-lg text-orange-400 text-center text-lg font-bold border-orange-500 w-full" oninput="updateScore('awayOT2',this.value)">`;
    if (ot.needOT3) ar += `<input type="number" id="awayOT3" value="${ingestScores.awayOT3}" placeholder="0" class="score-input p-2 rounded-lg text-red-400 text-center text-lg font-bold border-red-500 w-full" oninput="updateScore('awayOT3',this.value)">`;
    ar += '</div>';
    
    let warn = '';
    if (ot.needOT1) warn = '<div class="text-yellow-400 text-center text-sm mb-3 animate-pulse">âš ï¸ EMPATE DETECTADO - Ingresa puntos del Overtime</div>';
    
    return h + lr + ar + warn;
}

function renderTotals() {
    const s = getScores();
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const lH = s.lQ1+s.lQ2, aH = s.aQ1+s.aQ2;
    const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
    const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
    const hadOT = s.lOT1>0 || s.aOT1>0;
    let win = 'Empate', wc = 'text-gray-400';
    if (lT > aT) { win = ingestLocalTeam; wc = 'text-cyan-400'; }
    else if (aT > lT) { win = away; wc = 'text-orange-400'; }
    
    return `
        <div class="border-t border-slate-600 pt-4 mt-4">
            <h3 class="text-white font-bold text-center mb-3">ğŸ“Š TOTALES CALCULADOS</h3>
            <div id="totalsDisplay" class="grid grid-cols-3 gap-4">
                <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">1er Tiempo</p>
                    <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lH}</p>
                    <p class="text-orange-400 font-bold">${away}: ${aH}</p>
                    <p class="text-yellow-400 font-black text-xl mt-1">Total: ${lH+aH}</p>
                </div>
                <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">Tiempo Completo${hadOT?' + OT':''}</p>
                    <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lT}</p>
                    <p class="text-orange-400 font-bold">${away}: ${aT}</p>
                    <p class="text-purple-400 font-black text-xl mt-1">Total: ${lT+aT}</p>
                </div>
                <div class="bg-green-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">Ganador${hadOT?' (OT)':''}</p>
                    <p class="text-3xl font-black ${wc}">${win}</p>
                    <p class="text-white font-bold">${lT}-${aT}</p>
                </div>
            </div>
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N Y EVENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigateTo(v) {
    currentView = v;
    if (v === 'home') {
        localTeam = visitingTeam = '';
        lineQ1 = lineHalf = lineFull = '';
    }
    if (v === 'ingesta' && !ingestTeam1) {
        ingestTeam1 = ingestTeam2 = ingestLocalTeam = ingestDate = '';
        ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    }
    render();
}

function goToIngestWithTeams() {
    ingestTeam1 = localTeam;
    ingestTeam2 = visitingTeam;
    ingestLocalTeam = ingestDate = '';
    ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    navigateTo('ingesta');
}

function updateScore(field, value) {
    ingestScores[field] = value;
    const ot = checkOT();
    const ot1E = document.getElementById('localOT1');
    const ot2E = document.getElementById('localOT2');
    if ((ot.needOT1 && !ot1E) || (!ot.needOT1 && ot1E) || (ot.needOT2 && !ot2E) || (!ot.needOT2 && ot2E && ot.needOT1)) {
        const scrollY = window.scrollY;
        render();
        window.scrollTo(0, scrollY);
        return;
    }
    const td = document.getElementById('totalsDisplay');
    if (td) {
        const s = getScores();
        const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
        const lH = s.lQ1+s.lQ2, aH = s.aQ1+s.aQ2;
        const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
        const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
        const hadOT = s.lOT1>0 || s.aOT1>0;
        let win = 'Empate', wc = 'text-gray-400';
        if (lT > aT) { win = ingestLocalTeam; wc = 'text-cyan-400'; }
        else if (aT > lT) { win = away; wc = 'text-orange-400'; }
        td.innerHTML = `
            <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">1er Tiempo</p>
                <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lH}</p>
                <p class="text-orange-400 font-bold">${away}: ${aH}</p>
                <p class="text-yellow-400 font-black text-xl mt-1">Total: ${lH+aH}</p>
            </div>
            <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">Tiempo Completo${hadOT?' + OT':''}</p>
                <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lT}</p>
                <p class="text-orange-400 font-bold">${away}: ${aT}</p>
                <p class="text-purple-400 font-black text-xl mt-1">Total: ${lT+aT}</p>
            </div>
            <div class="bg-green-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">Ganador${hadOT?' (OT)':''}</p>
                <p class="text-3xl font-black ${wc}">${win}</p>
                <p class="text-white font-bold">${lT}-${aT}</p>
            </div>
        `;
    }
}

function saveGame() {
    if (!firebaseConnected) {
        showNotification('âš ï¸ No hay conexiÃ³n con Firebase', 'warning');
        return;
    }
    
    const di = document.getElementById('ingestDate');
    if (di) ingestDate = di.value;
    ['localQ1','localQ2','localQ3','localQ4','awayQ1','awayQ2','awayQ3','awayQ4','localOT1','awayOT1','localOT2','awayOT2','localOT3','awayOT3'].forEach(id => {
        const inp = document.getElementById(id);
        if (inp) ingestScores[id] = inp.value;
    });
    if (!ingestTeam1 || !ingestTeam2 || !ingestLocalTeam || !ingestDate) {
        showNotification('âš ï¸ Completa todos los campos', 'warning');
        return;
    }
    const s = getScores();
    const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
    const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
    if (lT === 0 || aT === 0) {
        showNotification('âš ï¸ Ingresa los puntos', 'warning');
        return;
    }
    if (lT === aT) {
        showNotification('âš ï¸ Empate. Ingresa Overtime', 'warning');
        return;
    }
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const [y,m,d] = ingestDate.split('-');
    const ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const df = ms[parseInt(m)-1] + ' ' + parseInt(d) + ', ' + y;
    let ots = 0;
    if (s.lOT1>0 || s.aOT1>0) ots = 1;
    if (s.lOT2>0 || s.aOT2>0) ots = 2;
    if (s.lOT3>0 || s.aOT3>0) ots = 3;
    
    addH2HGame(ingestTeam1, ingestTeam2, {
        date: df,
        localTeam: ingestLocalTeam,
        awayTeam: away,
        localQ1: s.lQ1, localQ2: s.lQ2, localQ3: s.lQ3, localQ4: s.lQ4,
        awayQ1: s.aQ1, awayQ2: s.aQ2, awayQ3: s.aQ3, awayQ4: s.aQ4,
        localOT1: s.lOT1, awayOT1: s.aOT1,
        localOT2: s.lOT2, awayOT2: s.aOT2,
        localOT3: s.lOT3, awayOT3: s.aOT3,
        overtimes: ots
    });
    
    ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    ingestDate = '';
    ingestLocalTeam = '';
    render();
}

function deleteGame(t1, t2, i) {
    if (confirm('Â¿Eliminar este partido de Firebase?')) {
        deleteH2HGame(t1, t2, i);
    }
}

function attachEvents() {
    document.getElementById('localSelect')?.addEventListener('change', e => { 
        localTeam = e.target.value; 
        render(); 
        setTimeout(checkForValuePicks, 100);
    });
    document.getElementById('visitingSelect')?.addEventListener('change', e => { 
        visitingTeam = e.target.value; 
        render(); 
        setTimeout(checkForValuePicks, 100);
    });
    document.getElementById('ingestTeam1')?.addEventListener('change', e => { ingestTeam1 = e.target.value; ingestLocalTeam = ''; render(); });
    document.getElementById('ingestTeam2')?.addEventListener('change', e => { ingestTeam2 = e.target.value; ingestLocalTeam = ''; render(); });
    document.getElementById('ingestDate')?.addEventListener('change', e => { ingestDate = e.target.value; });
    document.getElementById('ingestLocal')?.addEventListener('change', e => { ingestLocalTeam = e.target.value; render(); });
}

function setType(p, v) {
    if (p === 'Q1') typeQ1 = v;
    if (p === 'Half') typeHalf = v;
    if (p === 'Full') typeFull = v;
    render();
    setTimeout(checkForValuePicks, 100);
}

function updateLine(p, v) {
    if (p === 'Q1') lineQ1 = v;
    if (p === 'Half') lineHalf = v;
    if (p === 'Full') lineFull = v;
    render();
    setTimeout(checkForValuePicks, 100);
}

function updateOdds(p, v) {
    if (p === 'Q1') oddsQ1 = v;
    if (p === 'Half') oddsHalf = v;
    if (p === 'Full') oddsFull = v;
    render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
    // Primero cargar estadÃ­sticas desde API
    await loadTeamStatsFromAPI();
    // Luego cargar datos de Firebase
    loadH2HFromFirebase();
});
    </script>
</body>
</html>
