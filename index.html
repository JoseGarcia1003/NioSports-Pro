<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NioSports Pro v2.5 FINAL - Modelo Predictivo Avanzado</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema predictivo avanzado para totales NBA con backtesting, B2B, PACE y calibraciÃ³n">
    <meta name="theme-color" content="#0d1b2a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NioSports">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22NioSports%20Pro%22%2C%22short_name%22%3A%22NioSports%22%2C%22description%22%3A%22Sistema%20predictivo%20NBA%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231a1a2e%22%2C%22theme_color%22%3A%22%231a1a2e%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%252064%252064%27%253E%253Ccircle%2520cx%3D%2732%27%2520cy%3D%2732%27%2520r%3D%2730%27%2520fill%3D%27%25231a1a2e%27%2F%253E%253Ctext%2520x%3D%2732%27%2520y%3D%2742%27%2520text-anchor%3D%27middle%27%2520font-size%3D%2730%27%2520fill%3D%27white%27%253EN%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
    
    <!-- FAVICON - Logo NioSports NUEVO -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FFD700'/%3E%3Cstop offset='100%25' style='stop-color:%23F59E0B'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%230d1b2a'/%3E%3Ccircle cx='32' cy='32' r='28' fill='none' stroke='url(%23g1)' stroke-width='3'/%3E%3Ccircle cx='32' cy='26' r='10' fill='%23f97316'/%3E%3Ctext x='32' y='50' text-anchor='middle' font-family='Arial Black' font-size='12' font-weight='bold' fill='%23FFD700'%3EN%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230d1b2a'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-size='30' fill='%23FFD700'%3EN%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Bebas+Neue&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Chart.js para bankroll -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js para grÃ¡ficos del Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .font-display { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* NUEVA PALETA: AZUL MARINO + AMARILLO + BLANCO                  */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --navy-dark: #0a1628;
            --navy-primary: #0d1b2a;
            --navy-light: #1b263b;
            --navy-lighter: #22354a;
            --gold-primary: #FFD700;
            --gold-light: #FFEB3B;
            --gold-dark: #F59E0B;
            --white: #ffffff;
            --white-soft: #f0f4f8;
            --text-muted: #94a3b8;
        }
        
        body {
            background: var(--navy-dark);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* FONDO CON CANCHA DE BASKETBALL SUTIL                           */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -2;
            background: 
                radial-gradient(ellipse 80% 50% at 50% 100%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                linear-gradient(180deg, var(--navy-dark) 0%, var(--navy-primary) 50%, var(--navy-light) 100%);
        }
        
        /* LÃ­neas de cancha sutiles */
        .animated-bg::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 2px solid rgba(255, 215, 0, 0.05);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .animated-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 100px;
            border: 2px solid rgba(255, 215, 0, 0.05);
            border-bottom: none;
            border-radius: 200px 200px 0 0;
            pointer-events: none;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* PARTÃCULAS DORADAS FLOTANTES                                   */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.6) 0%, transparent 70%);
            border-radius: 50%;
            animation: floatGold 20s infinite ease-in-out;
        }
        
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 1s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 4s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 1s; }
        .particle:nth-child(10) { left: 15%; animation-delay: 3s; }
        .particle:nth-child(11) { left: 25%; animation-delay: 0s; width: 6px; height: 6px; }
        .particle:nth-child(12) { left: 35%; animation-delay: 2s; }
        .particle:nth-child(13) { left: 45%; animation-delay: 4s; width: 5px; height: 5px; }
        .particle:nth-child(14) { left: 55%; animation-delay: 1s; }
        .particle:nth-child(15) { left: 65%; animation-delay: 3s; width: 6px; height: 6px; }
        .particle:nth-child(16) { left: 75%; animation-delay: 5s; }
        .particle:nth-child(17) { left: 85%; animation-delay: 2s; }
        .particle:nth-child(18) { left: 95%; animation-delay: 4s; }
        .particle:nth-child(19) { left: 5%; animation-delay: 1s; width: 5px; height: 5px; }
        .particle:nth-child(20) { left: 50%; animation-delay: 3s; }
        
        @keyframes floatGold {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* GLASSMORPHISM MODERNO                                          */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .glass {
            background: rgba(27, 38, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .glass-card {
            background: rgba(27, 38, 59, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border-radius: 16px;
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.1);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* LOGO Y BRANDING                                                */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .logo-glow {
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.4));
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-light) 50%, var(--gold-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-text-animated {
            background: linear-gradient(90deg, var(--gold-primary), var(--white), var(--gold-primary));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmerText 3s linear infinite;
        }
        
        @keyframes shimmerText {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* BOTONES PROFESIONALES                                          */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn-primary {
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            color: var(--navy-dark);
            font-weight: 600;
            padding: 12px 28px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .btn-3d {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .btn-3d:hover {
            transform: translateY(-3px);
        }
        
        .btn-3d:active { transform: translateY(-1px); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TARJETAS CON EFECTO SHIMMER                                    */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .trend-card {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--navy-light) 0%, var(--navy-lighter) 100%);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 16px;
        }
        
        .trend-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(255, 215, 0, 0.05) 50%, transparent 60%);
            animation: shimmer 4s infinite;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* BADGES MODERNOS                                                */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .badge-neon {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .badge-neon-blue {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .badge-neon-green {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .badge-neon-pink {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }
        
        .badge-neon-yellow {
            background: rgba(255, 215, 0, 0.15);
            color: var(--gold-primary);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* SELECTORES PROFESIONALES                                       */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .select-premium {
            appearance: none;
            background: var(--navy-lighter);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 40px 12px 16px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23FFD700' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
        }
        
        .select-premium:hover, .select-premium:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.15);
            outline: none;
        }
        
        .select-premium option {
            background: var(--navy-light);
            color: white;
        }
        
        select {
            background-color: var(--navy-lighter) !important;
            color: white !important;
        }
        
        select option {
            background-color: var(--navy-light) !important;
            color: white !important;
            padding: 8px;
        }
        
        select option:hover,
        select option:checked {
            background-color: var(--gold-dark) !important;
            color: var(--navy-dark) !important;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* INPUTS MODERNOS                                                */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        input[type="text"], input[type="number"], input[type="date"] {
            background: var(--navy-lighter);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            padding: 10px 14px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.15);
            outline: none;
        }
        
        input::placeholder {
            color: var(--text-muted);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* NAVEGACIÃ“N SUPERIOR                                            */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav-item {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--text-muted);
        }
        
        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item.active {
            color: var(--navy-dark);
            background: var(--gold-primary);
            font-weight: 600;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* LIVE BAR                                                       */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .live-bar {
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, var(--navy-light), var(--navy-lighter));
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
        }
        
        @keyframes livePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* ELEMENTOS NBA DECORATIVOS                                      */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .basketball-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3), inset 2px 2px 4px rgba(255,255,255,0.2);
        }
        
        .basketball-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #1a1a1a;
            transform: translateY(-50%);
        }
        
        .basketball-icon::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #1a1a1a;
            transform: translateX(-50%);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* SECCIÃ“N HERO CON ESTADIO                                       */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hero-section {
            position: relative;
            padding: 40px 20px;
            text-align: center;
        }
        
        .hero-section::before {
            content: 'ğŸ€';
            position: absolute;
            font-size: 120px;
            opacity: 0.03;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* ANIMACIONES                                                    */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .slide-in { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* COMPONENTES ESPECÃFICOS                                        */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .h2h-card { 
            background: linear-gradient(135deg, var(--navy-light) 0%, var(--navy-lighter) 100%);
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        
        .score-input { 
            background: var(--navy-dark); 
            border: 2px solid var(--navy-lighter); 
        }
        .score-input:focus { border-color: var(--gold-primary); outline: none; }
        .ot-input { border-color: var(--gold-dark) !important; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .firebase-status { position: fixed; bottom: 10px; left: 10px; padding: 6px 12px; border-radius: 20px; font-size: 11px; z-index: 1000; font-weight: 500; }
        .firebase-connected { background: #22c55e; color: white; }
        .firebase-disconnected { background: #ef4444; color: white; }
        .firebase-loading { background: var(--gold-dark); color: var(--navy-dark); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* LOADING SPINNER                                                */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--navy-lighter);
            border-top-color: var(--gold-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            margin-top: 20px;
            color: var(--gold-primary);
            font-weight: 600;
            font-size: 14px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* NOTIFICACIONES                                                 */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .notification.info { background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); color: var(--navy-dark); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* SCROLLBAR PERSONALIZADO                                        */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--navy-dark); }
        ::-webkit-scrollbar-thumb { background: var(--navy-lighter); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dark); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TEMA CLARO - FONDO BLANCO LIMPIO                               */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        [data-theme="light"] body {
            background: #ffffff !important;
            color: #1a1a2a;
        }
        
        [data-theme="light"] .animated-bg {
            background: #ffffff !important;
        }
        
        [data-theme="light"] .animated-bg::before,
        [data-theme="light"] .animated-bg::after {
            border-color: rgba(13, 27, 42, 0.1);
        }
        
        [data-theme="light"] .particles {
            opacity: 0.3;
        }
        
        [data-theme="light"] .particle {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.4) 0%, transparent 70%);
        }
        
        /* Cards y contenedores en tema claro */
        [data-theme="light"] .glass,
        [data-theme="light"] .glass-card {
            background: rgba(13, 27, 42, 0.03) !important;
            border-color: rgba(13, 27, 42, 0.1) !important;
        }
        
        /* Textos en tema claro */
        [data-theme="light"] .text-white {
            color: #0d1b2a !important;
        }
        
        [data-theme="light"] .text-gray-400,
        [data-theme="light"] .text-gray-500 {
            color: #64748b !important;
        }
        
        [data-theme="light"] h1, 
        [data-theme="light"] h2, 
        [data-theme="light"] h3 {
            color: #0d1b2a !important;
        }
        
        /* Mantener colores de acento */
        [data-theme="light"] .text-yellow-400 {
            color: #d97706 !important;
        }
        
        [data-theme="light"] .text-green-400 {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .text-red-400 {
            color: #dc2626 !important;
        }
        
        [data-theme="light"] .text-blue-400 {
            color: #2563eb !important;
        }
        
        /* Botones y cards con fondo en tema claro */
        [data-theme="light"] .btn-3d,
        [data-theme="light"] button[style*="background: linear-gradient"] {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Secciones con fondo oscuro mantienen texto blanco */
        [data-theme="light"] [style*="background: linear-gradient(135deg, #1b263b"],
        [data-theme="light"] [style*="background: linear-gradient(135deg, #0d1b2a"] {
            color: white !important;
        }
        
        [data-theme="light"] [style*="background: linear-gradient(135deg, #1b263b"] .text-white,
        [data-theme="light"] [style*="background: linear-gradient(135deg, #0d1b2a"] .text-white,
        [data-theme="light"] [style*="background: linear-gradient(135deg, #1b263b"] h1,
        [data-theme="light"] [style*="background: linear-gradient(135deg, #1b263b"] h2,
        [data-theme="light"] [style*="background: linear-gradient(135deg, #1b263b"] h3 {
            color: white !important;
        }
        
        /* Inputs en tema claro */
        [data-theme="light"] select,
        [data-theme="light"] input {
            background-color: #f1f5f9 !important;
            border-color: #cbd5e1 !important;
            color: #0d1b2a !important;
        }
        
        [data-theme="light"] select option {
            background-color: #ffffff !important;
            color: #0d1b2a !important;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* ESTADÃSTICAS Y MÃ‰TRICAS                                        */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold-primary);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* TABLAS MODERNAS                                                */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .table-modern {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        
        .table-modern th {
            background: var(--navy-lighter);
            color: var(--gold-primary);
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .table-modern td {
            background: var(--navy-light);
            padding: 12px 16px;
            border: none;
        }
        
        .table-modern tr:hover td {
            background: var(--navy-lighter);
        }
        
        .table-modern tr td:first-child { border-radius: 8px 0 0 8px; }
        .table-modern tr td:last-child { border-radius: 0 8px 8px 0; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* RESPONSIVE                                                     */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .hero-section { padding: 20px 10px; }
            .stat-value { font-size: 1.5rem; }
        }

        /* Ocultar tema claro toggle - solo oscuro */
        .font-orbitron { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }
            bottom: 0;
            background: rgba(15, 15, 35, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #FFD700;
            border-right: 4px solid #F59E0B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 18px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideInRight 0.4s ease, fadeOut 0.4s ease 4.6s forwards;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .notification.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .notification.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .notification.value { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
        
        /* LOGO ANIMATION */
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .logo-icon {
            animation: logoFloat 3s ease-in-out infinite;
        }
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* PICKS CARDS */
        .pick-card {
            transition: all 0.3s ease;
        }
        .pick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .win-badge { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .loss-badge { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .pending-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        /* BEST PICKS HIGHLIGHT */
        .best-pick {
            position: relative;
            overflow: hidden;
        }
        .best-pick::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* BANKROLL STYLES */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stat-card-bankroll {
            background: linear-gradient(135deg, rgba(30, 27, 75, 0.8) 0%, rgba(49, 46, 129, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-card-bankroll:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 200, 255, 0.5);
        }
        
        .pick-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            border-radius: 12px;
            padding: 16px;
        }
        
        .pick-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(0, 200, 255, 0.3);
        }
        
        .win-badge { background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 4px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: 600; }
        .loss-badge { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 4px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: 600; }
        .pending-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 4px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen">
    <!-- FONDO ANIMADO PREMIUM -->
    <div class="animated-bg"></div>
    
    <!-- PARTÃCULAS FLOTANTES -->
    <div class="particles">
        <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
    </div>
    
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Cargando NioSports Pro...</div>
    </div>
    
    <!-- NOTIFICATIONS CONTAINER -->
    <div id="notificationContainer"></div>
    
    <div id="firebaseStatus" class="firebase-status firebase-loading">ğŸ”„ Conectando...</div>
    
    <!-- Theme Toggle -->
    <button id="themeToggle" onclick="toggleTheme()" class="fixed bottom-10 right-4 z-50 bg-white/10 hover:bg-white/20 backdrop-blur-sm p-2 rounded-full text-xl" title="Cambiar tema">
        ğŸŒ™
    </button>
    
    <div id="app"></div>
    
    <script>
// FunciÃ³n para cambiar tema
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    
    const btn = document.getElementById('themeToggle');
    btn.textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

// Cargar tema guardado
(function() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    setTimeout(() => {
        const btn = document.getElementById('themeToggle');
        if (btn) btn.textContent = saved === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    }, 100);
})();
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyCpddyEiWIE6VBe5u8JRPYBHlnYRMgljCs",
    authDomain: "niosports-pro.firebaseapp.com",
    databaseURL: "https://niosports-pro-default-rtdb.firebaseio.com",
    projectId: "niosports-pro",
    storageBucket: "niosports-pro.firebasestorage.app",
    messagingSenderId: "669355459084",
    appId: "1:669355459084:web:6c11965f3940bae9c8a429"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGO SVG - NUEVO DISEÃ‘O AZUL MARINO + DORADO + BASKETBALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LOGO_SVG = `
<svg class="logo-icon logo-glow" width="70" height="70" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="primaryGold" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#FFD700"/>
            <stop offset="50%" style="stop-color:#FFA500"/>
            <stop offset="100%" style="stop-color:#FF8C00"/>
        </linearGradient>
        <linearGradient id="accentBlue" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#1e3a8a"/>
            <stop offset="100%" style="stop-color:#0d1b2a"/>
        </linearGradient>
        <linearGradient id="glowGold" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#FFED4E; stop-opacity:0.8"/>
            <stop offset="100%" style="stop-color:#FFD700; stop-opacity:0.3"/>
        </linearGradient>
        <filter id="glow">
            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
            <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        <filter id="shadow">
            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000000" flood-opacity="0.5"/>
        </filter>
    </defs>
    <circle cx="50" cy="50" r="45" fill="url(#accentBlue)" filter="url(#shadow)"/>
    <circle cx="50" cy="50" r="42" fill="none" stroke="url(#primaryGold)" stroke-width="4" opacity="0.9" filter="url(#glow)"/>
    <g transform="translate(50, 50)">
        <polygon points="0,-25 21.65,-12.5 21.65,12.5 0,25 -21.65,12.5 -21.65,-12.5" 
                 fill="none" stroke="url(#primaryGold)" stroke-width="2.5" opacity="0.8"/>
        <polygon points="0,-18 15.59,-9 15.59,9 0,18 -15.59,9 -15.59,-9" 
                 fill="url(#glowGold)" opacity="0.3"/>
        <line x1="0" y1="-25" x2="0" y2="-18" stroke="url(#primaryGold)" stroke-width="2"/>
        <line x1="21.65" y1="-12.5" x2="15.59" y2="-9" stroke="url(#primaryGold)" stroke-width="2"/>
        <line x1="21.65" y1="12.5" x2="15.59" y2="9" stroke="url(#primaryGold)" stroke-width="2"/>
        <line x1="0" y1="25" x2="0" y2="18" stroke="url(#primaryGold)" stroke-width="2"/>
        <line x1="-21.65" y1="12.5" x2="-15.59" y2="9" stroke="url(#primaryGold)" stroke-width="2"/>
        <line x1="-21.65" y1="-12.5" x2="-15.59" y2="-9" stroke="url(#primaryGold)" stroke-width="2"/>
        <circle cx="0" cy="0" r="8" fill="url(#primaryGold)" opacity="0.9"/>
        <line x1="-8" y1="0" x2="8" y2="0" stroke="#0d1b2a" stroke-width="1.5"/>
        <line x1="0" y1="-8" x2="0" y2="8" stroke="#0d1b2a" stroke-width="1.5"/>
        <circle cx="0" cy="-22" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/></circle>
        <circle cx="19" cy="-11" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="0.3s" repeatCount="indefinite"/></circle>
        <circle cx="19" cy="11" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="0.6s" repeatCount="indefinite"/></circle>
        <circle cx="0" cy="22" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="0.9s" repeatCount="indefinite"/></circle>
        <circle cx="-19" cy="11" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="1.2s" repeatCount="indefinite"/></circle>
        <circle cx="-19" cy="-11" r="2" fill="#FFD700"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="1.5s" repeatCount="indefinite"/></circle>
    </g>
    <circle cx="15" cy="15" r="2" fill="#FFD700" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="85" cy="15" r="2" fill="#FFD700" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="0.5s" repeatCount="indefinite"/></circle>
    <circle cx="85" cy="85" r="2" fill="#FFD700" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="1s" repeatCount="indefinite"/></circle>
    <circle cx="15" cy="85" r="2" fill="#FFD700" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" begin="1.5s" repeatCount="indefinite"/></circle>
</svg>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM STATS - CARGA DINÃMICA DESDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NBA_STATS_API = 'https://nba-stats-api.joseluisgarciafonseca.workers.dev/';
let TEAM_STATS = {};
let statsLastUpdated = null;
let statsSource = 'Cargando...';
let apiConnected = false;

// Cargar estadÃ­sticas desde la API
async function loadTeamStatsFromAPI() {
    try {
        showLoading('Cargando estadÃ­sticas NBA...');
        const response = await fetch(NBA_STATS_API);
        const data = await response.json();
        
        if (data.teams && Object.keys(data.teams).length > 0) {
            TEAM_STATS = data.teams;
            statsLastUpdated = data.lastUpdated;
            statsSource = data.source || 'TeamRankings.com';
            apiConnected = true;
            
            // NUEVO: Cargar promedios de liga si vienen en la API
            if (data.leagueAverages) {
                LEAGUE_AVG = {
                    ...LEAGUE_AVG,
                    ...data.leagueAverages
                };
                // Debug: Promedios actualizados
            }
            
            // Calcular promedios de liga si no vienen en la API
            if (!data.leagueAverages) {
                let totalPace = 0, totalPpg = 0, count = 0;
                Object.values(TEAM_STATS).forEach(team => {
                    if (team.pace) { totalPace += team.pace; count++; }
                    if (team.full) totalPpg += team.full;
                });
                if (count > 0) {
                    LEAGUE_AVG.pace = totalPace / count;
                    LEAGUE_AVG.ppg = totalPpg / Object.keys(TEAM_STATS).length;
                }
            }
            
            // Mostrar si los datos vinieron del cachÃ©
            if (data.cached) {
                // Stats desde cachÃ©
            } else {
                // Stats actualizadas
            }
            
            // Mostrar versiÃ³n del modelo
            // Modelo v2.5 activo
            
            
            
            
            
            
            showNotification('ğŸ“Š Modelo v2.0 cargado correctamente', 'success');
        } else {
            throw new Error('No se recibieron datos de equipos');
        }
    } catch (error) {
        console.error('Error cargando stats:', error);
        apiConnected = false;
        showNotification('âš ï¸ Error cargando stats: usando datos de respaldo', 'warning');
        
        // âš ï¸ DATOS DE RESPALDO - SOLO PARA EMERGENCIAS
        // Si ves estos datos, significa que la API fallÃ³
        // Los datos HOME/AWAY pueden no ser precisos
        console.warn('âš ï¸ USANDO DATOS DE RESPALDO - API NO DISPONIBLE');
        showNotification('âš ï¸ API offline - usando datos de respaldo (pueden no ser precisos)', 'warning');
        
        TEAM_STATS = {
            "Nuggets": { fullHome: 122.7, fullAway: 117.5, full: 119.9, q1Home: 32.6, q1Away: 30.1, q1: 31.2, halfHome: 60.3, halfAway: 58.0, half: 59.2, pace: 101.5, oppPpg: 115.2, oppQ1: 28.5, oppHalf: 56.5 },
            "Thunder": { fullHome: 121.0, fullAway: 118.5, full: 120.1, q1Home: 31.3, q1Away: 30.6, q1: 31.1, halfHome: 59.8, halfAway: 58.8, half: 59.3, pace: 99.8, oppPpg: 106.5, oppQ1: 26.5, oppHalf: 53.0 },
            "Cavaliers": { fullHome: 122.5, fullAway: 119.0, full: 120.9, q1Home: 31.3, q1Away: 29.0, q1: 30.1, halfHome: 61.1, halfAway: 59.2, half: 60.2, pace: 98.2, oppPpg: 108.5, oppQ1: 27.0, oppHalf: 54.0 },
            "Celtics": { fullHome: 119.5, fullAway: 115.2, full: 117.6, q1Home: 31.4, q1Away: 30.0, q1: 30.9, halfHome: 59.4, halfAway: 58.7, half: 59.0, pace: 99.5, oppPpg: 109.8, oppQ1: 27.5, oppHalf: 55.0 },
            "Knicks": { fullHome: 118.8, fullAway: 114.5, full: 116.8, q1Home: 31.1, q1Away: 29.1, q1: 30.4, halfHome: 58.8, halfAway: 57.0, half: 58.0, pace: 98.5, oppPpg: 110.5, oppQ1: 27.5, oppHalf: 55.5 },
            "Grizzlies": { fullHome: 116.5, fullAway: 113.8, full: 115.2, q1Home: 28.9, q1Away: 28.6, q1: 28.7, halfHome: 57.0, halfAway: 56.2, half: 56.6, pace: 99.2, oppPpg: 113.8, oppQ1: 28.5, oppHalf: 57.0 },
            "Rockets": { fullHome: 115.0, fullAway: 113.5, full: 114.5, q1Home: 29.5, q1Away: 28.4, q1: 30.0, halfHome: 57.5, halfAway: 56.8, half: 57.2, pace: 99.2, oppPpg: 110.8, oppQ1: 27.5, oppHalf: 55.5 },
            "Lakers": { fullHome: 115.8, fullAway: 112.0, full: 114.0, q1Home: 30.9, q1Away: 28.2, q1: 29.5, halfHome: 58.0, halfAway: 55.5, half: 56.8, pace: 100.5, oppPpg: 114.5, oppQ1: 28.5, oppHalf: 57.0 },
            "Heat": { fullHome: 112.5, fullAway: 110.8, full: 111.5, q1Home: 28.9, q1Away: 27.8, q1: 28.4, halfHome: 55.5, halfAway: 54.8, half: 55.2, pace: 97.2, oppPpg: 111.5, oppQ1: 28.0, oppHalf: 56.0 },
            "Bucks": { fullHome: 114.5, fullAway: 109.8, full: 112.5, q1Home: 28.8, q1Away: 27.7, q1: 28.6, halfHome: 56.5, halfAway: 54.8, half: 55.8, pace: 99.2, oppPpg: 114.2, oppQ1: 28.5, oppHalf: 57.0 },
            "Warriors": { fullHome: 116.0, fullAway: 111.5, full: 114.1, q1Home: 27.1, q1Away: 26.0, q1: 26.5, halfHome: 56.8, halfAway: 52.7, half: 54.6, pace: 100.2, oppPpg: 113.5, oppQ1: 28.5, oppHalf: 57.0 },
            "Suns": { fullHome: 115.5, fullAway: 113.0, full: 114.3, q1Home: 27.8, q1Away: 29.6, q1: 28.7, halfHome: 57.0, halfAway: 56.5, half: 56.8, pace: 98.5, oppPpg: 115.2, oppQ1: 29.0, oppHalf: 57.5 },
            "Mavericks": { fullHome: 117.5, fullAway: 113.7, full: 115.5, q1Home: 28.2, q1Away: 28.2, q1: 28.2, halfHome: 57.2, halfAway: 57.0, half: 57.1, pace: 99.8, oppPpg: 112.8, oppQ1: 28.0, oppHalf: 56.5 },
            "Clippers": { fullHome: 114.0, fullAway: 110.5, full: 112.5, q1Home: 28.9, q1Away: 27.5, q1: 29.8, halfHome: 56.5, halfAway: 54.5, half: 55.5, pace: 97.5, oppPpg: 110.5, oppQ1: 27.5, oppHalf: 55.0 },
            "Kings": { fullHome: 115.5, fullAway: 118.0, full: 116.8, q1Home: 30.5, q1Away: 28.7, q1: 29.1, halfHome: 57.5, halfAway: 58.5, half: 58.0, pace: 101.2, oppPpg: 117.8, oppQ1: 29.5, oppHalf: 59.0 },
            "Pacers": { fullHome: 118.0, fullAway: 115.5, full: 116.8, q1Home: 28.9, q1Away: 28.8, q1: 28.9, halfHome: 57.5, halfAway: 57.0, half: 57.3, pace: 102.8, oppPpg: 119.5, oppQ1: 30.0, oppHalf: 60.0 },
            "76ers": { fullHome: 116.5, fullAway: 114.0, full: 115.5, q1Home: 30.9, q1Away: 27.5, q1: 30.8, halfHome: 58.5, halfAway: 56.5, half: 57.5, pace: 98.2, oppPpg: 115.8, oppQ1: 29.0, oppHalf: 58.0 },
            "Hawks": { fullHome: 117.0, fullAway: 116.5, full: 118.4, q1Home: 31.6, q1Away: 29.2, q1: 30.7, halfHome: 59.2, halfAway: 58.5, half: 59.9, pace: 101.5, oppPpg: 118.8, oppQ1: 29.5, oppHalf: 59.0 },
            "Bulls": { fullHome: 115.0, fullAway: 114.5, full: 117.1, q1Home: 28.0, q1Away: 28.3, q1: 29.3, halfHome: 56.5, halfAway: 56.2, half: 57.6, pace: 99.8, oppPpg: 116.2, oppQ1: 29.0, oppHalf: 58.0 },
            "Nets": { fullHome: 108.5, fullAway: 110.5, full: 109.5, q1Home: 27.3, q1Away: 27.7, q1: 27.5, halfHome: 53.5, halfAway: 55.0, half: 54.5, pace: 98.2, oppPpg: 117.2, oppQ1: 29.5, oppHalf: 58.5 },
            "Magic": { fullHome: 112.0, fullAway: 108.5, full: 110.5, q1Home: 28.0, q1Away: 27.1, q1: 29.9, halfHome: 55.0, halfAway: 53.0, half: 54.2, pace: 96.5, oppPpg: 106.5, oppQ1: 26.5, oppHalf: 53.0 },
            "Pistons": { fullHome: 113.0, fullAway: 110.5, full: 112.0, q1Home: 29.3, q1Away: 28.0, q1: 29.8, halfHome: 56.5, halfAway: 55.5, half: 56.0, pace: 100.2, oppPpg: 120.5, oppQ1: 30.0, oppHalf: 60.0 },
            "Raptors": { fullHome: 114.0, fullAway: 109.0, full: 111.5, q1Home: 29.2, q1Away: 27.3, q1: 28.8, halfHome: 56.5, halfAway: 54.0, half: 55.2, pace: 98.5, oppPpg: 118.5, oppQ1: 29.5, oppHalf: 59.0 },
            "Hornets": { fullHome: 108.5, fullAway: 107.0, full: 107.8, q1Home: 30.3, q1Away: 25.0, q1: 30.7, halfHome: 55.0, halfAway: 52.5, half: 53.7, pace: 101.8, oppPpg: 121.2, oppQ1: 30.5, oppHalf: 60.5 },
            "Wizards": { fullHome: 109.5, fullAway: 107.5, full: 108.5, q1Home: 29.1, q1Away: 27.5, q1: 29.4, halfHome: 54.5, halfAway: 53.5, half: 54.0, pace: 100.5, oppPpg: 122.5, oppQ1: 30.5, oppHalf: 61.0 },
            "Trail Blazers": { fullHome: 112.0, fullAway: 108.5, full: 110.5, q1Home: 29.4, q1Away: 26.5, q1: 29.6, halfHome: 56.0, halfAway: 53.5, half: 55.0, pace: 99.5, oppPpg: 119.2, oppQ1: 30.0, oppHalf: 59.5 },
            "Spurs": { fullHome: 112.5, fullAway: 110.0, full: 111.2, q1Home: 30.2, q1Away: 27.5, q1: 30.7, halfHome: 56.0, halfAway: 54.5, half: 55.3, pace: 101.2, oppPpg: 117.5, oppQ1: 29.5, oppHalf: 59.0 },
            "Jazz": { fullHome: 118.5, fullAway: 110.0, full: 114.5, q1Home: 33.4, q1Away: 24.3, q1: 29.3, halfHome: 60.0, halfAway: 52.5, half: 56.5, pace: 100.5, oppPpg: 119.8, oppQ1: 30.0, oppHalf: 60.0 },
            "Pelicans": { fullHome: 111.5, fullAway: 108.0, full: 109.8, q1Home: 30.5, q1Away: 26.4, q1: 28.8, halfHome: 55.5, halfAway: 53.0, half: 54.3, pace: 98.8, oppPpg: 116.5, oppQ1: 29.0, oppHalf: 58.0 },
            "Timberwolves": { fullHome: 114.0, fullAway: 111.5, full: 112.8, q1Home: 29.6, q1Away: 27.5, q1: 29.1, halfHome: 56.5, halfAway: 55.0, half: 55.8, pace: 98.8, oppPpg: 108.2, oppQ1: 27.0, oppHalf: 54.0 }
        };
        statsSource = 'âš ï¸ DATOS DE RESPALDO (API offline)';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VARIABLES DE ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let H2H_DATABASE = {};
let PICKS_DATABASE = {};
let VALUE_PICKS = []; // Picks de alto valor detectados automÃ¡ticamente
let BANKROLL_DATA = {
    dailyBanks: {},
    picks: [],
    settings: { alertThreshold: 20, initialBank: 0 }
};
let bankrollChart = null;
let filterPeriod = 'all';
let filterType = 'all';
let currentView = 'home';
let localTeam = '', visitingTeam = '';
let lineQ1 = '', lineHalf = '', lineFull = '';
let typeQ1 = 'OVER', typeHalf = 'OVER', typeFull = 'OVER';
// NUEVO: Variables para cuotas (odds decimales)
let oddsQ1 = '', oddsHalf = '', oddsFull = '';
// NUEVO: Variables para lÃ­nea Vegas (comparaciÃ³n)
let vegasLineQ1 = '', vegasLineHalf = '', vegasLineFull = '';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VARIABLES DE AJUSTE CONTEXTUAL v2.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let localB2B = false, awayB2B = false;
let localRestDays = 1, awayRestDays = 1;
let localInjury = false, awayInjury = false;
let localStreak = 0, awayStreak = 0;
let awayTravel = 'none';
let localScheduleDensity = 'normal', awayScheduleDensity = 'normal';
let isDivisionRivalry = false;
let gameDay = 'weekday';

// NUEVO: Cache para datos de API y auto-detecciÃ³n
let TEAM_SCHEDULE_CACHE = {};
let TEAM_GAMES_CACHE = {};
let autoDetectEnabled = true;

let ingestTeam1 = '', ingestTeam2 = '', ingestLocalTeam = '', ingestDate = '';
let ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
let firebaseConnected = false;
let isLoading = true;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES Y HELPERS v2.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Debounce para evitar over-rendering
let renderTimeout = null;
function debouncedRender(delay = 50) {
    if (renderTimeout) clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => render(), delay);
}

// Cache de cÃ¡lculos de tendencia
const TREND_CACHE = {};
function getCachedTrend(localTeam, awayTeam, period) {
    const key = `${localTeam}_${awayTeam}_${period}_${localB2B}_${awayB2B}_${localRestDays}_${awayRestDays}`;
    if (TREND_CACHE[key] && Date.now() - TREND_CACHE[key].time < 5000) {
        return TREND_CACHE[key].data;
    }
    return null;
}
function setCachedTrend(localTeam, awayTeam, period, data) {
    const key = `${localTeam}_${awayTeam}_${period}_${localB2B}_${awayB2B}_${localRestDays}_${awayRestDays}`;
    TREND_CACHE[key] = { data, time: Date.now() };
}

// Helper para obtener valor por perÃ­odo (evita cÃ³digo repetitivo)
function getByPeriod(period, values) {
    if (period === 'q1') return values.q1;
    if (period === 'half') return values.half;
    return values.full;
}

// Multiplicador por perÃ­odo
function getPeriodMultiplier(period) {
    if (period === 'q1') return 0.25;
    if (period === 'half') return 0.5;
    return 1;
}

// ParseFloat seguro con fallback
function safeParseFloat(value, fallback = 0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? fallback : parsed;
}

// ParseInt seguro con fallback
function safeParseInt(value, fallback = 0) {
    const parsed = parseInt(value);
    return isNaN(parsed) ? fallback : parsed;
}

// Formatear nÃºmero con decimales seguros
function safeFixed(value, decimals = 1) {
    const num = safeParseFloat(value);
    return num.toFixed(decimals);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING & NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(text = 'Cargando...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = overlay.querySelector('.loading-text');
    loadingText.textContent = text;
    overlay.classList.remove('hidden');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('hidden');
    isLoading = false;
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = message;
    container.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE DATABASE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateFirebaseStatus(status) {
    const el = document.getElementById('firebaseStatus');
    if (status === 'connected') {
        el.textContent = 'ğŸŸ¢ Firebase Conectado';
        el.className = 'firebase-status firebase-connected';
        firebaseConnected = true;
    } else if (status === 'disconnected') {
        el.textContent = 'ğŸ”´ Sin ConexiÃ³n';
        el.className = 'firebase-status firebase-disconnected';
        firebaseConnected = false;
    } else {
        el.textContent = 'ğŸ”„ Conectando...';
        el.className = 'firebase-status firebase-loading';
    }
}

// Listener de conexiÃ³n
database.ref('.info/connected').on('value', (snap) => {
    updateFirebaseStatus(snap.val() ? 'connected' : 'disconnected');
});

// Cargar datos de Firebase al iniciar
function loadH2HFromFirebase() {
    showLoading('Cargando datos H2H...');
    database.ref('h2h_games').on('value', (snapshot) => {
        if (snapshot.exists()) {
            H2H_DATABASE = snapshot.val();
        } else {
            H2H_DATABASE = {};
        }
        loadPicksFromFirebase();
    }, (error) => {
        console.error('Error cargando datos:', error);
        updateFirebaseStatus('disconnected');
        hideLoading();
    });
}

// Cargar picks de Firebase
function loadPicksFromFirebase() {
    showLoading('Cargando historial de picks...');
    database.ref('picks').on('value', (snapshot) => {
        if (snapshot.exists()) {
            PICKS_DATABASE = snapshot.val();
        } else {
            PICKS_DATABASE = {};
        }
        hideLoading();
        render();
        checkForValuePicks();
    }, (error) => {
        console.error('Error cargando picks:', error);
        hideLoading();
        render();
    });
}

// Guardar H2H en Firebase
function saveH2HToFirebase() {
    showLoading('Guardando en Firebase...');
    database.ref('h2h_games').set(H2H_DATABASE)
        .then(() => {
            
            hideLoading();
            showNotification('âœ… Partido guardado correctamente', 'success');
        })
        .catch((error) => {
            console.error('Error guardando:', error);
            hideLoading();
            showNotification('âŒ Error guardando: ' + error.message, 'warning');
        });
}

// Guardar picks en Firebase
function savePicksToFirebase() {
    database.ref('picks').set(PICKS_DATABASE)
        
        .catch((error) => console.error('Error guardando picks:', error));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES H2H DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getH2HKey(t1, t2) { return [t1, t2].sort().join('_'); }

function addH2HGame(t1, t2, data) { 
    const k = getH2HKey(t1, t2); 
    if (!H2H_DATABASE[k]) H2H_DATABASE[k] = []; 
    H2H_DATABASE[k].unshift(data); 
    saveH2HToFirebase();
}

function deleteH2HGame(t1, t2, idx) { 
    const k = getH2HKey(t1, t2); 
    if (H2H_DATABASE[k]) { 
        H2H_DATABASE[k].splice(idx, 1); 
        if (H2H_DATABASE[k].length === 0) delete H2H_DATABASE[k]; 
        saveH2HToFirebase();
    } 
}

function getH2HData(team1, team2) {
    const k = getH2HKey(team1, team2), games = H2H_DATABASE[k] || [];
    if (games.length === 0) return null;
    let t1W = 0, t2W = 0, t1Pts = 0, t2Pts = 0;
    const proc = games.slice(0, 10).map(g => {
        const isT1L = g.localTeam === team1;
        const t1Q1 = isT1L ? g.localQ1 : g.awayQ1, t1Q2 = isT1L ? g.localQ2 : g.awayQ2;
        const t1Q3 = isT1L ? g.localQ3 : g.awayQ3, t1Q4 = isT1L ? g.localQ4 : g.awayQ4;
        const t2Q1 = isT1L ? g.awayQ1 : g.localQ1, t2Q2 = isT1L ? g.awayQ2 : g.localQ2;
        const t2Q3 = isT1L ? g.awayQ3 : g.localQ3, t2Q4 = isT1L ? g.awayQ4 : g.localQ4;
        const t1OT = isT1L ? ((g.localOT1||0)+(g.localOT2||0)+(g.localOT3||0)) : ((g.awayOT1||0)+(g.awayOT2||0)+(g.awayOT3||0));
        const t2OT = isT1L ? ((g.awayOT1||0)+(g.awayOT2||0)+(g.awayOT3||0)) : ((g.localOT1||0)+(g.localOT2||0)+(g.localOT3||0));
        const t1T = t1Q1+t1Q2+t1Q3+t1Q4+t1OT, t2T = t2Q1+t2Q2+t2Q3+t2Q4+t2OT;
        t1Pts += t1T; t2Pts += t2T;
        if (t1T > t2T) t1W++; else t2W++;
        return { date: g.date, localTeam: g.localTeam, awayTeam: g.awayTeam, t1Q1, t1Q2, t1Q3, t1Q4, t2Q1, t2Q2, t2Q3, t2Q4, t1Half: t1Q1+t1Q2, t2Half: t2Q1+t2Q2, t1Total: t1T, t2Total: t2T, totalPts: t1T+t2T, winner: t1T>t2T ? team1 : team2, overtimes: g.overtimes||0 };
    });
    const n = proc.length;
    return {
        team1, team2,
        record: { team1Wins: t1W, team2Wins: t2W },
        avgPts: { team1: n ? t1Pts/n : 0, team2: n ? t2Pts/n : 0 },
        avgQ1: { team1: n ? proc.reduce((s,g) => s+g.t1Q1, 0)/n : 0, team2: n ? proc.reduce((s,g) => s+g.t2Q1, 0)/n : 0 },
        avgHalf: { team1: n ? proc.reduce((s,g) => s+g.t1Half, 0)/n : 0, team2: n ? proc.reduce((s,g) => s+g.t2Half, 0)/n : 0 },
        games: proc,
        totalGames: games.length
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKS TRACKING SYSTEM v2.0 - CON BACKTESTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPick(pickData) {
    const pickId = Date.now().toString();
    
    // Obtener tendencia del modelo para backtesting
    let modelTrend = null;
    if (pickData.localTeam && pickData.awayTeam) {
        const advancedData = getAdvancedTrends(pickData.localTeam, pickData.awayTeam);
        if (advancedData) {
            if (pickData.period === '1Q') modelTrend = advancedData.q1;
            else if (pickData.period === '1H') modelTrend = advancedData.half;
            else if (pickData.period === 'FULL') modelTrend = advancedData.full;
        }
    }
    
    PICKS_DATABASE[pickId] = {
        ...pickData,
        id: pickId,
        createdAt: new Date().toISOString(),
        status: 'pending', // pending, win, loss, push
        modelTrend: modelTrend, // Guardar predicciÃ³n del modelo
        actualTotal: null, // Se llena despuÃ©s con el resultado real
        vegasLine: pickData.vegasLine || null // LÃ­nea de Vegas para comparaciÃ³n
    };
    savePicksToFirebase();
    showNotification('ğŸ“ Pick registrado correctamente', 'success');
    render();
}

// Registrar resultado real del partido (para backtesting)
function registerActualResult(pickId) {
    const pick = PICKS_DATABASE[pickId];
    if (!pick) return;
    
    const actualTotal = prompt(`Ingresa el total REAL del ${pick.period}:\n(Tu predicciÃ³n: ${pick.modelTrend || 'N/A'}, LÃ­nea: ${pick.line})`);
    if (actualTotal === null) return;
    
    const actual = parseFloat(actualTotal);
    if (isNaN(actual) || actual < 0) {
        showNotification('âš ï¸ Ingresa un nÃºmero vÃ¡lido', 'warning');
        return;
    }
    
    PICKS_DATABASE[pickId].actualTotal = actual;
    
    // Determinar resultado automÃ¡ticamente
    const line = parseFloat(pick.line);
    if (actual === line) {
        PICKS_DATABASE[pickId].status = 'push';
    } else if (pick.betType === 'OVER') {
        PICKS_DATABASE[pickId].status = actual > line ? 'win' : 'loss';
    } else {
        PICKS_DATABASE[pickId].status = actual < line ? 'win' : 'loss';
    }
    
    PICKS_DATABASE[pickId].resolvedAt = new Date().toISOString();
    
    // Calcular precisiÃ³n del modelo
    const modelError = pick.modelTrend ? Math.abs(actual - pick.modelTrend) : null;
    PICKS_DATABASE[pickId].modelError = modelError;
    
    savePicksToFirebase();
    
    const status = PICKS_DATABASE[pickId].status;
    const emoji = status === 'win' ? 'âœ…' : status === 'push' ? 'â†”ï¸' : 'âŒ';
    showNotification(`${emoji} Resultado registrado: ${actual} pts (${status.toUpperCase()})`, status === 'win' ? 'success' : 'info');
    render();
}

function updatePickResult(pickId, result) {
    if (PICKS_DATABASE[pickId]) {
        PICKS_DATABASE[pickId].status = result;
        PICKS_DATABASE[pickId].resolvedAt = new Date().toISOString();
        savePicksToFirebase();
        showNotification(result === 'win' ? 'âœ… Â¡Pick ganado!' : result === 'push' ? 'â†”ï¸ Push' : 'âŒ Pick perdido', result === 'win' ? 'success' : 'warning');
        render();
    }
}

function deletePick(pickId) {
    if (PICKS_DATABASE[pickId]) {
        delete PICKS_DATABASE[pickId];
        savePicksToFirebase();
        showNotification('ğŸ—‘ï¸ Pick eliminado', 'info');
        render();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKTESTING & CALIBRACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calcular estadÃ­sticas de precisiÃ³n del modelo
function getBacktestStats() {
    const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending' && p.modelTrend);
    
    if (picks.length === 0) return null;
    
    // Stats por perÃ­odo
    const byPeriod = { '1Q': { wins: 0, losses: 0, pushes: 0, totalError: 0, count: 0 },
                       '1H': { wins: 0, losses: 0, pushes: 0, totalError: 0, count: 0 },
                       'FULL': { wins: 0, losses: 0, pushes: 0, totalError: 0, count: 0 } };
    
    // Stats por rango de probabilidad (para calibraciÃ³n)
    const byProbRange = {
        '50-60': { predicted: 0, actual: 0, count: 0 },
        '60-70': { predicted: 0, actual: 0, count: 0 },
        '70-80': { predicted: 0, actual: 0, count: 0 },
        '80-90': { predicted: 0, actual: 0, count: 0 },
        '90-100': { predicted: 0, actual: 0, count: 0 }
    };
    
    let totalWins = 0, totalLosses = 0, totalPushes = 0;
    let totalModelError = 0, modelErrorCount = 0;
    let totalProfit = 0;
    
    picks.forEach(pick => {
        const period = pick.period;
        if (byPeriod[period]) {
            if (pick.status === 'win') { byPeriod[period].wins++; totalWins++; }
            else if (pick.status === 'loss') { byPeriod[period].losses++; totalLosses++; }
            else if (pick.status === 'push') { byPeriod[period].pushes++; totalPushes++; }
            
            if (pick.modelError !== null && pick.modelError !== undefined) {
                byPeriod[period].totalError += pick.modelError;
                byPeriod[period].count++;
                totalModelError += pick.modelError;
                modelErrorCount++;
            }
        }
        
        // CalibraciÃ³n por rango de probabilidad
        const prob = pick.probability;
        let range = null;
        if (prob >= 50 && prob < 60) range = '50-60';
        else if (prob >= 60 && prob < 70) range = '60-70';
        else if (prob >= 70 && prob < 80) range = '70-80';
        else if (prob >= 80 && prob < 90) range = '80-90';
        else if (prob >= 90) range = '90-100';
        
        if (range && byProbRange[range]) {
            byProbRange[range].predicted += prob;
            byProbRange[range].actual += (pick.status === 'win' ? 100 : 0);
            byProbRange[range].count++;
        }
        
        // Profit
        if (pick.odds) {
            if (pick.status === 'win') totalProfit += (pick.odds - 1);
            else if (pick.status === 'loss') totalProfit -= 1;
        }
    });
    
    // Calcular hit rates
    const totalDecided = totalWins + totalLosses;
    const overallHitRate = totalDecided > 0 ? (totalWins / totalDecided * 100) : 0;
    
    // Calcular calibraciÃ³n
    const calibrationData = Object.entries(byProbRange)
        .filter(([_, data]) => data.count >= 3) // MÃ­nimo 3 picks por rango
        .map(([range, data]) => ({
            range,
            avgPredicted: data.predicted / data.count,
            actualHitRate: data.actual / data.count,
            count: data.count
        }));
    
    return {
        totalPicks: picks.length,
        totalWins,
        totalLosses,
        totalPushes,
        overallHitRate: overallHitRate.toFixed(1),
        avgModelError: modelErrorCount > 0 ? (totalModelError / modelErrorCount).toFixed(1) : null,
        totalProfit: totalProfit.toFixed(2),
        roi: totalDecided > 0 ? ((totalProfit / totalDecided) * 100).toFixed(1) : 0,
        byPeriod: Object.entries(byPeriod).map(([period, data]) => ({
            period,
            wins: data.wins,
            losses: data.losses,
            pushes: data.pushes,
            hitRate: (data.wins + data.losses) > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(1) : '-',
            avgError: data.count > 0 ? (data.totalError / data.count).toFixed(1) : '-'
        })),
        calibration: calibrationData,
        isCalibrated: calibrationData.length >= 2
    };
}

// Exportar picks a CSV
function exportPicksToCSV() {
    const picks = Object.values(PICKS_DATABASE);
    if (picks.length === 0) {
        showNotification('âš ï¸ No hay picks para exportar', 'warning');
        return;
    }
    
    const headers = ['Fecha', 'Local', 'Visitante', 'PerÃ­odo', 'Tipo', 'LÃ­nea', 'Prob%', 'Cuota', 'EV%', 'PredicciÃ³n', 'Resultado Real', 'Status', 'Profit'];
    
    const rows = picks.map(p => [
        new Date(p.createdAt).toLocaleDateString('es-ES'),
        p.localTeam || '',
        p.awayTeam || '',
        p.period || '',
        p.betType || '',
        p.line || '',
        p.probability || '',
        p.odds || '',
        p.ev || '',
        p.modelTrend || '',
        p.actualTotal || '',
        p.status || '',
        p.status === 'win' && p.odds ? (p.odds - 1).toFixed(2) : p.status === 'loss' ? '-1.00' : '0'
    ]);
    
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `niosports_picks_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    showNotification('ğŸ“¥ CSV exportado correctamente', 'success');
}

// Agregar lÃ­nea de cierre para CLV
function addClosingLine(pickId, originalLine) {
    const closingLine = prompt(`LÃ­nea de cierre para este pick:\n(LÃ­nea original: ${originalLine})`);
    if (closingLine === null) return;
    
    const closing = parseFloat(closingLine);
    if (isNaN(closing)) {
        showNotification('âš ï¸ Ingresa un nÃºmero vÃ¡lido', 'warning');
        return;
    }
    
    if (PICKS_DATABASE[pickId]) {
        PICKS_DATABASE[pickId].closingLine = closing;
        savePicksToFirebase();
        
        const original = parseFloat(originalLine);
        const pick = PICKS_DATABASE[pickId];
        const clv = pick.betType === 'OVER' 
            ? (closing - original).toFixed(1)
            : (original - closing).toFixed(1);
        
        const clvText = parseFloat(clv) >= 0 ? `+${clv}` : clv;
        showNotification(`ğŸ¯ CLV registrado: ${clvText} puntos`, parseFloat(clv) >= 0 ? 'success' : 'info');
        render();
    }
}

function getPicksStats() {
    const picks = Object.values(PICKS_DATABASE);
    const total = picks.length;
    const wins = picks.filter(p => p.status === 'win').length;
    const losses = picks.filter(p => p.status === 'loss').length;
    const pending = picks.filter(p => p.status === 'pending').length;
    const resolved = wins + losses;
    const winRate = resolved > 0 ? ((wins / resolved) * 100).toFixed(1) : 0;
    
    // Stats por tipo de apuesta
    const byType = {};
    picks.forEach(p => {
        const key = `${p.period}_${p.betType}`;
        if (!byType[key]) byType[key] = { wins: 0, losses: 0, total: 0, profit: 0 };
        byType[key].total++;
        if (p.status === 'win') {
            byType[key].wins++;
            byType[key].profit += p.odds ? (parseFloat(p.odds) - 1) : 0;
        }
        if (p.status === 'loss') {
            byType[key].losses++;
            byType[key].profit -= 1;
        }
    });
    
    // Stats por perÃ­odo (1Q, 1H, FULL)
    const byPeriod = { '1Q': { wins: 0, losses: 0, total: 0, profit: 0 }, '1H': { wins: 0, losses: 0, total: 0, profit: 0 }, 'FULL': { wins: 0, losses: 0, total: 0, profit: 0 } };
    picks.forEach(p => {
        if (byPeriod[p.period]) {
            byPeriod[p.period].total++;
            if (p.status === 'win') {
                byPeriod[p.period].wins++;
                byPeriod[p.period].profit += p.odds ? (parseFloat(p.odds) - 1) : 0;
            }
            if (p.status === 'loss') {
                byPeriod[p.period].losses++;
                byPeriod[p.period].profit -= 1;
            }
        }
    });
    
    // Stats por equipo
    const byTeam = {};
    picks.forEach(p => {
        [p.localTeam, p.awayTeam].forEach(team => {
            if (!byTeam[team]) byTeam[team] = { wins: 0, losses: 0, total: 0 };
            byTeam[team].total++;
            if (p.status === 'win') byTeam[team].wins++;
            if (p.status === 'loss') byTeam[team].losses++;
        });
    });
    
    // Profit/Loss calculation
    let profit = 0;
    let totalStaked = 0;
    picks.forEach(p => {
        if (p.status === 'win' && p.odds) {
            profit += (parseFloat(p.odds) - 1);
            totalStaked += 1;
        } else if (p.status === 'loss') {
            profit -= 1;
            totalStaked += 1;
        }
    });
    
    // ROI calculation
    const roi = totalStaked > 0 ? ((profit / totalStaked) * 100).toFixed(1) : 0;
    
    // Racha actual (streak)
    const sortedPicks = picks
        .filter(p => p.status !== 'pending')
        .sort((a, b) => new Date(b.resolvedAt || b.createdAt) - new Date(a.resolvedAt || a.createdAt));
    
    let streak = 0;
    let streakType = null;
    for (const pick of sortedPicks) {
        if (streakType === null) {
            streakType = pick.status;
            streak = 1;
        } else if (pick.status === streakType) {
            streak++;
        } else {
            break;
        }
    }
    
    // Mejor y peor racha histÃ³rica
    let currentStreak = 0;
    let currentType = null;
    let bestWinStreak = 0;
    let worstLossStreak = 0;
    
    const chronologicalPicks = [...sortedPicks].reverse();
    chronologicalPicks.forEach(p => {
        if (currentType === p.status) {
            currentStreak++;
        } else {
            currentType = p.status;
            currentStreak = 1;
        }
        if (p.status === 'win' && currentStreak > bestWinStreak) bestWinStreak = currentStreak;
        if (p.status === 'loss' && currentStreak > worstLossStreak) worstLossStreak = currentStreak;
    });
    
    return { 
        total, wins, losses, pending, winRate, byType, byTeam, byPeriod,
        profit: profit.toFixed(2), 
        roi,
        streak: { count: streak, type: streakType },
        bestWinStreak,
        worstLossStreak
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEST PICKS ALGORITHM v2.0 - CON MODELO AVANZADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBestPicks() {
    const teams = getTeams();
    const bestPicks = [];
    
    // Analizar todos los matchups posibles
    teams.forEach(local => {
        teams.forEach(away => {
            if (local === away) return;
            
            const lD = TEAM_STATS[local];
            const vD = TEAM_STATS[away];
            
            if (!lD || !vD) return;
            
            // USAR MODELO AVANZADO v2.0
            const advancedData = getAdvancedTrends(local, away);
            
            const trends = advancedData ? {
                q1: advancedData.q1,
                half: advancedData.half,
                full: advancedData.full
            } : {
                q1: lD.q1Home + vD.q1Away,
                half: lD.halfHome + vD.halfAway,
                full: lD.fullHome + vD.fullAway
            };
            
            // H2H data
            const h2h = getH2HData(local, away);
            
            // Analizar cada perÃ­odo
            ['q1', 'half', 'full'].forEach(period => {
                const trend = trends[period];
                const periodLabel = period === 'q1' ? '1Q' : period === 'half' ? '1H' : 'FULL';
                
                // LÃ­neas sugeridas basadas en tendencia
                const suggestedLine = Math.round(trend * 2) / 2;
                
                // Calcular probabilidad OVER con modelo avanzado
                const probOver = calcProb(trend.toString(), suggestedLine.toString(), 'OVER', {
                    combinedPace: advancedData ? advancedData.combinedPace : LEAGUE_AVG.pace
                });
                
                if (probOver && probOver >= 60) {
                    let confidence = probOver;
                    let reason = `Tendencia v2.0: ${trend.toFixed(1)}`;
                    
                    // Agregar info del modelo
                    if (advancedData && advancedData.components[period]) {
                        const comp = advancedData.components[period];
                        if (comp.altitude) reason += ` | ğŸ”ï¸ Altitud +${comp.altitude}`;
                        if (comp.earlySeason) reason += ` | âš ï¸ Early Season`;
                    }
                    
                    // Bonus por H2H
                    if (h2h && h2h.games.length >= 3) {
                        const h2hAvg = period === 'q1' 
                            ? h2h.avgQ1.team1 + h2h.avgQ1.team2
                            : period === 'half'
                            ? h2h.avgHalf.team1 + h2h.avgHalf.team2
                            : h2h.avgPts.team1 + h2h.avgPts.team2;
                        
                        if (h2hAvg > suggestedLine) {
                            confidence += 5;
                            reason += ` | H2H: ${h2hAvg.toFixed(1)}`;
                        }
                    }
                    
                    // Reducir confianza si hay warnings
                    if (advancedData && advancedData.warnings.length > 0) {
                        confidence -= advancedData.warnings.length * 3;
                    }
                    
                    bestPicks.push({
                        local,
                        away,
                        period: periodLabel,
                        betType: 'OVER',
                        line: suggestedLine,
                        trend: trend.toFixed(1),
                        confidence: Math.min(Math.max(confidence, 50), 95),
                        reason,
                        h2hGames: h2h ? h2h.games.length : 0,
                        modelVersion: '2.0'
                    });
                }
            });
        });
    });
    
    // Ordenar por confianza y retornar top 5
    return bestPicks.sort((a, b) => b.confidence - a.confidence).slice(0, 5);
}

function checkForValuePicks() {
    if (!localTeam || !visitingTeam) return;
    
    const lD = TEAM_STATS[localTeam];
    const vD = TEAM_STATS[visitingTeam];
    
    if (!lD || !vD) return;
    
    // USAR MODELO AVANZADO v2.0
    const advancedData = getAdvancedTrends(localTeam, visitingTeam);
    
    const trends = advancedData ? {
        q1: advancedData.q1.toFixed(1),
        half: advancedData.half.toFixed(1),
        full: advancedData.full.toFixed(1)
    } : {
        // Fallback al mÃ©todo simple si falla
        q1: (lD.q1Home + vD.q1Away).toFixed(1),
        half: (lD.halfHome + vD.halfAway).toFixed(1),
        full: (lD.fullHome + vD.fullAway).toFixed(1)
    };
    
    // Mostrar warnings del modelo si existen
    if (advancedData && advancedData.warnings.length > 0) {
        
    }
    
    // Obtener odds actuales
    const oddsMap = {
        '1Q': oddsQ1,
        '1H': oddsHalf,
        'FULL': oddsFull
    };
    
    // Verificar si hay valores altos
    [
        { period: '1Q', trend: trends.q1, line: lineQ1, type: typeQ1 },
        { period: '1H', trend: trends.half, line: lineHalf, type: typeHalf },
        { period: 'FULL', trend: trends.full, line: lineFull, type: typeFull }
    ].forEach(({ period, trend, line, type }) => {
        if (line) {
            const prob = calcProb(trend, line, type);
            const odds = oddsMap[period];
            const ev = odds ? calcEV(prob, odds) : null;
            
            if (prob && prob >= 75) {
                showNotification(`ğŸ”¥ VALOR ALTO en ${period}: ${prob}% ${type} ${line}`, 'value');
                
                // Guardar automÃ¡ticamente en VALUE_PICKS
                addValuePick({
                    id: `${localTeam}-${visitingTeam}-${period}-${type}-${line}-${Date.now()}`,
                    local: localTeam,
                    away: visitingTeam,
                    period,
                    betType: type,
                    line: parseFloat(line),
                    trend: parseFloat(trend),
                    probability: prob,
                    odds: odds ? parseFloat(odds) : null,
                    ev: ev,
                    detectedAt: new Date().toISOString()
                });
            }
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE VALUE PICKS (Picks de Alto Valor Detectados)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addValuePick(pick) {
    // Verificar si ya existe un pick similar (mismo matchup, periodo, tipo, lÃ­nea)
    const exists = VALUE_PICKS.some(p => 
        p.local === pick.local && 
        p.away === pick.away && 
        p.period === pick.period && 
        p.betType === pick.betType && 
        p.line === pick.line
    );
    
    if (!exists) {
        VALUE_PICKS.unshift(pick); // Agregar al inicio
        // Mantener mÃ¡ximo 20 picks
        if (VALUE_PICKS.length > 20) {
            VALUE_PICKS = VALUE_PICKS.slice(0, 20);
        }
        saveValuePicksToStorage();
    }
}

function removeValuePick(pickId) {
    VALUE_PICKS = VALUE_PICKS.filter(p => p.id !== pickId);
    saveValuePicksToStorage();
    render();
    showNotification('ğŸ—‘ï¸ Pick descartado', 'info');
}

function registerFromValuePick(pickId) {
    const pick = VALUE_PICKS.find(p => p.id === pickId);
    if (!pick) return;
    
    let odds = pick.odds;
    
    // Si no hay cuota, pedirla
    if (!odds || odds <= 1) {
        const oddsInput = prompt(`Ingresa la cuota para ${pick.period} ${pick.betType} ${pick.line}:`);
        if (oddsInput === null) return;
        odds = parseFloat(oddsInput) || null;
        if (!odds || odds <= 1) {
            showNotification('âš ï¸ Cuota invÃ¡lida', 'warning');
            return;
        }
    }
    
    const ev = calcEV(pick.probability, odds);
    
    addPick({
        localTeam: pick.local,
        awayTeam: pick.away,
        period: pick.period,
        betType: pick.betType,
        line: pick.line,
        probability: pick.probability,
        odds: odds,
        ev: ev
    });
    
    // Remover de VALUE_PICKS despuÃ©s de registrar
    removeValuePick(pickId);
    showNotification(`âœ… Pick registrado: ${pick.period} ${pick.betType} ${pick.line}`, 'success');
}

function analyzeFromValuePick(pickId) {
    const pick = VALUE_PICKS.find(p => p.id === pickId);
    if (!pick) return;
    
    // Configurar el matchup
    localTeam = pick.local;
    visitingTeam = pick.away;
    
    // Configurar lÃ­nea y tipo segÃºn el perÃ­odo
    if (pick.period === '1Q') {
        lineQ1 = pick.line.toString();
        typeQ1 = pick.betType;
        if (pick.odds) oddsQ1 = pick.odds.toString();
    } else if (pick.period === '1H') {
        lineHalf = pick.line.toString();
        typeHalf = pick.betType;
        if (pick.odds) oddsHalf = pick.odds.toString();
    } else if (pick.period === 'FULL') {
        lineFull = pick.line.toString();
        typeFull = pick.betType;
        if (pick.odds) oddsFull = pick.odds.toString();
    }
    
    navigateTo('tendencia');
}

function clearAllValuePicks() {
    if (confirm('Â¿Eliminar todos los picks de valor detectados?')) {
        VALUE_PICKS = [];
        saveValuePicksToStorage();
        render();
        showNotification('ğŸ—‘ï¸ Todos los picks eliminados', 'info');
    }
}

// Guardar VALUE_PICKS en localStorage
function saveValuePicksToStorage() {
    try {
        localStorage.setItem('niosports_value_picks', JSON.stringify(VALUE_PICKS));
    } catch (e) {
        console.warn('No se pudo guardar VALUE_PICKS:', e);
    }
}

// Cargar VALUE_PICKS desde localStorage
function loadValuePicksFromStorage() {
    try {
        const saved = localStorage.getItem('niosports_value_picks');
        if (saved) {
            VALUE_PICKS = JSON.parse(saved);
            // Filtrar picks de mÃ¡s de 24 horas
            const now = new Date();
            VALUE_PICKS = VALUE_PICKS.filter(p => {
                const detected = new Date(p.detectedAt);
                const hoursDiff = (now - detected) / (1000 * 60 * 60);
                return hoursDiff < 24;
            });
            saveValuePicksToStorage();
        }
    } catch (e) {
        console.warn('No se pudo cargar VALUE_PICKS:', e);
        VALUE_PICKS = [];
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTeams() { return Object.keys(TEAM_STATS).sort(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE RANKINGS - PosiciÃ³n de cada equipo en PPG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Calcular ranking de un equipo en una estadÃ­stica especÃ­fica
function getTeamRanking(teamName, stat) {
    const teams = Object.entries(TEAM_STATS);
    if (teams.length === 0) return null;
    
    // Ordenar equipos por la estadÃ­stica (mayor a menor)
    const sorted = teams
        .filter(([name, data]) => data[stat] !== undefined)
        .sort((a, b) => b[1][stat] - a[1][stat]);
    
    // Encontrar posiciÃ³n del equipo (1-indexed)
    const index = sorted.findIndex(([name]) => name === teamName);
    return index >= 0 ? index + 1 : null;
}

// Obtener todos los rankings de un equipo
function getAllTeamRankings(teamName) {
    const stats = TEAM_STATS[teamName];
    if (!stats) return null;
    
    return {
        full: getTeamRanking(teamName, 'full'),
        fullHome: getTeamRanking(teamName, 'fullHome'),
        fullAway: getTeamRanking(teamName, 'fullAway'),
        half: getTeamRanking(teamName, 'half'),
        halfHome: getTeamRanking(teamName, 'halfHome'),
        halfAway: getTeamRanking(teamName, 'halfAway'),
        q1: getTeamRanking(teamName, 'q1'),
        q1Home: getTeamRanking(teamName, 'q1Home'),
        q1Away: getTeamRanking(teamName, 'q1Away'),
        // Nuevas stats
        pace: getTeamRanking(teamName, 'pace'),
        oppPpg: getTeamRanking(teamName, 'oppPpg')
    };
}

// Formatear ranking con color segÃºn posiciÃ³n
function formatRanking(rank, inverse = false) {
    if (!rank) return '';
    
    // Para stats defensivas, menor rank = mejor (inverse = true)
    let colorClass = '';
    if (inverse) {
        // Inverso: #1 = mejor defensa (permite menos puntos)
        if (rank <= 10) colorClass = 'text-green-400';
        else if (rank <= 20) colorClass = 'text-yellow-400';
        else colorClass = 'text-red-400';
    } else {
        // Normal: #1 = mÃ¡s puntos
        if (rank <= 10) colorClass = 'text-green-400';
        else if (rank <= 20) colorClass = 'text-yellow-400';
        else colorClass = 'text-red-400';
    }
    
    return `<span class="${colorClass} text-sm font-black">#${rank}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NIOSPORTS PRO v2.5 FINAL - MODELO PREDICTIVO AVANZADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Basado en investigaciÃ³n acadÃ©mica y mejores prÃ¡cticas:
// - XGBoost/SHAP studies (PLOS ONE 2024)
// - Bayesian modeling (icSPORTS 2023)
// - FiveThirtyEight methodology
// - Walsh & Joshi calibration research (2024)
// Paper: "Random Walk Picture of Basketball Scoring"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Promedios de liga para normalizaciÃ³n (se actualizan desde API)
let LEAGUE_AVG = {
    pace: 100.0,    // Posesiones por juego promedio NBA
    ppg: 115.0,     // Puntos por juego promedio NBA
    q1: 29.0,       // Q1 promedio
    half: 57.0      // 1H promedio
};

// Desviaciones estÃ¡ndar BASE calibradas para TOTALES COMBINADOS
const NBA_STD_DEVS = {
    Q1: 8.0,    // 1er Cuarto: ~7-9 puntos SD
    HALF: 13.0, // 1era Mitad: ~12-14 puntos SD
    FULL: 18.5  // Partido Completo: ~17-20 puntos SD
};

// Home Court Advantage en puntos (promedio NBA actual ~2.5-3.0)
const HOME_COURT_ADVANTAGE = {
    full: 2.5,      // Ventaja de local en partido completo
    half: 1.25,     // Proporcionalmente en 1H
    q1: 0.6         // Proporcionalmente en Q1
};

// Equipos con ventaja de altitud significativa
const ALTITUDE_TEAMS = {
    'Nuggets': 2.5,  // Denver: 5,280 pies - mayor ventaja
    'Jazz': 1.0      // Utah: 4,226 pies - ventaja menor
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACTORES DE AJUSTE DEL MODELO v2.5 FINAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Back-to-Back penalty (-1.25 pts)
const B2B_PENALTY = { full: -1.25, half: -0.6, q1: -0.3 };

// Rest Days bonus (+0.5 a +1.5 pts)
const REST_BONUS = {
    full: { days3plus: 1.5, days2: 0.5 },
    half: { days3plus: 0.75, days2: 0.25 },
    q1: { days3plus: 0.4, days2: 0.1 }
};

// Injury penalty (-3.5 pts por estrella)
const INJURY_PENALTY = { full: -3.5, half: -1.75, q1: -0.9 };

// Streak factor (Â±0.25 pts por partido, max Â±5)
const STREAK_FACTOR = { full: 0.25, half: 0.12, q1: 0.06 };

// Travel/Timezone factor (viajes largos afectan rendimiento)
const TRAVEL_PENALTY = {
    crossCountry: { full: -1.0, half: -0.5, q1: -0.25 },  // Costa a Costa (3+ zonas)
    moderate: { full: -0.5, half: -0.25, q1: -0.1 }       // 1-2 zonas horarias
};

// Schedule density (fatiga acumulada)
const SCHEDULE_DENSITY_PENALTY = {
    // 4 juegos en 5 noches
    fourInFive: { full: -1.5, half: -0.75, q1: -0.4 },
    // 3 juegos en 4 noches
    threeInFour: { full: -0.75, half: -0.4, q1: -0.2 }
};

// Division rivalry bonus (partidos mÃ¡s intensos)
const DIVISION_RIVALRY_BONUS = { full: 2.0, half: 1.0, q1: 0.5 };

// Day of week factor (investigaciÃ³n: mÃ¡s puntos en ciertos dÃ­as)
const DAY_OF_WEEK_FACTOR = {
    // Viernes/SÃ¡bado: equipos mÃ¡s motivados, mÃ¡s pÃºblico
    friday: { full: 1.5, half: 0.75, q1: 0.4 },
    saturday: { full: 1.5, half: 0.75, q1: 0.4 },
    // Domingo: segundo de B2B frecuente, algo menos
    sunday: { full: 0.5, half: 0.25, q1: 0.1 },
    // Entre semana: normal
    weekday: { full: 0, half: 0, q1: 0 }
};

// Timezone mapping para equipos
const TEAM_TIMEZONE = {
    // Eastern (-5)
    "Celtics": -5, "Nets": -5, "Knicks": -5, "76ers": -5, "Raptors": -5,
    "Bulls": -6, "Cavaliers": -5, "Pistons": -5, "Pacers": -5, "Bucks": -6,
    "Hawks": -5, "Hornets": -5, "Heat": -5, "Magic": -5, "Wizards": -5,
    // Central (-6)
    "Mavericks": -6, "Rockets": -6, "Grizzlies": -6, "Pelicans": -6, "Spurs": -6,
    "Timberwolves": -6, "Thunder": -6,
    // Mountain (-7)
    "Nuggets": -7, "Jazz": -7, "Suns": -7,
    // Pacific (-8)
    "Lakers": -8, "Clippers": -8, "Warriors": -8, "Kings": -8, "Trail Blazers": -8
};

// Divisiones NBA para rivalry bonus
const NBA_DIVISIONS = {
    atlantic: ["Celtics", "Nets", "Knicks", "76ers", "Raptors"],
    central: ["Bulls", "Cavaliers", "Pistons", "Pacers", "Bucks"],
    southeast: ["Hawks", "Hornets", "Heat", "Magic", "Wizards"],
    northwest: ["Nuggets", "Timberwolves", "Thunder", "Trail Blazers", "Jazz"],
    pacific: ["Warriors", "Clippers", "Lakers", "Kings", "Suns"],
    southwest: ["Mavericks", "Rockets", "Grizzlies", "Pelicans", "Spurs"]
};

// ConfiguraciÃ³n del modelo avanzado
const MODEL_CONFIG = {
    weights: {
        offense: 0.40,      // PPG del equipo
        defense: 0.35,      // OppPPG del rival
        pace: 0.15,         // Ajuste por ritmo
        context: 0.10       // HCA, altitud
    },
    regression: {
        early: 0.70,        // <10 partidos
        mid: 0.85,          // 10-25 partidos
        late: 0.95          // 25+ partidos
    },
    thresholds: {
        highValue: 75,
        minConfidence: 55
    }
};

// Early Season Bias (58% UNDERs en primeras semanas)
const EARLY_SEASON_BIAS = {
    active: true,
    adjustment: -1.5,       // Puntos a restar
    weeksAffected: 2
};

// Obtener factor de regresiÃ³n segÃºn momento de temporada
function getRegressionFactor() {
    const now = new Date();
    const seasonStart = new Date(now.getFullYear(), 9, 22);
    if (now < seasonStart) seasonStart.setFullYear(seasonStart.getFullYear() - 1);
    const weeksIntoSeason = Math.floor((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
    const estimatedGames = weeksIntoSeason * 3.5;
    
    if (estimatedGames < 10) return MODEL_CONFIG.regression.early;
    if (estimatedGames < 25) return MODEL_CONFIG.regression.mid;
    return MODEL_CONFIG.regression.late;
}

// Verificar si es early season
function isEarlySeason() {
    const now = new Date();
    const seasonStart = new Date(now.getFullYear(), 9, 22);
    if (now < seasonStart) seasonStart.setFullYear(seasonStart.getFullYear() - 1);
    const weeksIntoSeason = Math.floor((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
    return weeksIntoSeason < EARLY_SEASON_BIAS.weeksAffected;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES AUXILIARES v2.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Detectar si dos equipos son de la misma divisiÃ³n
function areDivisionRivals(team1, team2) {
    for (const division of Object.values(NBA_DIVISIONS)) {
        if (division.includes(team1) && division.includes(team2)) return true;
    }
    return false;
}

// Calcular diferencia de timezone entre equipos
function getTimezoneDiff(homeTeam, awayTeam) {
    const homeTZ = TEAM_TIMEZONE[homeTeam] || -6;
    const awayTZ = TEAM_TIMEZONE[awayTeam] || -6;
    return Math.abs(homeTZ - awayTZ);
}

// Auto-detectar travel penalty basado en equipos
function autoDetectTravel(homeTeam, awayTeam) {
    const tzDiff = getTimezoneDiff(homeTeam, awayTeam);
    if (tzDiff >= 3) return 'crossCountry';
    if (tzDiff >= 1) return 'moderate';
    return 'none';
}

// Auto-detectar rivalry
function autoDetectRivalry(team1, team2) {
    return areDivisionRivals(team1, team2);
}

// Obtener dÃ­a de la semana actual
function getCurrentGameDay() {
    const day = new Date().getDay();
    if (day === 5) return 'friday';
    if (day === 6) return 'saturday';
    if (day === 0) return 'sunday';
    return 'weekday';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-DETECCIÃ“N DE FACTORES CONTEXTUALES v2.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Mapeo de nombres de equipos para API (balldontlie usa nombres completos)
const TEAM_API_NAMES = {
    "Hawks": "Atlanta Hawks", "Celtics": "Boston Celtics", "Nets": "Brooklyn Nets",
    "Hornets": "Charlotte Hornets", "Bulls": "Chicago Bulls", "Cavaliers": "Cleveland Cavaliers",
    "Mavericks": "Dallas Mavericks", "Nuggets": "Denver Nuggets", "Pistons": "Detroit Pistons",
    "Warriors": "Golden State Warriors", "Rockets": "Houston Rockets", "Pacers": "Indiana Pacers",
    "Clippers": "Los Angeles Clippers", "Lakers": "Los Angeles Lakers", "Grizzlies": "Memphis Grizzlies",
    "Heat": "Miami Heat", "Bucks": "Milwaukee Bucks", "Timberwolves": "Minnesota Timberwolves",
    "Pelicans": "New Orleans Pelicans", "Knicks": "New York Knicks", "Thunder": "Oklahoma City Thunder",
    "Magic": "Orlando Magic", "76ers": "Philadelphia 76ers", "Suns": "Phoenix Suns",
    "Trail Blazers": "Portland Trail Blazers", "Kings": "Sacramento Kings", "Spurs": "San Antonio Spurs",
    "Raptors": "Toronto Raptors", "Jazz": "Utah Jazz", "Wizards": "Washington Wizards"
};

// IDs de equipos en ESPN API (gratuita)
const TEAM_ESPN_IDS = {
    "Hawks": 1, "Celtics": 2, "Nets": 17, "Hornets": 30, "Bulls": 4, "Cavaliers": 5,
    "Mavericks": 6, "Nuggets": 7, "Pistons": 8, "Warriors": 9, "Rockets": 10, "Pacers": 11,
    "Clippers": 12, "Lakers": 13, "Grizzlies": 29, "Heat": 14, "Bucks": 15, "Timberwolves": 16,
    "Pelicans": 3, "Knicks": 18, "Thunder": 25, "Magic": 19, "76ers": 20, "Suns": 21,
    "Trail Blazers": 22, "Kings": 23, "Spurs": 24, "Raptors": 28, "Jazz": 26, "Wizards": 27
};

// Obtener Ãºltimos partidos de un equipo desde ESPN API (GRATUITA)
async function fetchTeamRecentGames(teamName) {
    const teamId = TEAM_ESPN_IDS[teamName];
    if (!teamId) return null;
    
    // Verificar cache (1 hora)
    const cacheKey = `${teamName}_games`;
    if (TEAM_GAMES_CACHE[cacheKey] && Date.now() - TEAM_GAMES_CACHE[cacheKey].timestamp < 3600000) {
        return TEAM_GAMES_CACHE[cacheKey].data;
    }
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8s timeout
        
        const response = await fetch(
            `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/teams/${teamId}/schedule`,
            { signal: controller.signal }
        );
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const events = data.events || [];
        
        // Filtrar solo partidos completados
        const completedGames = events.filter(e => 
            e.competitions && e.competitions[0] && 
            e.competitions[0].status && e.competitions[0].status.type &&
            e.competitions[0].status.type.completed
        );
        
        // Transformar al formato que necesitamos
        const games = completedGames.map(e => {
            const comp = e.competitions[0];
            const homeTeam = comp.competitors.find(c => c.homeAway === 'home');
            const awayTeam = comp.competitors.find(c => c.homeAway === 'away');
            if (!homeTeam || !awayTeam) return null;
            return {
                date: e.date,
                home_team: { name: homeTeam.team.shortDisplayName, full_name: homeTeam.team.displayName },
                visitor_team: { name: awayTeam.team.shortDisplayName, full_name: awayTeam.team.displayName },
                home_team_score: safeParseInt(homeTeam.score, 0),
                visitor_team_score: safeParseInt(awayTeam.score, 0),
                status: 'Final'
            };
        }).filter(g => g !== null);
        
        // Guardar en cache
        TEAM_GAMES_CACHE[cacheKey] = { data: games, timestamp: Date.now() };
        
        return games;
    } catch (error) {
        // Silencioso - auto-detecciÃ³n falla graciosamente
        return null;
    }
}

// Calcular racha de un equipo basado en Ãºltimos partidos
function calculateStreak(games, teamName) {
    if (!games || games.length === 0) return 0;
    
    // Ordenar por fecha descendente (mÃ¡s reciente primero)
    const sortedGames = [...games].sort((a, b) => new Date(b.date) - new Date(a.date));
    if (sortedGames.length === 0) return 0;
    
    let streak = 0;
    let lastResult = null;
    
    for (const game of sortedGames.slice(0, 10)) {
        // Detectar si es home o away
        const isHome = game.home_team.full_name.includes(teamName) || 
                       game.home_team.name === teamName ||
                       TEAM_API_NAMES[teamName]?.includes(game.home_team.name);
        
        const teamScore = isHome ? game.home_team_score : game.visitor_team_score;
        const oppScore = isHome ? game.visitor_team_score : game.home_team_score;
        const won = teamScore > oppScore;
        
        if (lastResult === null) {
            lastResult = won;
            streak = won ? 1 : -1;
        } else if (won === lastResult) {
            streak += won ? 1 : -1;
        } else {
            break;
        }
    }
    
    return Math.max(-5, Math.min(5, streak));
}

// Calcular dÃ­as de descanso desde Ãºltimo partido
function calculateRestDays(games, teamName) {
    if (!games || games.length === 0) return 1;
    
    // Ordenar por fecha descendente y obtener el mÃ¡s reciente
    const sortedGames = [...games].sort((a, b) => new Date(b.date) - new Date(a.date));
    if (sortedGames.length === 0) return 1;
    
    const lastGame = sortedGames[0];
    const lastGameDate = new Date(lastGame.date);
    const today = new Date();
    
    // Normalizar a medianoche
    today.setHours(0, 0, 0, 0);
    lastGameDate.setHours(0, 0, 0, 0);
    
    const diffTime = today - lastGameDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    
    
    return Math.max(1, diffDays);
}

// Detectar B2B (jugÃ³ ayer)
function detectB2B(games, teamName) {
    const restDays = calculateRestDays(games, teamName);
    return restDays === 1;
}

// Calcular densidad de schedule (partidos en Ãºltimos dÃ­as)
function calculateScheduleDensity(games, teamName) {
    if (!games || games.length === 0) return 'normal';
    
    const today = new Date();
    const fiveDaysAgo = new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000);
    const fourDaysAgo = new Date(today.getTime() - 4 * 24 * 60 * 60 * 1000);
    
    const completedGames = games.filter(g => g.status === 'Final');
    
    // Contar partidos en Ãºltimos 5 dÃ­as
    const gamesInFive = completedGames.filter(g => {
        const gameDate = new Date(g.date);
        return gameDate >= fiveDaysAgo && gameDate <= today;
    }).length;
    
    // Contar partidos en Ãºltimos 4 dÃ­as
    const gamesInFour = completedGames.filter(g => {
        const gameDate = new Date(g.date);
        return gameDate >= fourDaysAgo && gameDate <= today;
    }).length;
    
    if (gamesInFive >= 4) return '4in5';
    if (gamesInFour >= 3) return '3in4';
    return 'normal';
}

// FunciÃ³n principal de auto-detecciÃ³n
async function autoDetectContextualFactors(homeTeam, awayTeam) {
    if (!autoDetectEnabled || !homeTeam || !awayTeam) return;
    
    
    
    try {
        // 1. AUTO-DETECTAR DÃA DE LA SEMANA
        gameDay = getCurrentGameDay();
        
        // 2. AUTO-DETECTAR RIVALIDAD DE DIVISIÃ“N
        isDivisionRivalry = areDivisionRivals(homeTeam, awayTeam);
        
        // 3. AUTO-DETECTAR TRAVEL
        awayTravel = autoDetectTravel(homeTeam, awayTeam);
        
        // 4. OBTENER DATOS DE API PARA AMBOS EQUIPOS
        showNotification('ğŸ”„ Cargando datos contextuales...', 'info');
        
        const [homeGames, awayGames] = await Promise.all([
            fetchTeamRecentGames(homeTeam),
            fetchTeamRecentGames(awayTeam)
        ]);
        
        // 5. CALCULAR RACHAS
        if (homeGames) {
            localStreak = calculateStreak(homeGames, homeTeam);
        }
        if (awayGames) {
            awayStreak = calculateStreak(awayGames, awayTeam);
        }
        
        // 6. CALCULAR DÃAS DE DESCANSO
        if (homeGames) {
            localRestDays = calculateRestDays(homeGames, homeTeam);
            localB2B = localRestDays === 1;
        }
        if (awayGames) {
            awayRestDays = calculateRestDays(awayGames, awayTeam);
            awayB2B = awayRestDays === 1;
        }
        
        // 7. CALCULAR DENSIDAD DE SCHEDULE
        if (homeGames) {
            localScheduleDensity = calculateScheduleDensity(homeGames, homeTeam);
        }
        if (awayGames) {
            awayScheduleDensity = calculateScheduleDensity(awayGames, awayTeam);
        }
        
        showNotification('âœ… Factores contextuales detectados automÃ¡ticamente', 'success');
        
    } catch (error) {
        console.error('Error en auto-detecciÃ³n:', error);
        showNotification('âš ï¸ Auto-detecciÃ³n parcial - algunos datos manuales requeridos', 'warning');
    }
}

// Resetear factores a valores por defecto
function resetContextualFactors() {
    localB2B = false; awayB2B = false;
    localRestDays = 1; awayRestDays = 1;
    localInjury = false; awayInjury = false;
    localStreak = 0; awayStreak = 0;
    awayTravel = 'none';
    localScheduleDensity = 'normal'; awayScheduleDensity = 'normal';
    isDivisionRivalry = false;
    gameDay = 'weekday';
}

// SD dinÃ¡mica ajustada por PACE
function getStdDevDynamic(trendValue, combinedPace = LEAGUE_AVG.pace) {
    let baseSD;
    if (trendValue < 70) baseSD = NBA_STD_DEVS.Q1;
    else if (trendValue < 160) baseSD = NBA_STD_DEVS.HALF;
    else baseSD = NBA_STD_DEVS.FULL;
    
    // MÃ¡s PACE = mÃ¡s varianza
    const paceMultiplier = 1 + ((combinedPace - LEAGUE_AVG.pace) / LEAGUE_AVG.pace) * 0.5;
    return baseSD * Math.max(0.85, Math.min(1.15, paceMultiplier));
}

// FunciÃ³n legacy para compatibilidad
function getStdDev(trendValue) {
    return getStdDevDynamic(trendValue, LEAGUE_AVG.pace);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULO DE TENDENCIA AVANZADA v2.5 (Optimizado)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateAdvancedTrend(localTeamName, awayTeamName, period = 'full') {
    // Verificar cache primero
    const cached = getCachedTrend(localTeamName, awayTeamName, period);
    if (cached) return cached;
    
    const local = TEAM_STATS[localTeamName];
    const away = TEAM_STATS[awayTeamName];
    
    if (!local || !away) return null;
    
    const warnings = [];
    const components = {};
    const mult = getPeriodMultiplier(period);
    
    // 1. COMPONENTE OFENSIVO (usando helper)
    const offenseDefaults = { q1: 29, half: 57, full: 115 };
    const defaultOff = getByPeriod(period, offenseDefaults);
    
    let offenseLocal, offenseAway;
    if (period === 'q1') {
        offenseLocal = local.q1Home || local.q1 || defaultOff;
        offenseAway = away.q1Away || away.q1 || defaultOff;
    } else if (period === 'half') {
        offenseLocal = local.halfHome || local.half || defaultOff;
        offenseAway = away.halfAway || away.half || defaultOff;
    } else {
        offenseLocal = local.fullHome || local.full || defaultOff;
        offenseAway = away.fullAway || away.full || defaultOff;
    }
    components.offense = offenseLocal + offenseAway;
    
    // 2. COMPONENTE DEFENSIVO
    let defenseLocal, defenseAway;
    if (period === 'q1') {
        defenseLocal = local.oppQ1 || (local.oppPpg ? local.oppPpg / 4 : 29);
        defenseAway = away.oppQ1 || (away.oppPpg ? away.oppPpg / 4 : 29);
    } else if (period === 'half') {
        defenseLocal = local.oppHalf || (local.oppPpg ? local.oppPpg / 2 : 57);
        defenseAway = away.oppHalf || (away.oppPpg ? away.oppPpg / 2 : 57);
    } else {
        defenseLocal = local.oppPpgHome || local.oppPpg || 115;
        defenseAway = away.oppPpgAway || away.oppPpg || 115;
    }
    components.defense = defenseLocal + defenseAway;
    
    // 3. AJUSTE POR PACE
    const localPace = local.pace || LEAGUE_AVG.pace;
    const awayPace = away.pace || LEAGUE_AVG.pace;
    const combinedPace = (localPace + awayPace) / 2;
    const paceAdjusted = (combinedPace - LEAGUE_AVG.pace) * 0.5 * mult;
    components.pace = paceAdjusted;
    components.combinedPace = combinedPace;
    
    // 4. AJUSTE CONTEXTUAL (HCA + Altitud) - Usando helper
    let contextAdjust = getByPeriod(period, HOME_COURT_ADVANTAGE);
    
    if (ALTITUDE_TEAMS[localTeamName]) {
        const altBonus = ALTITUDE_TEAMS[localTeamName] * mult;
        contextAdjust += altBonus;
        components.altitude = ALTITUDE_TEAMS[localTeamName];
    }
    components.context = contextAdjust;
    
    // 4.5 AJUSTE POR BACK-TO-BACK (B2B) - Optimizado
    let b2bAdjust = 0;
    const b2bPenalty = getByPeriod(period, B2B_PENALTY);
    if (localB2B) { b2bAdjust += b2bPenalty; warnings.push('âš ï¸ Local B2B'); }
    if (awayB2B) { b2bAdjust += b2bPenalty; warnings.push('âš ï¸ Visitante B2B'); }
    components.b2b = b2bAdjust;
    
    // 4.6 AJUSTE POR REST DAYS - Optimizado
    let restAdjust = 0;
    const restBonus = getByPeriod(period, REST_BONUS);
    if (localRestDays >= 3) restAdjust += restBonus.days3plus;
    else if (localRestDays === 2) restAdjust += restBonus.days2;
    if (awayRestDays >= 3) restAdjust += restBonus.days3plus;
    else if (awayRestDays === 2) restAdjust += restBonus.days2;
    components.rest = restAdjust;
    if (localRestDays >= 3) warnings.push(`âœ… ${localTeamName} +${localRestDays}d`);
    if (awayRestDays >= 3) warnings.push(`âœ… ${awayTeamName} +${awayRestDays}d`);
    
    // 4.7 AJUSTE POR INJURIES - Optimizado
    let injuryAdjust = 0;
    const injPenalty = getByPeriod(period, INJURY_PENALTY);
    if (localInjury) { injuryAdjust += injPenalty; warnings.push(`ğŸ¥ ${localTeamName}`); }
    if (awayInjury) { injuryAdjust += injPenalty; warnings.push(`ğŸ¥ ${awayTeamName}`); }
    components.injury = injuryAdjust;
    
    // 4.8 AJUSTE POR STREAKS - Optimizado
    const localStreakLimited = Math.max(-5, Math.min(5, localStreak));
    const awayStreakLimited = Math.max(-5, Math.min(5, awayStreak));
    const streakFactor = getByPeriod(period, STREAK_FACTOR);
    const streakAdjust = (localStreakLimited + awayStreakLimited) * streakFactor;
    components.streak = streakAdjust;
    if (localStreak >= 3) warnings.push(`ğŸ”¥ ${localTeamName} +${localStreak}`);
    if (localStreak <= -3) warnings.push(`â„ï¸ ${localTeamName} ${localStreak}`);
    if (awayStreak >= 3) warnings.push(`ğŸ”¥ ${awayTeamName} +${awayStreak}`);
    if (awayStreak <= -3) warnings.push(`â„ï¸ ${awayTeamName} ${awayStreak}`);
    
    // 4.9 AJUSTE POR TRAVEL - Optimizado
    let travelAdjust = 0;
    if (awayTravel === 'crossCountry') {
        travelAdjust = getByPeriod(period, TRAVEL_PENALTY.crossCountry);
        warnings.push(`âœˆï¸ ${awayTeamName} viaje largo`);
    } else if (awayTravel === 'moderate') {
        travelAdjust = getByPeriod(period, TRAVEL_PENALTY.moderate);
    }
    components.travel = travelAdjust;
    
    // 4.10 AJUSTE POR SCHEDULE DENSITY - Optimizado
    let scheduleAdjust = 0;
    const fourInFive = getByPeriod(period, SCHEDULE_DENSITY_PENALTY.fourInFive);
    const threeInFour = getByPeriod(period, SCHEDULE_DENSITY_PENALTY.threeInFour);
    
    if (localScheduleDensity === '4in5') { scheduleAdjust += fourInFive; warnings.push(`ğŸ˜° ${localTeamName} 4-en-5`); }
    else if (localScheduleDensity === '3in4') { scheduleAdjust += threeInFour; }
    if (awayScheduleDensity === '4in5') { scheduleAdjust += fourInFive; warnings.push(`ğŸ˜° ${awayTeamName} 4-en-5`); }
    else if (awayScheduleDensity === '3in4') { scheduleAdjust += threeInFour; }
    components.schedule = scheduleAdjust;
    
    // 4.11 AJUSTE POR DIVISION RIVALRY - Optimizado
    let divisionAdjust = 0;
    if (isDivisionRivalry) {
        divisionAdjust = getByPeriod(period, DIVISION_RIVALRY_BONUS);
        warnings.push(`âš”ï¸ DivisiÃ³n`);
    }
    components.division = divisionAdjust;
    
    // 4.12 AJUSTE POR DÃA - Optimizado
    const dayFactor = DAY_OF_WEEK_FACTOR[gameDay] || DAY_OF_WEEK_FACTOR.weekday;
    const dayAdjust = getByPeriod(period, dayFactor);
    components.dayOfWeek = dayAdjust;
    if (gameDay === 'friday' || gameDay === 'saturday') warnings.push(`ğŸ‰ Fin de semana`);
    
    // 5. CÃLCULO FINAL
    const baseTotal = (components.offense * MODEL_CONFIG.weights.offense + 
                       components.defense * MODEL_CONFIG.weights.defense) / 
                      (MODEL_CONFIG.weights.offense + MODEL_CONFIG.weights.defense);
    
    let finalTrend = baseTotal + components.pace + components.context + b2bAdjust + restAdjust + injuryAdjust + streakAdjust + travelAdjust + scheduleAdjust + divisionAdjust + dayAdjust;
    
    // 6. EARLY SEASON BIAS - Optimizado
    if (EARLY_SEASON_BIAS.active && isEarlySeason()) {
        finalTrend += EARLY_SEASON_BIAS.adjustment * mult;
        warnings.push('âš ï¸ Early Season');
        components.earlySeason = true;
    }
    
    // 7. REGRESIÃ“N A LA MEDIA - Optimizado
    const regressionFactor = getRegressionFactor();
    const leagueAvgByPeriod = { q1: LEAGUE_AVG.q1 * 2, half: LEAGUE_AVG.half * 2, full: LEAGUE_AVG.ppg * 2 };
    const leagueAvg = getByPeriod(period, leagueAvgByPeriod);
    
    finalTrend = finalTrend * regressionFactor + leagueAvg * (1 - regressionFactor);
    components.regression = regressionFactor;
    
    // 8. CONFIANZA - CÃ¡lculo mejorado y mÃ¡s realista
    let confidence = 85; // Base 85%, no 100%
    
    // Bonus por datos completos
    if (local.oppPpg && away.oppPpg) confidence += 5; // Datos defensivos completos
    if (local.pace && away.pace) confidence += 5; // Datos PACE completos
    
    // Penalizaciones
    if (!local.oppPpg || !away.oppPpg) { confidence -= 10; warnings.push('âš ï¸ Sin datos defensivos'); }
    if (!local.pace || !away.pace) { confidence -= 8; warnings.push('âš ï¸ Sin datos PACE'); }
    if (components.earlySeason) { confidence -= 12; }
    if (regressionFactor < 0.85) { confidence -= 8; }
    
    // Penalizar diferencias extremas entre Home y Away (inconsistencia)
    const homeAwayDiff = Math.abs(offenseLocal - offenseAway);
    if (period === 'full' && homeAwayDiff > 10) {
        confidence -= 5;
        warnings.push('âš ï¸ Alta variabilidad Home/Away');
    }
    
    // Penalizar cuando la predicciÃ³n estÃ¡ muy lejos del promedio de liga
    const deviationFromAvg = Math.abs(finalTrend - leagueAvg);
    if (period === 'full' && deviationFromAvg > 15) {
        confidence -= 5;
    }
    
    // Bonus por datos de splits especÃ­ficos (Home/Away)
    if (local.fullHome && local.fullAway && away.fullHome && away.fullAway) {
        confidence += 3;
    }
    
    const result = {
        trend: safeParseFloat(finalTrend.toFixed(1)),
        components,
        confidence: Math.max(55, Math.min(95, confidence)),
        warnings,
        combinedPace
    };
    
    // Guardar en cache
    setCachedTrend(localTeamName, awayTeamName, period, result);
    
    return result;
}

// Obtener tendencias completas con modelo avanzado
function getAdvancedTrends(localTeamName, awayTeamName) {
    const q1 = calculateAdvancedTrend(localTeamName, awayTeamName, 'q1');
    const half = calculateAdvancedTrend(localTeamName, awayTeamName, 'half');
    const full = calculateAdvancedTrend(localTeamName, awayTeamName, 'full');
    
    if (!q1 || !half || !full) return null;
    
    return {
        q1: q1.trend, half: half.trend, full: full.trend,
        components: { q1: q1.components, half: half.components, full: full.components },
        confidence: Math.min(q1.confidence, half.confidence, full.confidence),
        warnings: [...new Set([...q1.warnings, ...half.warnings, ...full.warnings])],
        combinedPace: full.combinedPace,
        isEarlySeason: q1.components.earlySeason || false
    };
}

// Calcular probabilidad con calibraciÃ³n avanzada
function calcProb(trend, line, type, options = {}) {
    if (!trend || trend === '-' || !line) return null;
    
    const trendNum = parseFloat(trend);
    const lineNum = parseFloat(line);
    const diff = trendNum - lineNum;
    
    const combinedPace = options.combinedPace || LEAGUE_AVG.pace;
    const std = getStdDevDynamic(trendNum, combinedPace);
    const z = diff / std;
    
    // CDF normal (Abramowitz-Stegun)
    const cdf = x => {
        const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
        const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
        const sign = x < 0 ? -1 : 1;
        const absX = Math.abs(x);
        const t = 1.0 / (1.0 + p * absX);
        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX / 2);
        return 0.5 * (1.0 + sign * y);
    };
    
    let prob = type === 'OVER' ? cdf(z) : 1 - cdf(z);
    
    // CalibraciÃ³n con regresiÃ³n dinÃ¡mica
    const regressionFactor = getRegressionFactor();
    prob = prob * regressionFactor + 0.5 * (1 - regressionFactor);
    
    // Early season: mÃ¡s conservador
    if (isEarlySeason()) {
        prob = prob * 0.90 + 0.5 * 0.10;
    }
    
    prob = Math.max(0.05, Math.min(0.95, prob));
    return Math.round(prob * 100);
}

// Calcular Expected Value (EV) - LA MÃ‰TRICA MÃS IMPORTANTE
function calcEV(prob, odds) {
    if (!prob || !odds) return null;
    const p = prob / 100;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // EV = (Prob Ã— Ganancia) - (1-Prob Ã— PÃ©rdida)
    // Ganancia si ganas = (odds - 1) por unidad
    // PÃ©rdida si pierdes = 1 unidad
    const ev = (p * (oddsNum - 1)) - ((1 - p) * 1);
    return (ev * 100).toFixed(1); // Retorna como porcentaje
}

// Calcular Edge (Ventaja sobre la casa)
function calcEdge(prob, odds) {
    if (!prob || !odds) return null;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // Probabilidad implÃ­cita de la casa (sin vig)
    const impliedProb = 1 / oddsNum;
    const ourProb = prob / 100;
    
    // Edge = Nuestra probabilidad - Probabilidad implÃ­cita
    const edge = (ourProb - impliedProb) * 100;
    return edge.toFixed(1);
}

// Calcular Cuota Justa (Fair Odds)
function calcFairOdds(prob) {
    if (!prob || prob <= 0 || prob >= 100) return null;
    // Cuota Justa = 1 / Probabilidad
    return (100 / prob).toFixed(2);
}

// Calcular Kelly Criterion (% Ã³ptimo de bankroll a apostar)
function calcKelly(prob, odds) {
    if (!prob || !odds) return null;
    const p = prob / 100;
    const oddsNum = parseFloat(odds);
    if (oddsNum <= 1) return null;
    
    // Kelly = (p Ã— (odds - 1) - (1-p)) / (odds - 1)
    // Simplificado: Kelly = (p Ã— odds - 1) / (odds - 1)
    const kelly = ((p * oddsNum) - 1) / (oddsNum - 1);
    
    // Kelly fraccionario (mÃ¡s conservador, usar 25% del Kelly completo)
    const fractionalKelly = kelly * 0.25;
    
    if (fractionalKelly <= 0) return 0;
    return (fractionalKelly * 100).toFixed(1);
}

// AnÃ¡lisis completo de una apuesta (incluye mÃ©tricas de transparencia)
function analyzebet(trend, line, type, odds) {
    if (!trend || trend === '-' || !line) return null;
    
    const trendNum = parseFloat(trend);
    const lineNum = parseFloat(line);
    const diff = trendNum - lineNum;
    const std = getStdDev(trendNum);
    const zScore = diff / std;
    
    const prob = calcProb(trend, line, type);
    if (!prob) return null;
    
    const fairOdds = calcFairOdds(prob);
    const ev = odds ? calcEV(prob, odds) : null;
    const edge = odds ? calcEdge(prob, odds) : null;
    const kelly = odds ? calcKelly(prob, odds) : null;
    
    // Incluir mÃ©tricas de transparencia
    return { 
        prob, 
        fairOdds, 
        ev, 
        edge, 
        kelly,
        // MÃ©tricas adicionales para transparencia
        diff: diff.toFixed(1),
        std: std.toFixed(1),
        zScore: zScore.toFixed(2)
    };
}

// Color basado en EV (no solo probabilidad)
function evColor(ev, prob) {
    if (ev === null) {
        if (!prob) return 'bg-gray-600';
        if (prob >= 65) return 'bg-blue-600';
        if (prob >= 55) return 'bg-blue-500';
        if (prob >= 45) return 'bg-gray-500';
        return 'bg-gray-600';
    }
    
    const evNum = safeParseFloat(ev);
    if (evNum >= 15) return 'bg-gradient-to-r from-emerald-500 to-green-600';
    if (evNum >= 7) return 'bg-gradient-to-r from-green-500 to-emerald-600';
    if (evNum >= 3) return 'bg-gradient-to-r from-lime-500 to-green-500';
    if (evNum >= 0) return 'bg-gradient-to-r from-yellow-500 to-amber-500';
    return 'bg-gradient-to-r from-red-500 to-rose-600';
}

// Veredicto profesional basado en EV
function evVerdict(ev, prob, edge) {
    if (ev === null) {
        if (!prob) return { icon: 'â“', text: 'Ingresa lÃ­nea', class: 'text-gray-400' };
        if (prob >= 65) return { icon: 'ğŸ“Š', text: 'PROB. ALTA', class: 'text-blue-400' };
        if (prob >= 55) return { icon: 'ğŸ“ˆ', text: 'PROB. MEDIA', class: 'text-blue-300' };
        if (prob >= 45) return { icon: 'âš–ï¸', text: 'NEUTRAL', class: 'text-gray-300' };
        return { icon: 'ğŸ“‰', text: 'PROB. BAJA', class: 'text-gray-400' };
    }
    
    const evNum = safeParseFloat(ev);
    
    if (evNum >= 15) return { icon: 'ğŸ”¥', text: 'ELITE VALUE', class: 'text-emerald-400', stars: 'â˜…â˜…â˜…â˜…â˜…' };
    if (evNum >= 10) return { icon: 'ğŸ’', text: 'ALTO VALOR', class: 'text-green-400', stars: 'â˜…â˜…â˜…â˜…â˜†' };
    if (evNum >= 7) return { icon: 'âœ…', text: 'MUY BUENO', class: 'text-green-300', stars: 'â˜…â˜…â˜…â˜…â˜†' };
    if (evNum >= 5) return { icon: 'âœ…', text: 'BUEN VALOR', class: 'text-lime-400', stars: 'â˜…â˜…â˜…â˜†â˜†' };
    if (evNum >= 3) return { icon: 'ğŸ‘', text: 'VALOR', class: 'text-lime-300', stars: 'â˜…â˜…â˜…â˜†â˜†' };
    if (evNum >= 0) return { icon: 'âš ï¸', text: 'MARGINAL', class: 'text-yellow-400', stars: 'â˜…â˜…â˜†â˜†â˜†' };
    if (evNum >= -3) return { icon: 'â›”', text: 'SIN VALOR', class: 'text-orange-400', stars: 'â˜…â˜†â˜†â˜†â˜†' };
    return { icon: 'ğŸš«', text: 'NO APOSTAR', class: 'text-red-400', stars: 'â˜†â˜†â˜†â˜†â˜†' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODELO DE MACHINE LEARNING v1.1
// Aprende de tu historial para mejorar predicciones
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ML_MODEL = {
    // Coeficientes del modelo (se actualizan con los datos)
    coefficients: {
        zScore: 0.3,      // Peso del Z-Score
        evWeight: 0.25,   // Peso del EV
        h2hWeight: 0.2,   // Peso del historial H2H
        periodBias: {     // Bias por perÃ­odo (se aprende)
            '1Q': 0,
            '1H': 0,
            'FULL': 0
        },
        typeBias: {       // Bias por tipo (se aprende)
            'OVER': 0,
            'UNDER': 0
        }
    },
    
    // Entrenar modelo con datos histÃ³ricos
    train: function() {
        const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending');
        if (picks.length < 10) return; // Necesitamos mÃ­nimo 10 picks
        
        // Calcular bias por perÃ­odo
        const periodStats = { '1Q': {wins:0, total:0}, '1H': {wins:0, total:0}, 'FULL': {wins:0, total:0} };
        picks.forEach(p => {
            if (periodStats[p.period]) {
                periodStats[p.period].total++;
                if (p.status === 'win') periodStats[p.period].wins++;
            }
        });
        
        Object.keys(periodStats).forEach(period => {
            if (periodStats[period].total >= 5) {
                const winRate = periodStats[period].wins / periodStats[period].total;
                // Bias positivo si ganas mÃ¡s del 52.4% (breakeven), negativo si menos
                this.coefficients.periodBias[period] = (winRate - 0.524) * 0.1;
            }
        });
        
        // Calcular bias por tipo (Over/Under)
        const typeStats = { 'OVER': {wins:0, total:0}, 'UNDER': {wins:0, total:0} };
        picks.forEach(p => {
            if (typeStats[p.betType]) {
                typeStats[p.betType].total++;
                if (p.status === 'win') typeStats[p.betType].wins++;
            }
        });
        
        Object.keys(typeStats).forEach(type => {
            if (typeStats[type].total >= 5) {
                const winRate = typeStats[type].wins / typeStats[type].total;
                this.coefficients.typeBias[type] = (winRate - 0.524) * 0.1;
            }
        });
        
        
    },
    
    // Predecir ajuste de probabilidad
    predict: function(period, betType, baseProb, zScore, ev) {
        // Entrenar si no se ha hecho
        this.train();
        
        let adjustment = 0;
        
        // Aplicar bias de perÃ­odo aprendido
        adjustment += (this.coefficients.periodBias[period] || 0) * 100;
        
        // Aplicar bias de tipo aprendido
        adjustment += (this.coefficients.typeBias[betType] || 0) * 100;
        
        // Ajuste por Z-Score extremo
        if (Math.abs(zScore) > 2) {
            // Z-Scores muy altos suelen revertir a la media
            adjustment -= Math.sign(zScore) * 2;
        }
        
        // Ajuste por EV (si es muy alto, puede ser trampa)
        if (ev && parseFloat(ev) > 20) {
            adjustment -= 3; // Penalizar EV excesivamente alto
        }
        
        return Math.round(adjustment);
    },
    
    // Obtener score de confianza del modelo (0-100)
    getConfidence: function() {
        const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending');
        if (picks.length < 10) return 0;
        if (picks.length < 20) return 30;
        if (picks.length < 50) return 60;
        return 80;
    }
};

// Aplicar modelo ML a la probabilidad base
function applyMLAdjustment(baseProb, period, betType, zScore, ev) {
    const adjustment = ML_MODEL.predict(period, betType, baseProb, zScore, ev);
    const mlProb = Math.max(5, Math.min(95, baseProb + adjustment));
    return {
        prob: mlProb,
        adjustment,
        confidence: ML_MODEL.getConfidence()
    };
}

// RecomendaciÃ³n de stake basada en Kelly
function stakeRec(kelly) {
    if (!kelly || kelly <= 0) return { text: 'No apostar', class: 'text-red-400' };
    const k = parseFloat(kelly);
    if (k >= 5) return { text: '3-5% bankroll', class: 'text-green-400' };
    if (k >= 3) return { text: '2-3% bankroll', class: 'text-lime-400' };
    if (k >= 1.5) return { text: '1-2% bankroll', class: 'text-yellow-400' };
    if (k >= 0.5) return { text: '0.5-1% bankroll', class: 'text-orange-400' };
    return { text: 'MÃ­nimo', class: 'text-gray-400' };
}

function getScores() {
    return {
        lQ1: parseInt(ingestScores.localQ1) || 0, lQ2: parseInt(ingestScores.localQ2) || 0,
        lQ3: parseInt(ingestScores.localQ3) || 0, lQ4: parseInt(ingestScores.localQ4) || 0,
        aQ1: parseInt(ingestScores.awayQ1) || 0, aQ2: parseInt(ingestScores.awayQ2) || 0,
        aQ3: parseInt(ingestScores.awayQ3) || 0, aQ4: parseInt(ingestScores.awayQ4) || 0,
        lOT1: parseInt(ingestScores.localOT1) || 0, aOT1: parseInt(ingestScores.awayOT1) || 0,
        lOT2: parseInt(ingestScores.localOT2) || 0, aOT2: parseInt(ingestScores.awayOT2) || 0,
        lOT3: parseInt(ingestScores.localOT3) || 0, aOT3: parseInt(ingestScores.awayOT3) || 0
    };
}

function checkOT() {
    const s = getScores();
    const lReg = s.lQ1+s.lQ2+s.lQ3+s.lQ4, aReg = s.aQ1+s.aQ2+s.aQ3+s.aQ4;
    const filled = s.lQ1>0 && s.lQ2>0 && s.lQ3>0 && s.lQ4>0 && s.aQ1>0 && s.aQ2>0 && s.aQ3>0 && s.aQ4>0;
    const need1 = filled && lReg === aReg;
    const lA1 = lReg+s.lOT1, aA1 = aReg+s.aOT1;
    const need2 = need1 && s.lOT1>0 && s.aOT1>0 && lA1 === aA1;
    const lA2 = lA1+s.lOT2, aA2 = aA1+s.aOT2;
    const need3 = need2 && s.lOT2>0 && s.aOT2>0 && lA2 === aA2;
    return { needOT1: need1, needOT2: need2, needOT3: need3 };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    const app = document.getElementById('app');
    if (currentView === 'home') app.innerHTML = renderHome();
    else if (currentView === 'tendencia') app.innerHTML = renderTendencia();
    else if (currentView === 'ingesta') app.innerHTML = renderIngesta();
    else if (currentView === 'picks') app.innerHTML = renderPicks();
    else if (currentView === 'bestPicks') app.innerHTML = renderBestPicks();
    else if (currentView === 'dashboard') app.innerHTML = renderDashboard();
    else if (currentView === 'bankroll') {
        app.innerHTML = renderBankrollView();
        setTimeout(() => createBankrollChart(), 100);
    }
    attachEvents();
    
    // Inicializar grÃ¡ficos si estamos en dashboard
    if (currentView === 'dashboard') {
        setTimeout(() => initDashboardCharts(), 100);
    }
}

function renderHome() {
    const teams = getTeams();
    const top5 = [...teams].sort((a,b) => (TEAM_STATS[b]?.full||0) - (TEAM_STATS[a]?.full||0)).slice(0,5);
    const h2hC = Object.keys(H2H_DATABASE).length;
    const totalG = Object.values(H2H_DATABASE).reduce((s,a) => s + (Array.isArray(a) ? a.length : 0), 0);
    const picksStats = getPicksStats();
    
    let topH = top5.map((t,i) => `
        <div class="flex justify-between items-center bg-white/5 hover:bg-white/10 rounded-xl p-3 mb-2 transition-all border border-transparent hover:border-yellow-500/30">
            <span class="text-white font-semibold">${i+1}. ${t}</span>
            <div class="text-right">
                <span class="text-yellow-400 font-bold text-lg">${TEAM_STATS[t]?.full?.toFixed(1)}</span>
                <span class="text-gray-500 text-xs ml-2">(H:${TEAM_STATS[t]?.fullHome} / A:${TEAM_STATS[t]?.fullAway})</span>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <!-- HEADER CON ESTADIO SVG DE FONDO -->
            <div class="relative mb-8 overflow-hidden rounded-3xl" style="background: linear-gradient(135deg, #0d1b2a 0%, #1b3a5f 50%, #0d1b2a 100%);">
                <!-- Elementos decorativos NBA -->
                <div class="absolute inset-0 opacity-5">
                    <svg viewBox="0 0 400 200" class="w-full h-full">
                        <!-- Cancha de basketball simplificada -->
                        <rect x="20" y="20" width="360" height="160" fill="none" stroke="#FFD700" stroke-width="2"/>
                        <circle cx="200" cy="100" r="40" fill="none" stroke="#FFD700" stroke-width="2"/>
                        <line x1="200" y1="20" x2="200" y2="180" stroke="#FFD700" stroke-width="2"/>
                        <!-- Ãreas de tiro -->
                        <path d="M20 60 L60 60 L60 140 L20 140" fill="none" stroke="#FFD700" stroke-width="2"/>
                        <path d="M380 60 L340 60 L340 140 L380 140" fill="none" stroke="#FFD700" stroke-width="2"/>
                        <circle cx="60" cy="100" r="30" fill="none" stroke="#FFD700" stroke-width="2"/>
                        <circle cx="340" cy="100" r="30" fill="none" stroke="#FFD700" stroke-width="2"/>
                    </svg>
                </div>
                
                <div class="relative z-10 p-8 text-center">
                    <!-- Logo -->
                    <div class="flex items-center justify-center gap-5 mb-4">
                        ${LOGO_SVG}
                        <div>
                            <h1 class="text-5xl md:text-6xl font-black font-display tracking-wider relative" 
                                style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
                                       -webkit-background-clip: text;
                                       -webkit-text-fill-color: transparent;
                                       background-clip: text;
                                       filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.5));
                                       letter-spacing: 0.15em;">
                                NIOSPORTS
                            </h1>
                            <div class="flex items-center justify-center gap-2 mt-1">
                                <span class="text-yellow-400 text-base font-semibold" style="text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);">ğŸ€ NBA Analytics</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm">Sistema Profesional de Predicciones NBA con Inteligencia Artificial</p>
                </div>
                
                <!-- Barra de estado -->
                <div class="bg-black/30 backdrop-blur px-4 py-2 flex items-center justify-center gap-3">
                    ${apiConnected ? '<div class="live-dot"></div>' : '<span class="text-yellow-500">âš ï¸</span>'}
                    <span class="font-medium text-sm ${apiConnected ? 'text-green-400' : 'text-yellow-400'}">
                        ${apiConnected ? 'LIVE' : 'OFFLINE'} â€¢ ${statsSource}
                    </span>
                    ${statsLastUpdated ? `<span class="text-xs text-gray-500">â€¢ ${new Date(statsLastUpdated).toLocaleString('es-ES', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'})}</span>` : ''}
                </div>
            </div>
            
            <!-- BOTÃ“N PRINCIPAL - TENDENCIA -->
            <button onclick="navigateTo('tendencia')" class="btn-3d w-full p-6 rounded-2xl shadow-2xl mb-4 relative overflow-hidden group" style="background: linear-gradient(135deg, #FFD700 0%, #F59E0B 100%);">
                <div class="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 skew-x-12"></div>
                <div class="relative flex items-center justify-center gap-4">
                    <div class="text-5xl">ğŸ€</div>
                    <div class="text-left">
                        <h3 class="text-2xl font-bold" style="color: #0d1b2a;">Analizar Partido</h3>
                        <p class="text-sm opacity-80" style="color: #0d1b2a;">Tendencia + H2H + Factores Contextuales</p>
                    </div>
                </div>
            </button>
            
            <!-- BOTONES SECUNDARIOS -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="navigateTo('bestPicks')" class="btn-3d p-5 rounded-2xl shadow-xl border border-yellow-500/30 hover:border-yellow-400 transition-all" style="background: linear-gradient(135deg, #1b263b 0%, #22354a 100%);">
                    <div class="text-3xl mb-2">ğŸ”¥</div>
                    <h3 class="text-lg font-bold text-yellow-400">Best Picks</h3>
                    <p class="text-gray-400 text-xs">Sugerencias del Modelo</p>
                </button>
                
                <button onclick="navigateTo('picks')" class="btn-3d p-5 rounded-2xl shadow-xl border border-white/10 hover:border-yellow-500/30 transition-all" style="background: linear-gradient(135deg, #1b263b 0%, #22354a 100%);">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <h3 class="text-lg font-bold text-white">Mis Picks</h3>
                    <p class="text-gray-400 text-xs">Historial Completo</p>
                </button>
            </div>
            
            <!-- DASHBOARD Y DATA -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button onclick="navigateTo('dashboard')" class="btn-3d p-4 rounded-2xl shadow-xl border border-blue-500/30 hover:border-blue-400 transition-all" style="background: linear-gradient(135deg, #0d1b2a 0%, #1b3a5f 100%);">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">ğŸ“ˆ</div>
                        <div class="text-left">
                            <h3 class="font-bold text-blue-400">Dashboard</h3>
                            <p class="text-gray-500 text-xs">GrÃ¡ficos & Stats</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="navigateTo('ingesta')" class="btn-3d p-4 rounded-2xl shadow-xl border border-purple-500/30 hover:border-purple-400 transition-all" style="background: linear-gradient(135deg, #1b263b 0%, #2d1b4a 100%);">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">ğŸ“</div>
                        <div class="text-left">
                            <h3 class="font-bold text-purple-400">Ingesta H2H</h3>
                            <p class="text-gray-500 text-xs">Agregar Datos</p>
                        </div>
                    </div>
                </button>
            </div>
            
            <!-- BANKROLL - ANCHO COMPLETO -->
            <button onclick="navigateTo('bankroll')" class="btn-3d w-full p-5 rounded-2xl shadow-xl border border-green-500/30 hover:border-green-400 transition-all mb-6" style="background: linear-gradient(135deg, #0d3d1b 0%, #1b4a2d 100%);">
                <div class="relative flex items-center justify-center gap-4">
                    <div class="text-5xl">ğŸ’°</div>
                    <div class="text-left">
                        <h3 class="text-2xl font-bold text-green-400">Bankroll</h3>
                        <p class="text-sm text-green-300/70">GestiÃ³n Profesional & EstadÃ­sticas</p>
                    </div>
                </div>
            </button>
            
            <!-- MI RÃ‰CORD PERSONAL -->
            <div class="rounded-2xl p-5 mb-6 border border-yellow-500/30" style="background: linear-gradient(135deg, #1b263b 0%, #0d1b2a 100%);">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ†</span>
                        <h3 class="text-lg font-bold text-white">Mi RÃ©cord Personal</h3>
                    </div>
                    <button onclick="navigateTo('picks')" class="text-xs bg-yellow-500 hover:bg-yellow-400 text-gray-900 px-3 py-1 rounded-lg font-semibold transition-all">Ver todo</button>
                </div>
                
                <!-- Stats principales -->
                <div class="grid grid-cols-4 gap-3 text-center mb-4">
                    <div class="rounded-xl p-3" style="background: rgba(255,255,255,0.05);">
                        <p class="text-2xl font-black ${parseFloat(picksStats.winRate) >= 55 ? 'text-green-400' : parseFloat(picksStats.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${picksStats.winRate}%</p>
                        <p class="text-gray-500 text-xs">Win Rate</p>
                    </div>
                    <div class="rounded-xl p-3" style="background: rgba(34,197,94,0.1);">
                        <p class="text-2xl font-black text-green-400">${picksStats.wins}</p>
                        <p class="text-gray-500 text-xs">Wins</p>
                    </div>
                    <div class="rounded-xl p-3" style="background: rgba(239,68,68,0.1);">
                        <p class="text-2xl font-black text-red-400">${picksStats.losses}</p>
                        <p class="text-gray-500 text-xs">Losses</p>
                    </div>
                    <div class="rounded-xl p-3" style="background: rgba(255,215,0,0.1);">
                        <p class="text-2xl font-black text-yellow-400">${picksStats.pending}</p>
                        <p class="text-gray-500 text-xs">Pending</p>
                    </div>
                </div>
                
                <!-- Profit y ROI -->
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="rounded-xl p-3 border border-white/5" style="background: rgba(0,0,0,0.3);">
                        <p class="text-xl font-black ${parseFloat(picksStats.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(picksStats.profit) > 0 ? '+' : ''}${picksStats.profit}u</p>
                        <p class="text-gray-500 text-xs">Profit</p>
                    </div>
                    <div class="rounded-xl p-3 border border-white/5" style="background: rgba(0,0,0,0.3);">
                        <p class="text-xl font-black ${parseFloat(picksStats.roi) >= 0 ? 'text-blue-400' : 'text-red-400'}">${parseFloat(picksStats.roi) > 0 ? '+' : ''}${picksStats.roi}%</p>
                        <p class="text-gray-500 text-xs">ROI</p>
                    </div>
                    <div class="rounded-xl p-3 border border-white/5" style="background: rgba(0,0,0,0.3);">
                        ${picksStats.streak.count > 0 ? `
                            <p class="text-xl font-black ${picksStats.streak.type === 'win' ? 'text-green-400' : 'text-red-400'}">${picksStats.streak.count}${picksStats.streak.type === 'win' ? 'W' : 'L'}</p>
                            <p class="text-gray-500 text-xs">${picksStats.streak.type === 'win' ? 'ğŸ”¥' : 'â„ï¸'} Streak</p>
                        ` : `
                            <p class="text-xl font-black text-gray-500">-</p>
                            <p class="text-gray-500 text-xs">Streak</p>
                        `}
                    </div>
                </div>
                
                <!-- Por perÃ­odo -->
                ${picksStats.total > 0 ? `
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-xs text-gray-500 mb-3 text-center">ğŸ“Š Rendimiento por PerÃ­odo</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="rounded-lg p-2 text-center" style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.2);">
                            <p class="text-yellow-400 font-bold text-sm">1Q</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['1Q'].wins}W-${picksStats.byPeriod['1Q'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['1Q'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['1Q'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['1Q'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="rounded-lg p-2 text-center" style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);">
                            <p class="text-blue-400 font-bold text-sm">1H</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['1H'].wins}W-${picksStats.byPeriod['1H'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['1H'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['1H'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['1H'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="rounded-lg p-2 text-center" style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2);">
                            <p class="text-green-400 font-bold text-sm">FULL</p>
                            <p class="text-white text-xs">${picksStats.byPeriod['FULL'].wins}W-${picksStats.byPeriod['FULL'].losses}L</p>
                            <p class="text-xs ${picksStats.byPeriod['FULL'].profit >= 0 ? 'text-green-400' : 'text-red-400'}">${picksStats.byPeriod['FULL'].profit >= 0 ? '+' : ''}${picksStats.byPeriod['FULL'].profit.toFixed(2)}u</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="glass rounded-xl p-4 mb-6">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ“Š Base de Datos H2H <span class="text-green-400 text-sm">(Firebase)</span></h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                        <p class="text-3xl font-black text-purple-400">${h2hC}</p>
                        <p class="text-gray-400 text-sm">Matchups</p>
                    </div>
                    <div class="bg-green-500/20 rounded-lg p-3 text-center">
                        <p class="text-3xl font-black text-green-400">${totalG}</p>
                        <p class="text-gray-400 text-sm">Partidos</p>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-4">
                <h3 class="text-lg font-bold text-white mb-3">ğŸ”¥ Top 5 Equipos PPG 2025-26</h3>
                ${topH}
            </div>
        </div>
    `;
}

function renderTendencia() {
    const teams = getTeams();
    const lD = localTeam ? TEAM_STATS[localTeam] : null;
    const vD = visitingTeam ? TEAM_STATS[visitingTeam] : null;
    
    // Calcular rankings
    const lR = localTeam ? getAllTeamRankings(localTeam) : null;
    const vR = visitingTeam ? getAllTeamRankings(visitingTeam) : null;
    
    let trends = { q1: '-', half: '-', full: '-' };
    // USAR MODELO AVANZADO v2.0
    let advancedData = null;
    if (lD && vD) {
        advancedData = getAdvancedTrends(localTeam, visitingTeam);
        
        if (advancedData) {
            trends = {
                q1: advancedData.q1.toFixed(1),
                half: advancedData.half.toFixed(1),
                full: advancedData.full.toFixed(1)
            };
        } else {
            // Fallback al mÃ©todo simple
            trends = {
                q1: (lD.q1Home + vD.q1Away).toFixed(1),
                half: (lD.halfHome + vD.halfAway).toFixed(1),
                full: (lD.fullHome + vD.fullAway).toFixed(1)
            };
        }
    }
    
    // Calcular probabilidades con PACE si estÃ¡ disponible
    const probOptions = advancedData ? { combinedPace: advancedData.combinedPace } : {};
    const pQ1 = calcProb(trends.q1, lineQ1, typeQ1, probOptions);
    const pHalf = calcProb(trends.half, lineHalf, typeHalf, probOptions);
    const pFull = calcProb(trends.full, lineFull, typeFull, probOptions);
    
    let opts = '<option value="">Seleccionar...</option>';
    teams.forEach(t => { opts += `<option value="${t}">${t}</option>`; });
    
    let html = `
        <div class="p-3 md:p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 text-yellow-400 hover:text-yellow-300 px-4 py-2 rounded-lg mb-4 text-sm md:text-base font-semibold transition-all" style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3);">â† Volver al Inicio</button>
            <div class="text-center mb-6">
                <div class="flex items-center justify-center gap-3 mb-2">
                    ${LOGO_SVG}
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white font-display tracking-wide">ANÃLISIS DE PARTIDO</h1>
                        <p class="text-yellow-400 text-sm font-semibold">ğŸ€ Tendencia + H2H + Factores Contextuales</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-6">
                <div class="p-3 md:p-4 rounded-xl border border-blue-500/30" style="background: linear-gradient(135deg, #1b3a5f 0%, #0d1b2a 100%);">
                    <h2 class="text-base md:text-lg font-bold text-blue-400 mb-2 text-center">ğŸ  EQUIPO LOCAL</h2>
                    <select id="localSelect" class="select-premium w-full">
                        ${opts.replace(`value="${localTeam}"`, `value="${localTeam}" selected`)}
                    </select>
                    ${lD && lR ? `
                        <div class="mt-3 rounded-lg p-2 md:p-3" style="background: rgba(0,0,0,0.3);">
                            <div class="text-blue-300 text-xs md:text-sm text-center mb-2 font-semibold">ğŸ“Š Temporada 2025-26</div>
                            <div class="grid grid-cols-3 gap-1 text-center text-xs md:text-sm mb-2">
                                <div class="text-white">1Q: ${lD.q1} ${formatRanking(lR.q1)}</div>
                                <div class="text-white">1H: ${lD.half} ${formatRanking(lR.half)}</div>
                                <div class="text-white">Full: ${lD.full} ${formatRanking(lR.full)}</div>
                            </div>
                            <div class="text-yellow-400 text-xs md:text-sm text-center font-bold border-t border-white/20 pt-2">
                                <span class="block mb-1">ğŸ  HOME</span>
                                <div class="grid grid-cols-3 gap-1">
                                    <div>1Q: ${lD.q1Home} ${formatRanking(lR.q1Home)}</div>
                                    <div>1H: ${lD.halfHome} ${formatRanking(lR.halfHome)}</div>
                                    <div>Full: ${lD.fullHome} ${formatRanking(lR.fullHome)}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="p-3 md:p-4 rounded-xl border border-orange-500/30" style="background: linear-gradient(135deg, #4a2c2a 0%, #0d1b2a 100%);">
                    <h2 class="text-base md:text-lg font-bold text-orange-400 mb-2 text-center">âœˆï¸ EQUIPO VISITANTE</h2>
                    <select id="visitingSelect" class="select-premium w-full">
                        ${opts.replace(`value="${visitingTeam}"`, `value="${visitingTeam}" selected`)}
                    </select>
                    ${vD && vR ? `
                        <div class="mt-3 rounded-lg p-2 md:p-3" style="background: rgba(0,0,0,0.3);">
                            <div class="text-orange-300 text-xs md:text-sm text-center mb-2 font-semibold">ğŸ“Š Temporada 2025-26</div>
                            <div class="grid grid-cols-3 gap-1 text-center text-xs md:text-sm mb-2">
                                <div class="text-white">1Q: ${vD.q1} ${formatRanking(vR.q1)}</div>
                                <div class="text-white">1H: ${vD.half} ${formatRanking(vR.half)}</div>
                                <div class="text-white">Full: ${vD.full} ${formatRanking(vR.full)}</div>
                            </div>
                            <div class="text-yellow-400 text-xs md:text-sm text-center font-bold border-t border-white/20 pt-2">
                                <span class="block mb-1">âœˆï¸ AWAY</span>
                                <div class="grid grid-cols-3 gap-1">
                                    <div>1Q: ${vD.q1Away} ${formatRanking(vR.q1Away)}</div>
                                    <div>1H: ${vD.halfAway} ${formatRanking(vR.halfAway)}</div>
                                    <div>Full: ${vD.fullAway} ${formatRanking(vR.fullAway)}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
    `;
    
    if (localTeam && visitingTeam) {
        // Calcular lÃ­neas sugeridas (redondeadas a .5)
        const suggestedQ1 = (Math.round(parseFloat(trends.q1) * 2) / 2).toFixed(1);
        const suggestedHalf = (Math.round(parseFloat(trends.half) * 2) / 2).toFixed(1);
        const suggestedFull = (Math.round(parseFloat(trends.full) * 2) / 2).toFixed(1);
        
        html += `
            <div class="rounded-2xl p-3 md:p-5 shadow-xl mb-6 border border-yellow-500/30" style="background: linear-gradient(135deg, #1b263b 0%, #0d1b2a 100%);">
                <h2 class="text-lg md:text-xl font-bold text-yellow-400 mb-1 text-center font-display tracking-wide">ğŸ“ˆ PREDICCIÃ“N DEL MODELO v2.5</h2>
                <p class="text-center text-gray-400 text-xs md:text-sm mb-2">${localTeam} (HOME) vs ${visitingTeam} (AWAY)</p>
                
                ${advancedData ? `
                    <!-- Badges de factores activos -->
                    <div class="flex flex-wrap justify-center gap-2 mb-2">
                        ${advancedData.combinedPace ? `<span class="badge-neon badge-neon-blue" title="Ritmo combinado">âš¡ ${advancedData.combinedPace.toFixed(1)}</span>` : ''}
                        ${advancedData.components?.full?.altitude ? `<span class="badge-neon badge-neon-yellow">ğŸ”ï¸ +${advancedData.components.full.altitude}</span>` : ''}
                        ${localB2B ? `<span class="badge-neon badge-neon-pink">ğŸ”´ ${localTeam} B2B</span>` : ''}
                        ${awayB2B ? `<span class="badge-neon badge-neon-pink">ğŸ”´ ${visitingTeam} B2B</span>` : ''}
                        ${localInjury ? `<span class="badge-neon badge-neon-pink">ğŸ¥ ${localTeam}</span>` : ''}
                        ${awayInjury ? `<span class="badge-neon badge-neon-pink">ğŸ¥ ${visitingTeam}</span>` : ''}
                        ${localRestDays >= 3 ? `<span class="badge-neon badge-neon-green">ğŸ’ª ${localTeam} +${localRestDays}d</span>` : ''}
                        ${awayRestDays >= 3 ? `<span class="badge-neon badge-neon-green">ğŸ’ª ${visitingTeam} +${awayRestDays}d</span>` : ''}
                        ${localStreak >= 3 ? `<span class="badge-neon badge-neon-green">ğŸ”¥ ${localTeam} +${localStreak}</span>` : ''}
                        ${localStreak <= -3 ? `<span class="badge-neon badge-neon-pink">â„ï¸ ${localTeam} ${localStreak}</span>` : ''}
                        ${awayStreak >= 3 ? `<span class="badge-neon badge-neon-green">ğŸ”¥ ${visitingTeam} +${awayStreak}</span>` : ''}
                        ${awayStreak <= -3 ? `<span class="badge-neon badge-neon-pink">â„ï¸ ${visitingTeam} ${awayStreak}</span>` : ''}
                        ${awayTravel === 'crossCountry' ? `<span class="badge-neon badge-neon-blue">âœˆï¸ Costa-Costa</span>` : ''}
                        ${isDivisionRivalry ? `<span class="badge-neon badge-neon-yellow">âš”ï¸ DivisiÃ³n</span>` : ''}
                        ${gameDay === 'friday' || gameDay === 'saturday' ? `<span class="badge-neon badge-neon-green">ğŸ‰ Fin de semana</span>` : ''}
                        <span class="badge-neon ${advancedData.confidence >= 85 ? 'badge-neon-green' : advancedData.confidence >= 75 ? 'badge-neon-yellow' : 'badge-neon-pink'}">ğŸ¯ ${advancedData.confidence}%</span>
                    </div>
                    
                    <!-- PANEL DE AJUSTES CONTEXTUALES v2.5 -->
                    <details class="mb-3">
                        <summary class="text-sm text-cyan-400 cursor-pointer hover:text-cyan-300 font-semibold text-center">âš™ï¸ Ajustes Contextuales (8 factores - ${autoDetectEnabled ? 'ğŸ¤– AUTO' : 'âœ‹ MANUAL'})</summary>
                        <div class="mt-3 bg-white/5 rounded-xl p-4 space-y-4">
                            
                            <!-- Toggle Auto-DetecciÃ³n + BotÃ³n Refresh -->
                            <div class="flex items-center justify-between bg-cyan-500/10 rounded-lg p-3 border border-cyan-500/30">
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 text-xs text-cyan-400 cursor-pointer">
                                        <input type="checkbox" ${autoDetectEnabled ? 'checked' : ''} onchange="autoDetectEnabled = this.checked; debouncedRender();" class="w-4 h-4 accent-cyan-500">
                                        <span class="font-bold">ğŸ¤– Auto-DetecciÃ³n</span>
                                    </label>
                                    <span class="text-xs text-gray-400">(B2B, Descanso, Rachas, Viaje, DivisiÃ³n, DÃ­a)</span>
                                </div>
                                <button onclick="autoDetectContextualFactors('${localTeam}', '${visitingTeam}').then(() => render())" 
                                    class="bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 text-xs px-3 py-1 rounded-lg font-bold transition-all">
                                    ğŸ”„ Actualizar
                                </button>
                            </div>
                            
                            ${autoDetectEnabled ? `
                            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-2 text-center">
                                <p class="text-xs text-green-400">âœ… Datos obtenidos automÃ¡ticamente desde API. Solo <strong>Lesiones</strong> requiere input manual.</p>
                            </div>
                            ` : ''}
                            
                            <!-- Fila 1: B2B -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-red-500/10 rounded-lg p-3 border border-red-500/20">
                                    <p class="text-xs text-red-400 font-bold mb-2 text-center">ğŸ”´ Back-to-Back (B2B)</p>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                                            <input type="checkbox" ${localB2B ? 'checked' : ''} onchange="localB2B = this.checked; debouncedRender();" class="w-4 h-4 accent-red-500">
                                            <span>ğŸ  ${localTeam || 'Local'} jugÃ³ ayer</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                                            <input type="checkbox" ${awayB2B ? 'checked' : ''} onchange="awayB2B = this.checked; debouncedRender();" class="w-4 h-4 accent-red-500">
                                            <span>âœˆï¸ ${visitingTeam || 'Visitante'} jugÃ³ ayer</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 text-center">-1.25 pts por equipo</p>
                                </div>
                                
                                <!-- Injuries -->
                                <div class="bg-pink-500/10 rounded-lg p-3 border border-pink-500/20">
                                    <p class="text-xs text-pink-400 font-bold mb-2 text-center">ğŸ¥ Estrella Lesionada</p>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                                            <input type="checkbox" ${localInjury ? 'checked' : ''} onchange="localInjury = this.checked; debouncedRender();" class="w-4 h-4 accent-pink-500">
                                            <span>ğŸ  ${localTeam || 'Local'} sin estrella</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-xs text-gray-300 cursor-pointer">
                                            <input type="checkbox" ${awayInjury ? 'checked' : ''} onchange="awayInjury = this.checked; debouncedRender();" class="w-4 h-4 accent-pink-500">
                                            <span>âœˆï¸ ${visitingTeam || 'Visitante'} sin estrella</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 text-center">-3.5 pts por equipo</p>
                                </div>
                            </div>
                            
                            <!-- Fila 2: Rest Days -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-green-500/10 rounded-lg p-3 border border-green-500/20">
                                    <p class="text-xs text-green-400 font-bold mb-2 text-center">ğŸ’ª DÃ­as de Descanso</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">ğŸ  ${localTeam || 'Local'}:</span>
                                            <select onchange="localRestDays = safeParseInt(this.value, 1); debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="1" ${localRestDays === 1 ? 'selected' : ''}>1 dÃ­a (normal)</option>
                                                <option value="2" ${localRestDays === 2 ? 'selected' : ''}>2 dÃ­as (+0.5)</option>
                                                <option value="3" ${localRestDays === 3 ? 'selected' : ''}>3+ dÃ­as (+1.5)</option>
                                                <option value="4" ${localRestDays === 4 ? 'selected' : ''}>4+ dÃ­as (+1.5)</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">âœˆï¸ ${visitingTeam || 'Visitante'}:</span>
                                            <select onchange="awayRestDays = safeParseInt(this.value, 1); debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="1" ${awayRestDays === 1 ? 'selected' : ''}>1 dÃ­a (normal)</option>
                                                <option value="2" ${awayRestDays === 2 ? 'selected' : ''}>2 dÃ­as (+0.5)</option>
                                                <option value="3" ${awayRestDays === 3 ? 'selected' : ''}>3+ dÃ­as (+1.5)</option>
                                                <option value="4" ${awayRestDays === 4 ? 'selected' : ''}>4+ dÃ­as (+1.5)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Streaks -->
                                <div class="bg-orange-500/10 rounded-lg p-3 border border-orange-500/20">
                                    <p class="text-xs text-orange-400 font-bold mb-2 text-center">ğŸ”¥ Rachas (Ãºltimos 5)</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">ğŸ  ${localTeam || 'Local'}:</span>
                                            <select onchange="localStreak = safeParseInt(this.value, 0); debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="-5" ${localStreak === -5 ? 'selected' : ''}>-5 (muy frÃ­a)</option>
                                                <option value="-4" ${localStreak === -4 ? 'selected' : ''}>-4</option>
                                                <option value="-3" ${localStreak === -3 ? 'selected' : ''}>-3</option>
                                                <option value="-2" ${localStreak === -2 ? 'selected' : ''}>-2</option>
                                                <option value="-1" ${localStreak === -1 ? 'selected' : ''}>-1</option>
                                                <option value="0" ${localStreak === 0 ? 'selected' : ''}>0 (neutral)</option>
                                                <option value="1" ${localStreak === 1 ? 'selected' : ''}>+1</option>
                                                <option value="2" ${localStreak === 2 ? 'selected' : ''}>+2</option>
                                                <option value="3" ${localStreak === 3 ? 'selected' : ''}>+3</option>
                                                <option value="4" ${localStreak === 4 ? 'selected' : ''}>+4</option>
                                                <option value="5" ${localStreak === 5 ? 'selected' : ''}>+5 (muy caliente)</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">âœˆï¸ ${visitingTeam || 'Visitante'}:</span>
                                            <select onchange="awayStreak = safeParseInt(this.value, 0); debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="-5" ${awayStreak === -5 ? 'selected' : ''}>-5 (muy frÃ­a)</option>
                                                <option value="-4" ${awayStreak === -4 ? 'selected' : ''}>-4</option>
                                                <option value="-3" ${awayStreak === -3 ? 'selected' : ''}>-3</option>
                                                <option value="-2" ${awayStreak === -2 ? 'selected' : ''}>-2</option>
                                                <option value="-1" ${awayStreak === -1 ? 'selected' : ''}>-1</option>
                                                <option value="0" ${awayStreak === 0 ? 'selected' : ''}>0 (neutral)</option>
                                                <option value="1" ${awayStreak === 1 ? 'selected' : ''}>+1</option>
                                                <option value="2" ${awayStreak === 2 ? 'selected' : ''}>+2</option>
                                                <option value="3" ${awayStreak === 3 ? 'selected' : ''}>+3</option>
                                                <option value="4" ${awayStreak === 4 ? 'selected' : ''}>+4</option>
                                                <option value="5" ${awayStreak === 5 ? 'selected' : ''}>+5 (muy caliente)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2 text-center">Â±0.25 pts por partido</p>
                                </div>
                            </div>
                            
                            <!-- Fila 3: Travel, Schedule Density -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-500/10 rounded-lg p-3 border border-blue-500/20">
                                    <p class="text-xs text-blue-400 font-bold mb-2 text-center">âœˆï¸ Viaje Visitante</p>
                                    <select onchange="awayTravel = this.value; debouncedRender();" class="w-full bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                        <option value="none" ${awayTravel === 'none' ? 'selected' : ''}>Normal (misma zona)</option>
                                        <option value="moderate" ${awayTravel === 'moderate' ? 'selected' : ''}>Moderado 1-2 zonas (-0.5)</option>
                                        <option value="crossCountry" ${awayTravel === 'crossCountry' ? 'selected' : ''}>Costa a Costa 3+ (-1.0)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-2 text-center">Fatiga por viaje largo</p>
                                </div>
                                
                                <div class="bg-purple-500/10 rounded-lg p-3 border border-purple-500/20">
                                    <p class="text-xs text-purple-400 font-bold mb-2 text-center">ğŸ“… Densidad Schedule</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">ğŸ :</span>
                                            <select onchange="localScheduleDensity = this.value; debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="normal" ${localScheduleDensity === 'normal' ? 'selected' : ''}>Normal</option>
                                                <option value="3in4" ${localScheduleDensity === '3in4' ? 'selected' : ''}>3 en 4 dÃ­as (-0.75)</option>
                                                <option value="4in5" ${localScheduleDensity === '4in5' ? 'selected' : ''}>4 en 5 dÃ­as (-1.5)</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-300">âœˆï¸:</span>
                                            <select onchange="awayScheduleDensity = this.value; debouncedRender();" class="bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                                <option value="normal" ${awayScheduleDensity === 'normal' ? 'selected' : ''}>Normal</option>
                                                <option value="3in4" ${awayScheduleDensity === '3in4' ? 'selected' : ''}>3 en 4 dÃ­as (-0.75)</option>
                                                <option value="4in5" ${awayScheduleDensity === '4in5' ? 'selected' : ''}>4 en 5 dÃ­as (-1.5)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fila 4: Division Rivalry, Day of Week -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/20">
                                    <p class="text-xs text-yellow-400 font-bold mb-2 text-center">âš”ï¸ Rivalidad DivisiÃ³n</p>
                                    <label class="flex items-center justify-center gap-2 text-xs text-gray-300 cursor-pointer">
                                        <input type="checkbox" ${isDivisionRivalry ? 'checked' : ''} onchange="isDivisionRivalry = this.checked; debouncedRender();" class="w-4 h-4 accent-yellow-500">
                                        <span>Misma divisiÃ³n (+2.0 pts)</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-2 text-center">Partidos mÃ¡s intensos</p>
                                </div>
                                
                                <div class="bg-cyan-500/10 rounded-lg p-3 border border-cyan-500/20">
                                    <p class="text-xs text-cyan-400 font-bold mb-2 text-center">ğŸ“† DÃ­a de Juego</p>
                                    <select onchange="gameDay = this.value; debouncedRender();" class="w-full bg-white/10 text-white text-xs rounded px-2 py-1 border border-white/20">
                                        <option value="weekday" ${gameDay === 'weekday' ? 'selected' : ''}>Lun-Jue (normal)</option>
                                        <option value="friday" ${gameDay === 'friday' ? 'selected' : ''}>Viernes (+1.5)</option>
                                        <option value="saturday" ${gameDay === 'saturday' ? 'selected' : ''}>SÃ¡bado (+1.5)</option>
                                        <option value="sunday" ${gameDay === 'sunday' ? 'selected' : ''}>Domingo (+0.5)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-2 text-center">MÃ¡s puntos fines de semana</p>
                                </div>
                            </div>
                            
                            <!-- Resumen de ajustes activos -->
                            <div class="bg-white/5 rounded-lg p-2 text-center">
                                <p class="text-xs text-gray-400">
                                    <strong class="text-white">Ajustes activos:</strong>
                                    ${localB2B || awayB2B ? `B2B: ${((localB2B ? -1.25 : 0) + (awayB2B ? -1.25 : 0)).toFixed(2)} | ` : ''}
                                    ${localInjury || awayInjury ? `Lesiones: ${((localInjury ? -3.5 : 0) + (awayInjury ? -3.5 : 0)).toFixed(1)} | ` : ''}
                                    ${localRestDays >= 2 || awayRestDays >= 2 ? `Descanso: +${((localRestDays >= 3 ? 1.5 : localRestDays === 2 ? 0.5 : 0) + (awayRestDays >= 3 ? 1.5 : awayRestDays === 2 ? 0.5 : 0)).toFixed(1)} | ` : ''}
                                    ${localStreak !== 0 || awayStreak !== 0 ? `Rachas: ${((localStreak + awayStreak) * 0.25).toFixed(2)} | ` : ''}
                                    ${awayTravel !== 'none' ? `Travel: ${awayTravel === 'crossCountry' ? '-1.0' : '-0.5'} | ` : ''}
                                    ${localScheduleDensity !== 'normal' || awayScheduleDensity !== 'normal' ? `Schedule: ${((localScheduleDensity === '4in5' ? -1.5 : localScheduleDensity === '3in4' ? -0.75 : 0) + (awayScheduleDensity === '4in5' ? -1.5 : awayScheduleDensity === '3in4' ? -0.75 : 0)).toFixed(2)} | ` : ''}
                                    ${isDivisionRivalry ? `DivisiÃ³n: +2.0 | ` : ''}
                                    ${gameDay !== 'weekday' ? `DÃ­a: +${gameDay === 'sunday' ? '0.5' : '1.5'}` : ''}
                                </p>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Mini-guÃ­a de interpretaciÃ³n -->
                    <div class="flex flex-wrap justify-center gap-3 text-xs text-gray-400 mb-3">
                        ${advancedData.components?.full?.pace !== undefined ? `<span class="${(advancedData.components.full.pace || 0) > 0.3 ? 'text-green-400' : (advancedData.components.full.pace || 0) < -0.3 ? 'text-red-400' : 'text-gray-400'}">
                            ${(advancedData.components.full.pace || 0) > 0.3 ? 'â†‘ Ritmo rÃ¡pido (+pts)' : (advancedData.components.full.pace || 0) < -0.3 ? 'â†“ Ritmo lento (-pts)' : 'â†’ Ritmo promedio'}
                        </span>` : ''}
                        <span class="${advancedData.confidence >= 85 ? 'text-green-400' : advancedData.confidence >= 75 ? 'text-yellow-400' : 'text-red-400'}">
                            ${advancedData.confidence >= 85 ? 'âœ“ Alta fiabilidad' : advancedData.confidence >= 75 ? '~ Fiabilidad moderada' : 'âš  Usar con cautela'}
                        </span>
                    </div>
                    
                    ${advancedData.warnings.length > 0 ? `
                        <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-2 mb-3 text-xs text-yellow-400 text-center">
                            ${advancedData.warnings.join(' | ')}
                        </div>
                    ` : ''}
                ` : ''}
                
                <div class="grid grid-cols-3 gap-2 md:gap-4">
                    <div class="trend-card bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl p-3 md:p-4 text-center">
                        <p class="text-xs md:text-sm font-bold text-white/90">1Q</p>
                        <p class="text-2xl md:text-4xl font-black text-white number-glow">${trends.q1}</p>
                        <p class="text-xs text-white/70 mt-1">LÃ­nea: ${suggestedQ1}</p>
                    </div>
                    <div class="trend-card bg-gradient-to-br from-pink-500 to-purple-600 rounded-xl p-3 md:p-4 text-center">
                        <p class="text-xs md:text-sm font-bold text-white/90">1H</p>
                        <p class="text-2xl md:text-4xl font-black text-white number-glow">${trends.half}</p>
                        <p class="text-xs text-white/70 mt-1">LÃ­nea: ${suggestedHalf}</p>
                    </div>
                    <div class="trend-card bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-3 md:p-4 text-center">
                        <p class="text-xs md:text-sm font-bold text-white/90">FULL</p>
                        <p class="text-2xl md:text-4xl font-black text-white number-glow">${trends.full}</p>
                        <p class="text-xs text-white/70 mt-1">LÃ­nea: ${suggestedFull}</p>
                    </div>
                </div>
                
                ${advancedData ? `
                    <!-- Desglose del modelo con explicaciones -->
                    <details class="mt-3">
                        <summary class="text-xs text-gray-400 cursor-pointer hover:text-white font-semibold">ğŸ”¬ Ver desglose del cÃ¡lculo (clic para entender cada nÃºmero)</summary>
                        <div class="mt-2 bg-white/5 rounded-lg p-3 text-xs">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <div class="text-center bg-white/10 p-2 rounded-lg">
                                    <div class="font-bold text-white">Ofensivo</div>
                                    <div class="text-green-400 text-lg font-bold">${advancedData.components?.full?.offense?.toFixed(1) || '-'}</div>
                                    <div class="text-gray-400 text-xs mt-1">PPG combinado</div>
                                </div>
                                <div class="text-center bg-white/10 p-2 rounded-lg">
                                    <div class="font-bold text-white">Defensivo</div>
                                    <div class="text-red-400 text-lg font-bold">${advancedData.components?.full?.defense?.toFixed(1) || '-'}</div>
                                    <div class="text-gray-400 text-xs mt-1">Pts permitidos</div>
                                </div>
                                <div class="text-center bg-white/10 p-2 rounded-lg">
                                    <div class="font-bold text-white">PACE adj.</div>
                                    <div class="text-blue-400 text-lg font-bold">${advancedData.components?.full?.pace?.toFixed(2) || '0'}</div>
                                    <div class="text-gray-400 text-xs mt-1">${
                                        (advancedData.components?.full?.pace || 0) > 0.3 ? 'â†‘ RÃ¡pido (+pts)' : 
                                        (advancedData.components?.full?.pace || 0) < -0.3 ? 'â†“ Lento (-pts)' : 
                                        'â†’ Normal'
                                    }</div>
                                </div>
                                <div class="text-center bg-white/10 p-2 rounded-lg">
                                    <div class="font-bold text-white">Contexto</div>
                                    <div class="text-purple-400 text-lg font-bold">+${advancedData.components?.full?.context?.toFixed(1) || '2.5'}</div>
                                    <div class="text-gray-400 text-xs mt-1">HCA${advancedData.components?.full?.altitude ? ' + Alt' : ''}</div>
                                </div>
                            </div>
                            
                            ${(localB2B || awayB2B) ? `
                            <!-- B2B Adjustment -->
                            <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-center gap-2 text-red-400 text-sm font-bold">
                                    <span>ğŸ˜´ B2B Penalty:</span>
                                    <span class="text-lg">${advancedData.components?.full?.b2b?.toFixed(2) || '-2.50'} pts</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${(localRestDays >= 2 || awayRestDays >= 2) ? `
                            <!-- Rest Days Bonus -->
                            <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-center gap-2 text-green-400 text-sm font-bold">
                                    <span>ğŸ’ª Rest Bonus:</span>
                                    <span class="text-lg">+${advancedData.components?.full?.rest?.toFixed(2) || '0'} pts</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${(localInjury || awayInjury) ? `
                            <!-- Injury Penalty -->
                            <div class="bg-pink-500/20 border border-pink-500/30 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-center gap-2 text-pink-400 text-sm font-bold">
                                    <span>ğŸ¥ Injury Penalty:</span>
                                    <span class="text-lg">${advancedData.components?.full?.injury?.toFixed(2) || '-3.50'} pts</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${(localStreak !== 0 || awayStreak !== 0) ? `
                            <!-- Streak Factor -->
                            <div class="bg-orange-500/20 border border-orange-500/30 rounded-lg p-2 mb-3">
                                <div class="flex items-center justify-center gap-2 text-orange-400 text-sm font-bold">
                                    <span>ğŸ”¥ Streak Factor:</span>
                                    <span class="text-lg">${advancedData.components?.full?.streak >= 0 ? '+' : ''}${advancedData.components?.full?.streak?.toFixed(2) || '0'} pts</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- ExplicaciÃ³n de cada componente -->
                            <div class="bg-blue-500/10 rounded-lg p-3 text-xs text-gray-300 space-y-2">
                                <p><strong class="text-green-400">ğŸ€ Ofensivo:</strong> Suma de puntos que anota ${localTeam} en casa + ${visitingTeam} de visita.</p>
                                <p><strong class="text-red-400">ğŸ›¡ï¸ Defensivo:</strong> Suma de puntos que PERMITE cada defensa.</p>
                                <p><strong class="text-blue-400">âš¡ PACE:</strong> Ajuste por ritmo de juego combinado.</p>
                                <p><strong class="text-purple-400">ğŸ  Contexto:</strong> HCA +2.5 pts${advancedData.components?.full?.altitude ? ' + altitud' : ''}.</p>
                                ${(localB2B || awayB2B) ? `<p><strong class="text-red-400">ğŸ˜´ B2B:</strong> -1.25 pts por equipo que jugÃ³ ayer.</p>` : ''}
                                ${(localRestDays >= 2 || awayRestDays >= 2) ? `<p><strong class="text-green-400">ğŸ’ª Descanso:</strong> +0.5/+1.5 pts por 2/3+ dÃ­as de descanso.</p>` : ''}
                                ${(localInjury || awayInjury) ? `<p><strong class="text-pink-400">ğŸ¥ Lesiones:</strong> -3.5 pts por estrella ausente.</p>` : ''}
                                ${(localStreak !== 0 || awayStreak !== 0) ? `<p><strong class="text-orange-400">ğŸ”¥ Rachas:</strong> Â±0.25 pts por partido de racha (mÃ¡x Â±5).</p>` : ''}
                            </div>
                            
                            <!-- FÃ³rmula simplificada -->
                            <div class="mt-2 bg-white/5 rounded-lg p-2 text-center text-xs text-gray-400">
                                <strong>FÃ³rmula:</strong> Base + PACE + Contexto${(localB2B || awayB2B) ? ' + B2B' : ''}${(localRestDays >= 2 || awayRestDays >= 2) ? ' + Rest' : ''}${(localInjury || awayInjury) ? ' + Injury' : ''}${(localStreak !== 0 || awayStreak !== 0) ? ' + Streak' : ''} + RegresiÃ³n
                            </div>
                        </div>
                    </details>
                ` : ''}
            </div>
            ${renderH2HSection()}
            <div class="glass rounded-2xl p-3 md:p-5 shadow-xl mt-6 border border-white/10">
                <h2 class="text-lg md:text-xl font-bold text-white mb-4 text-center">ğŸ¯ CALCULADORA PRO - Expected Value</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                    ${renderCalc('Q1', '1Q', trends.q1, pQ1, typeQ1, lineQ1, oddsQ1)}
                    ${renderCalc('Half', '1H', trends.half, pHalf, typeHalf, lineHalf, oddsHalf)}
                    ${renderCalc('Full', 'FULL', trends.full, pFull, typeFull, lineFull, oddsFull)}
                </div>
                
                <!-- Leyenda EV -->
                <div class="mt-4 bg-white/5 rounded-xl p-4 border border-white/10">
                    <details class="text-white">
                        <summary class="font-bold cursor-pointer text-sm">ğŸ“– Â¿CÃ³mo interpretar? (clic para expandir)</summary>
                        <div class="mt-3 text-xs space-y-2 text-gray-300">
                            <p><strong class="text-white">ğŸ“Š Prob. Ganar:</strong> Probabilidad estadÃ­stica de que el pick gane</p>
                            <p><strong class="text-white">ğŸ’° Cuota Justa:</strong> La cuota mÃ­nima que deberÃ­as aceptar. Si la casa ofrece mÃ¡s = valor</p>
                            <p><strong class="text-white">ğŸ“ˆ Expected Value (EV):</strong> Ganancia esperada por cada $100 apostados. EV +5% = ganas $5 por cada $100 a largo plazo</p>
                            <p><strong class="text-white">âš¡ Edge:</strong> Tu ventaja sobre la casa. Edge +10% = 10% mÃ¡s probabilidad de lo que la casa cree</p>
                            <div class="mt-2 pt-2 border-t border-white/20">
                                <p class="text-yellow-300 font-bold">ğŸ¯ REGLA DE ORO:</p>
                                <p>â€¢ EV â‰¥ +3% = âœ… APOSTAR</p>
                                <p>â€¢ EV â‰¥ +7% = ğŸ’ ALTO VALOR</p>
                                <p>â€¢ EV â‰¥ +15% = ğŸ”¥ ELITE (raro)</p>
                                <p>â€¢ EV < 0% = âŒ NO APOSTAR</p>
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- ExplicaciÃ³n del Modelo EstadÃ­stico v2.5 -->
                <div class="mt-3 bg-white/5 rounded-xl p-4 border border-white/10">
                    <details class="text-white">
                        <summary class="font-bold cursor-pointer text-sm">ğŸ”¬ Modelo EstadÃ­stico v2.5 (clic para ver)</summary>
                        <div class="mt-3 text-xs space-y-2 text-gray-300">
                            <p class="text-cyan-300 font-bold">ğŸ“š Basado en: XGBoost/SHAP (PLOS ONE 2024), Bayesian Models (icSPORTS 2023), FiveThirtyEight</p>
                            
                            <div class="mt-2 bg-black/30 rounded-lg p-3">
                                <p class="text-yellow-300 font-bold mb-2">ğŸ§  Componentes del Modelo v2.0:</p>
                                <p>â€¢ <strong class="text-green-400">Ofensivo (40%):</strong> PPG Home/Away del equipo</p>
                                <p>â€¢ <strong class="text-red-400">Defensivo (35%):</strong> Puntos que PERMITE cada defensa</p>
                                <p>â€¢ <strong class="text-blue-400">PACE (15%):</strong> Ajuste por ritmo de juego</p>
                                <p>â€¢ <strong class="text-purple-400">Contexto (10%):</strong> HCA (+2.5), Altitud Denver (+2.5)</p>
                            </div>
                            
                            <div class="mt-2 bg-black/30 rounded-lg p-3">
                                <p class="text-yellow-300 font-bold mb-2">ğŸ“Š DesviaciÃ³n EstÃ¡ndar DinÃ¡mica:</p>
                                <p>â€¢ <strong class="text-orange-400">1Q:</strong> Â±8 pts (ajustado por PACE)</p>
                                <p>â€¢ <strong class="text-pink-400">1H:</strong> Â±13 pts (ajustado por PACE)</p>
                                <p>â€¢ <strong class="text-green-400">FULL:</strong> Â±18.5 pts (ajustado por PACE)</p>
                                <p class="text-gray-400 mt-1">MÃ¡s PACE = mÃ¡s varianza en resultados</p>
                            </div>
                            
                            <div class="mt-2 bg-black/30 rounded-lg p-3">
                                <p class="text-lime-300 font-bold mb-2">ğŸ”„ CalibraciÃ³n Inteligente:</p>
                                <p>â€¢ <strong class="text-white">Early Season (&lt;10 juegos):</strong> RegresiÃ³n 30% hacia media</p>
                                <p>â€¢ <strong class="text-white">Mid Season (10-25 juegos):</strong> RegresiÃ³n 15%</p>
                                <p>â€¢ <strong class="text-white">Late Season (25+ juegos):</strong> RegresiÃ³n 5%</p>
                                <p class="text-yellow-300 mt-1">âš ï¸ Early Season: 58% histÃ³rico de UNDERs</p>
                            </div>
                            
                            <div class="mt-2 pt-2 border-t border-white/20">
                                <p class="text-lime-300 font-bold">ğŸ¯ PrecisiÃ³n Esperada:</p>
                                <p>â€¢ Win Rate objetivo: <strong class="text-white">55-57%</strong> (vs 52.4% break-even)</p>
                                <p>â€¢ ROI objetivo: <strong class="text-white">3-8%</strong> a largo plazo</p>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            
            <!-- BET BUILDER - PICKS COMBINADOS -->
            ${(() => {
                const hasQ1 = lineQ1 && pQ1;
                const hasHalf = lineHalf && pHalf;
                const hasFull = lineFull && pFull;
                const validPicks = [hasQ1, hasHalf, hasFull].filter(Boolean).length;
                
                if (validPicks >= 2) {
                    return `
                    <div class="bg-gradient-to-br from-amber-600 to-orange-700 rounded-2xl p-5 shadow-xl">
                        <h3 class="text-lg font-bold text-white mb-4 text-center">ğŸ”¥ BET BUILDER - Combo</h3>
                        <p class="text-white/70 text-xs text-center mb-4">Selecciona los picks para tu combinada</p>
                        
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${hasQ1 ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_q1" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">1Q ${typeQ1}</div>
                                        <div class="text-xs opacity-80">${lineQ1} (${pQ1}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                            ${hasHalf ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_half" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">1H ${typeHalf}</div>
                                        <div class="text-xs opacity-80">${lineHalf} (${pHalf}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                            ${hasFull ? `
                                <label class="flex items-center gap-2 bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30">
                                    <input type="checkbox" id="combo_full" class="w-5 h-5 accent-green-500" checked>
                                    <div class="text-white text-sm">
                                        <div class="font-bold">FULL ${typeFull}</div>
                                        <div class="text-xs opacity-80">${lineFull} (${pFull}%)</div>
                                    </div>
                                </label>
                            ` : '<div></div>'}
                        </div>
                        
                        <div class="bg-black/20 rounded-xl p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white/80 text-sm">Cuota Combinada:</span>
                                <input type="number" step="0.01" id="combo_odds" placeholder="ej: 2.05" 
                                    class="w-24 p-2 rounded-lg text-center font-bold bg-white/10 text-white border border-white/20">
                            </div>
                            <p class="text-white/60 text-xs">Ingresa la cuota total del Bet Builder de tu casa de apuestas</p>
                        </div>
                        
                        <button onclick="registerBetBuilder()" 
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg transition-all">
                            ğŸ¯ Registrar Bet Builder
                        </button>
                    </div>
                    `;
                }
                return '';
            })()}
            
            <!-- BOTÃ“N REGISTRAR PICK INDIVIDUAL -->
            <div class="bg-gradient-to-br from-pink-600 to-rose-700 rounded-2xl p-5 shadow-xl mt-6">
                <h3 class="text-lg font-bold text-white mb-4 text-center">ğŸ“ Registrar Pick</h3>
                <div class="grid grid-cols-3 gap-3">
                    ${lineQ1 && pQ1 ? (() => {
                        const evQ1 = oddsQ1 ? calcEV(pQ1, oddsQ1) : null;
                        const verdictQ1 = evVerdict(evQ1, pQ1, null);
                        return `
                        <button onclick="registerPick('1Q', '${typeQ1}', '${lineQ1}', ${pQ1}, '${oddsQ1 || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evQ1 && parseFloat(evQ1) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">1Q ${typeQ1}</div>
                            <div class="text-xs">${lineQ1} (${pQ1}%)</div>
                            ${evQ1 ? `<div class="text-xs mt-1 ${parseFloat(evQ1) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evQ1) >= 0 ? '+' : ''}${evQ1}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                    ${lineHalf && pHalf ? (() => {
                        const evHalf = oddsHalf ? calcEV(pHalf, oddsHalf) : null;
                        const verdictHalf = evVerdict(evHalf, pHalf, null);
                        return `
                        <button onclick="registerPick('1H', '${typeHalf}', '${lineHalf}', ${pHalf}, '${oddsHalf || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evHalf && parseFloat(evHalf) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">1H ${typeHalf}</div>
                            <div class="text-xs">${lineHalf} (${pHalf}%)</div>
                            ${evHalf ? `<div class="text-xs mt-1 ${parseFloat(evHalf) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evHalf) >= 0 ? '+' : ''}${evHalf}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                    ${lineFull && pFull ? (() => {
                        const evFull = oddsFull ? calcEV(pFull, oddsFull) : null;
                        const verdictFull = evVerdict(evFull, pFull, null);
                        return `
                        <button onclick="registerPick('FULL', '${typeFull}', '${lineFull}', ${pFull}, '${oddsFull || ''}')" 
                            class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-lg text-sm ${evFull && parseFloat(evFull) >= 3 ? 'ring-2 ring-green-400' : ''}">
                            <div class="font-bold">FULL ${typeFull}</div>
                            <div class="text-xs">${lineFull} (${pFull}%)</div>
                            ${evFull ? `<div class="text-xs mt-1 ${parseFloat(evFull) >= 0 ? 'text-green-300' : 'text-red-300'}">EV: ${parseFloat(evFull) >= 0 ? '+' : ''}${evFull}%</div>` : ''}
                        </button>`;
                    })() : '<div></div>'}
                </div>
            </div>
        `;
    } else {
        html += `<div class="glass rounded-xl p-10 text-center"><p class="text-white font-bold text-xl">ğŸ‘† Selecciona dos equipos</p></div>`;
    }
    
    html += '</div>';
    return html;
}

function renderH2HSection() {
    const h2h = getH2HData(localTeam, visitingTeam);
    if (!h2h) {
        return `
            <div class="h2h-card rounded-2xl p-5 shadow-2xl mt-6 border border-yellow-500/30">
                <div class="text-center py-6">
                    <div class="text-5xl mb-4">ğŸ“</div>
                    <p class="text-yellow-400 font-bold">No hay datos H2H para ${localTeam} vs ${visitingTeam}</p>
                    <button onclick="goToIngestWithTeams()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">â• Agregar Partidos</button>
                </div>
            </div>
        `;
    }
    
    const t1W = h2h.record.team1Wins, t2W = h2h.record.team2Wins;
    let gh = h2h.games.map((g,i) => `
        <div class="grid grid-cols-5 gap-2 text-sm py-2 ${i%2===0?'bg-white/5':''} rounded">
            <span class="text-gray-300 text-xs">${g.date}${g.overtimes>0?` <span class="text-yellow-400">(${g.overtimes}OT)</span>`:''}</span>
            <span class="text-center text-yellow-400 font-bold">${g.t1Q1+g.t2Q1}</span>
            <span class="text-center text-pink-400 font-bold">${g.t1Half+g.t2Half}</span>
            <span class="text-center text-green-400 font-bold">${g.totalPts}</span>
            <span class="text-center font-bold ${g.winner===localTeam?'text-cyan-400':'text-orange-400'}">${g.winner}</span>
        </div>
    `).join('');
    
    return `
        <div class="h2h-card rounded-2xl p-5 shadow-2xl slide-in border border-purple-500/30 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">âš”ï¸ H2H - Ãšltimos ${h2h.games.length} Partidos</h2>
                <span class="text-xs px-3 py-1 rounded bg-green-500/20 text-green-300">â˜ï¸ Firebase</span>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-white/10 rounded-xl p-4 text-center ${t1W>t2W?'border-2 border-green-500/50':''}">
                    <p class="text-white font-bold text-sm">${localTeam}</p>
                    <p class="text-4xl font-black ${t1W>t2W?'text-green-400':'text-white'}">${t1W}</p>
                </div>
                <div class="bg-white/5 rounded-xl p-4 text-center flex flex-col justify-center">
                    <p class="text-yellow-400 font-bold">VS</p>
                    <p class="text-gray-300">${t1W}-${t2W}</p>
                </div>
                <div class="bg-white/10 rounded-xl p-4 text-center ${t2W>t1W?'border-2 border-green-500/50':''}">
                    <p class="text-white font-bold text-sm">${visitingTeam}</p>
                    <p class="text-4xl font-black ${t2W>t1W?'text-green-400':'text-white'}">${t2W}</p>
                </div>
            </div>
            
            <div class="bg-purple-900/50 rounded-xl p-4 mb-5">
                <h3 class="text-white font-bold text-center mb-3">ğŸ“Š PROMEDIOS H2H</h3>
                <div class="grid grid-cols-3 gap-2 text-center text-sm">
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">1er Cuarto</p>
                        <p class="text-yellow-400 font-bold">${(h2h.avgQ1.team1+h2h.avgQ1.team2).toFixed(1)}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">1er Tiempo</p>
                        <p class="text-pink-400 font-bold">${(h2h.avgHalf.team1+h2h.avgHalf.team2).toFixed(1)}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-2">
                        <p class="text-gray-400 text-xs">Full Game</p>
                        <p class="text-green-400 font-bold">${(h2h.avgPts.team1+h2h.avgPts.team2).toFixed(1)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center mt-3">
                    <p class="text-cyan-400 font-bold">${localTeam}: ${h2h.avgPts.team1.toFixed(1)} PPG</p>
                    <p class="text-orange-400 font-bold">${visitingTeam}: ${h2h.avgPts.team2.toFixed(1)} PPG</p>
                </div>
            </div>
            
            <div class="bg-black/30 rounded-xl p-4">
                <h3 class="text-white font-bold text-sm mb-3">ğŸ“‹ HISTORIAL</h3>
                <div class="space-y-1 max-h-64 overflow-y-auto">
                    <div class="grid grid-cols-5 gap-2 text-xs text-gray-500 font-bold pb-2 border-b border-white/10">
                        <span>FECHA</span><span class="text-center">1Q</span><span class="text-center">1H</span><span class="text-center">FULL</span><span class="text-center">GANÃ“</span>
                    </div>
                    ${gh}
                </div>
            </div>
            
            <button onclick="goToIngestWithTeams()" class="w-full mt-4 bg-purple-600/50 hover:bg-purple-600 text-white py-2 rounded-lg text-sm">â• Agregar mÃ¡s partidos</button>
        </div>
    `;
}

function renderCalc(id, label, trend, prob, type, line, odds) {
    const analysis = analyzebet(trend, line, type, odds);
    const verdict = analysis ? evVerdict(analysis.ev, analysis.prob, analysis.edge) : evVerdict(null, prob, null);
    const stake = analysis && analysis.kelly ? stakeRec(analysis.kelly) : null;
    
    let resultsHtml = '';
    if (analysis && analysis.prob) {
        const hasOdds = odds && parseFloat(odds) > 1;
        const diffNum = parseFloat(analysis.diff);
        const zNum = parseFloat(analysis.zScore);
        
        resultsHtml = `
            <div class="mt-3 space-y-2">
                <!-- MÃ©tricas de Transparencia -->
                <div class="bg-slate-800/80 rounded-lg px-3 py-2 border border-white/10">
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-400">Diferencia</span>
                        <span class="font-bold ${diffNum >= 0 ? 'text-green-400' : 'text-red-400'}">${diffNum >= 0 ? '+' : ''}${analysis.diff} pts</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <span class="text-gray-400">SD (Â±variaciÃ³n)</span>
                        <span class="font-bold text-cyan-400">Â±${analysis.std} pts</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <span class="text-gray-400">Z-Score</span>
                        <span class="font-bold ${zNum >= 1.5 ? 'text-green-400' : zNum >= 0.5 ? 'text-yellow-400' : 'text-red-400'}">${zNum >= 0 ? '+' : ''}${analysis.zScore}</span>
                    </div>
                </div>
                
                <!-- Probabilidad -->
                <div class="flex justify-between items-center bg-white/10 rounded-lg px-3 py-2">
                    <span class="text-xs text-gray-400">Prob. Ganar</span>
                    <span class="font-black text-lg ${analysis.prob >= 55 ? 'text-green-400' : analysis.prob >= 45 ? 'text-yellow-400' : 'text-red-400'}">${analysis.prob}%</span>
                </div>
                
                <!-- Cuota Justa -->
                <div class="flex justify-between items-center bg-white/5 rounded-lg px-3 py-1">
                    <span class="text-xs text-gray-400">Cuota Justa</span>
                    <span class="font-bold text-sm text-white">${analysis.fairOdds}</span>
                </div>
                
                ${hasOdds ? `
                    <!-- EV% -->
                    <div class="flex justify-between items-center ${parseFloat(analysis.ev) >= 0 ? 'bg-green-500/20' : 'bg-red-500/20'} rounded-lg px-3 py-2">
                        <span class="text-xs ${parseFloat(analysis.ev) >= 0 ? 'text-green-400' : 'text-red-400'}">Expected Value</span>
                        <span class="font-black text-lg ${parseFloat(analysis.ev) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(analysis.ev) >= 0 ? '+' : ''}${analysis.ev}%</span>
                    </div>
                    
                    <!-- Edge -->
                    <div class="flex justify-between items-center bg-white/5 rounded-lg px-3 py-1">
                        <span class="text-xs text-gray-400">Edge vs Casa</span>
                        <span class="font-bold text-sm ${parseFloat(analysis.edge) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(analysis.edge) >= 0 ? '+' : ''}${analysis.edge}%</span>
                    </div>
                ` : `
                    <div class="bg-blue-500/20 rounded-lg px-3 py-2 text-center">
                        <span class="text-xs text-blue-400">â¬‡ï¸ Ingresa la cuota para ver EV</span>
                    </div>
                `}
                
                <!-- Veredicto -->
                <div class="${evColor(hasOdds ? analysis.ev : null, analysis.prob)} rounded-xl p-3 text-center shadow-lg">
                    <p class="text-2xl">${verdict.icon}</p>
                    <p class="text-white font-black text-sm">${verdict.text}</p>
                    ${verdict.stars ? `<p class="text-yellow-300 text-xs">${verdict.stars}</p>` : ''}
                </div>
                
                ${hasOdds && stake ? `
                    <div class="text-center">
                        <span class="text-xs ${stake.class}">ğŸ’° ${stake.text}</span>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    return `
        <div class="bg-slate-800/60 rounded-xl p-3 border border-white/10 backdrop-blur-sm">
            <p class="text-sm font-black text-center text-white mb-1">${label}: <span class="text-cyan-400">${trend}</span></p>
            
            <!-- Selector Over/Under -->
            <div class="flex gap-1 my-2">
                <button onclick="setType('${id}','OVER')" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all ${type==='OVER'?'bg-green-600 text-white shadow-md':'bg-white/10 hover:bg-white/20 text-white'}">OVER</button>
                <button onclick="setType('${id}','UNDER')" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all ${type==='UNDER'?'bg-red-600 text-white shadow-md':'bg-white/10 hover:bg-white/20 text-white'}">UNDER</button>
            </div>
            
            <!-- Input LÃ­nea -->
            <div class="mb-2">
                <label class="text-xs text-gray-400 block mb-1">ğŸ“ LÃ­nea</label>
                <input type="number" step="0.5" value="${line}" placeholder="ej: ${label === '1Q' ? '53.5' : label === '1H' ? '104.5' : '221.5'}" 
                    class="w-full p-2 border border-cyan-500/30 rounded-lg text-center text-sm font-bold bg-cyan-500/10 text-white focus:border-cyan-500 focus:outline-none placeholder-gray-500" 
                    onchange="updateLine('${id}',this.value)">
            </div>
            
            <!-- Input Cuota -->
            <div class="mb-2">
                <label class="text-xs text-gray-400 block mb-1">ğŸ’° Cuota (decimal)</label>
                <input type="number" step="0.01" value="${odds || ''}" placeholder="ej: 1.85" 
                    class="w-full p-2 border border-yellow-500/30 rounded-lg text-center text-sm font-bold bg-yellow-500/10 text-white focus:border-yellow-500 focus:outline-none placeholder-gray-500" 
                    onchange="updateOdds('${id}',this.value)">
            </div>
            
            ${resultsHtml}
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PICKS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPicks() {
    const stats = getPicksStats();
    const picks = Object.values(PICKS_DATABASE).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // Stats por tipo
    let typeStatsHtml = '';
    Object.entries(stats.byType).forEach(([key, data]) => {
        const [period, betType] = key.split('_');
        const winRate = data.wins + data.losses > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(0) : 0;
        typeStatsHtml += `
            <div class="bg-white/5 rounded-lg p-2 text-center">
                <p class="text-xs text-gray-300 font-semibold">${period} ${betType}</p>
                <p class="text-base md:text-lg font-bold ${winRate >= 55 ? 'text-green-400' : winRate >= 45 ? 'text-yellow-400' : 'text-red-400'}">${winRate}%</p>
                <p class="text-xs text-gray-400 font-medium">${data.wins}W-${data.losses}L</p>
            </div>
        `;
    });
    
    // Picks list - MEJORADO PARA MÃ“VILES
    let picksHtml = picks.length === 0 ? '<p class="text-center text-gray-400 py-10">No hay picks registrados aÃºn</p>' : '';
    picks.forEach(pick => {
        const statusClass = pick.status === 'win' ? 'win-badge' : pick.status === 'loss' ? 'loss-badge' : 'pending-badge';
        const statusIcon = pick.status === 'win' ? 'âœ…' : pick.status === 'loss' ? 'âŒ' : 'â³';
        const date = new Date(pick.createdAt).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        
        // Calcular CLV si tenemos lÃ­nea de cierre
        let clvDisplay = '';
        if (pick.closingLine && pick.line && !pick.isCombo) {
            const clv = pick.betType === 'OVER' 
                ? (parseFloat(pick.closingLine) - parseFloat(pick.line)).toFixed(1)
                : (parseFloat(pick.line) - parseFloat(pick.closingLine)).toFixed(1);
            const clvClass = parseFloat(clv) >= 0 ? 'text-green-400' : 'text-red-400';
            clvDisplay = `<span class="font-semibold ${clvClass} text-xs">CLV: ${parseFloat(clv) >= 0 ? '+' : ''}${clv}</span>`;
        }
        
        picksHtml += `
            <div class="pick-card bg-white/5 rounded-xl p-3 md:p-4 mb-3 border ${pick.isCombo ? 'border-amber-500/50' : 'border-white/10'}">
                <!-- Header: Equipos + Status -->
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0 pr-2">
                        ${pick.isCombo ? '<span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full mb-1 inline-block font-bold">ğŸ”¥ BET BUILDER</span>' : ''}
                        <p class="text-white font-bold text-sm md:text-base truncate">${pick.localTeam} vs ${pick.awayTeam}</p>
                        <p class="text-gray-200 text-xs md:text-sm font-semibold">${pick.isCombo ? pick.line : `${pick.period} ${pick.betType} ${pick.line}`}</p>
                    </div>
                    <span class="${statusClass} px-2 md:px-3 py-1 rounded-full text-white text-xs md:text-sm font-bold flex-shrink-0">${statusIcon}</span>
                </div>
                
                <!-- Stats Row: Fecha, Odds, Prob, EV, CLV - GRID para mÃ³viles -->
                <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3 text-xs md:text-sm mb-2">
                    <span class="text-gray-300 font-medium">ğŸ“… ${date}</span>
                    ${pick.odds ? `<span class="text-yellow-300 font-semibold">@${pick.odds}</span>` : ''}
                    <span class="text-purple-300 font-semibold">${pick.probability}% prob</span>
                    ${pick.ev ? `<span class="font-semibold ${parseFloat(pick.ev) >= 0 ? 'text-green-400' : 'text-red-400'}">EV: ${parseFloat(pick.ev) >= 0 ? '+' : ''}${pick.ev}%</span>` : ''}
                    ${clvDisplay}
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end gap-2 items-center border-t border-white/10 pt-2">
                    ${pick.status === 'pending' ? `
                        <button onclick="registerActualResult('${pick.id}')" class="text-amber-400 hover:text-amber-300 text-xs bg-amber-500/20 px-2 py-1 rounded" title="Registrar resultado real">ğŸ“Š Resultado</button>
                        <button onclick="updatePickResult('${pick.id}', 'win')" class="text-green-400 hover:text-green-300 text-lg p-1" title="Marcar ganado">âœ“</button>
                        <button onclick="updatePickResult('${pick.id}', 'loss')" class="text-red-400 hover:text-red-300 text-lg p-1" title="Marcar perdido">âœ—</button>
                        <button onclick="updatePickResult('${pick.id}', 'push')" class="text-gray-400 hover:text-gray-300 text-sm p-1" title="Push">â†”ï¸</button>
                    ` : `
                        ${pick.actualTotal ? `<span class="text-xs text-cyan-400 mr-2">Real: ${pick.actualTotal} pts</span>` : ''}
                        ${pick.modelError !== null && pick.modelError !== undefined ? `<span class="text-xs text-gray-400">Error: Â±${pick.modelError.toFixed(1)}</span>` : ''}
                    `}
                    ${!pick.isCombo && !pick.closingLine && pick.status !== 'pending' ? `<button onclick="addClosingLine('${pick.id}', '${pick.line}')" class="text-cyan-400 hover:text-cyan-300 text-xs bg-cyan-500/20 px-2 py-1 rounded" title="Agregar lÃ­nea de cierre">+CLV</button>` : ''}
                    <button onclick="deletePick('${pick.id}')" class="text-gray-500 hover:text-red-400 text-lg p-1">ğŸ—‘ï¸</button>
                </div>
            </div>
        `;
    });
    
    return `
        <div class="p-3 md:p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4 text-sm md:text-base">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-2xl md:text-3xl font-bold text-white font-orbitron">MIS PICKS</h1>
                </div>
            </div>
            
            <!-- RESUMEN PRINCIPAL -->
            <div class="bg-gradient-to-br from-purple-600/30 to-pink-600/30 rounded-2xl p-4 md:p-5 mb-6 border border-purple-500/50">
                <!-- Fila 1: Efectividad, Ganados, Perdidos -->
                <div class="grid grid-cols-3 gap-2 md:gap-3 text-center mb-4">
                    <div class="bg-white/10 rounded-xl p-3 md:p-4">
                        <p class="text-3xl md:text-5xl font-black ${parseFloat(stats.winRate) >= 55 ? 'text-green-400' : parseFloat(stats.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${stats.winRate}%</p>
                        <p class="text-gray-300 text-xs md:text-sm font-semibold">Efectividad</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3 md:p-4">
                        <p class="text-3xl md:text-5xl font-black text-green-400">${stats.wins}<span class="text-sm md:text-lg text-gray-400">/${stats.wins + stats.losses}</span></p>
                        <p class="text-gray-300 text-xs md:text-sm font-semibold">Ganados</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3 md:p-4">
                        <p class="text-3xl md:text-5xl font-black text-red-400">${stats.losses}<span class="text-sm md:text-lg text-gray-400">/${stats.wins + stats.losses}</span></p>
                        <p class="text-gray-300 text-xs md:text-sm font-semibold">Perdidos</p>
                    </div>
                </div>
                
                <!-- Fila 2: Profit, ROI, Racha, Pendientes - RESPONSIVO -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 text-center mb-4">
                    <div class="bg-black/20 rounded-xl p-2 md:p-3">
                        <p class="text-xl md:text-2xl font-black ${parseFloat(stats.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(stats.profit) > 0 ? '+' : ''}${stats.profit}u</p>
                        <p class="text-gray-300 text-xs font-semibold">${parseFloat(stats.profit) >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} Profit</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-2 md:p-3">
                        <p class="text-xl md:text-2xl font-black ${parseFloat(stats.roi) >= 0 ? 'text-cyan-400' : 'text-red-400'}">${parseFloat(stats.roi) > 0 ? '+' : ''}${stats.roi}%</p>
                        <p class="text-gray-300 text-xs font-semibold">ğŸ’° ROI</p>
                    </div>
                    <div class="bg-black/20 rounded-xl p-2 md:p-3">
                        ${stats.streak.count > 0 ? `
                            <p class="text-xl md:text-2xl font-black ${stats.streak.type === 'win' ? 'text-green-400' : 'text-red-400'}">${stats.streak.count}${stats.streak.type === 'win' ? 'W' : 'L'}</p>
                            <p class="text-gray-300 text-xs font-semibold">${stats.streak.type === 'win' ? 'ğŸ”¥' : 'â„ï¸'} Racha</p>
                        ` : `
                            <p class="text-xl md:text-2xl font-black text-gray-500">-</p>
                            <p class="text-gray-300 text-xs font-semibold">ğŸ¯ Racha</p>
                        `}
                    </div>
                    <div class="bg-black/20 rounded-xl p-2 md:p-3">
                        <p class="text-xl md:text-2xl font-black text-yellow-400">${stats.pending}</p>
                        <p class="text-gray-300 text-xs font-semibold">â³ Pendientes</p>
                    </div>
                </div>
                
                <!-- Rachas histÃ³ricas -->
                ${stats.bestWinStreak > 0 || stats.worstLossStreak > 0 ? `
                <div class="grid grid-cols-2 gap-2 md:gap-3 text-center mb-4">
                    <div class="bg-green-500/10 rounded-lg p-2 border border-green-500/20">
                        <span class="text-green-400 text-xs md:text-sm font-semibold">ğŸ† Mejor: <strong>${stats.bestWinStreak}W</strong></span>
                    </div>
                    <div class="bg-red-500/10 rounded-lg p-2 border border-red-500/20">
                        <span class="text-red-400 text-xs md:text-sm font-semibold">ğŸ’€ Peor: <strong>${stats.worstLossStreak}L</strong></span>
                    </div>
                </div>
                ` : ''}
                
                <!-- Desglose por perÃ­odo -->
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-xs md:text-sm font-bold text-gray-300 mb-3">ğŸ“Š Rendimiento por PerÃ­odo</h4>
                    <div class="grid grid-cols-3 gap-2 md:gap-3">
                        <div class="bg-yellow-500/10 rounded-xl p-2 md:p-3 text-center border border-yellow-500/20">
                            <p class="text-yellow-400 font-bold text-base md:text-lg">1Q</p>
                            <p class="text-white font-bold text-xs md:text-sm">${stats.byPeriod['1Q'].wins}W-${stats.byPeriod['1Q'].losses}L</p>
                            <p class="text-xs md:text-sm font-semibold ${stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses > 0 ? (stats.byPeriod['1Q'].wins / (stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses > 0 ? ((stats.byPeriod['1Q'].wins / (stats.byPeriod['1Q'].wins + stats.byPeriod['1Q'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['1Q'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['1Q'].profit >= 0 ? '+' : ''}${stats.byPeriod['1Q'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-pink-500/10 rounded-xl p-2 md:p-3 text-center border border-pink-500/20">
                            <p class="text-pink-400 font-bold text-base md:text-lg">1H</p>
                            <p class="text-white font-bold text-xs md:text-sm">${stats.byPeriod['1H'].wins}W-${stats.byPeriod['1H'].losses}L</p>
                            <p class="text-xs md:text-sm font-semibold ${stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses > 0 ? (stats.byPeriod['1H'].wins / (stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses > 0 ? ((stats.byPeriod['1H'].wins / (stats.byPeriod['1H'].wins + stats.byPeriod['1H'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['1H'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['1H'].profit >= 0 ? '+' : ''}${stats.byPeriod['1H'].profit.toFixed(2)}u</p>
                        </div>
                        <div class="bg-green-500/10 rounded-xl p-2 md:p-3 text-center border border-green-500/20">
                            <p class="text-green-400 font-bold text-base md:text-lg">FULL</p>
                            <p class="text-white font-bold text-xs md:text-sm">${stats.byPeriod['FULL'].wins}W-${stats.byPeriod['FULL'].losses}L</p>
                            <p class="text-xs md:text-sm font-semibold ${stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses > 0 ? (stats.byPeriod['FULL'].wins / (stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses) * 100 >= 50 ? 'text-green-400' : 'text-red-400') : 'text-gray-400'}">${stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses > 0 ? ((stats.byPeriod['FULL'].wins / (stats.byPeriod['FULL'].wins + stats.byPeriod['FULL'].losses)) * 100).toFixed(0) : 0}%</p>
                            <p class="text-xs font-semibold ${stats.byPeriod['FULL'].profit >= 0 ? 'text-green-400' : 'text-red-400'} mt-1">${stats.byPeriod['FULL'].profit >= 0 ? '+' : ''}${stats.byPeriod['FULL'].profit.toFixed(2)}u</p>
                        </div>
                    </div>
                </div>
                
                ${typeStatsHtml ? `
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-xs md:text-sm font-bold text-gray-300 mb-3">ğŸ¯ Por Tipo (Over/Under)</h4>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                        ${typeStatsHtml}
                    </div>
                </div>
                ` : ''}
            </div>
            
            <!-- LISTA DE PICKS -->
            <div class="glass rounded-xl p-3 md:p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base md:text-lg font-bold text-white">ğŸ“‹ Historial de Picks</h3>
                    <span class="text-xs md:text-sm text-gray-400">${stats.total} total</span>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    ${picksHtml}
                </div>
            </div>
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEST PICKS VIEW - Muestra picks de alto valor detectados
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBestPicks() {
    // Cargar VALUE_PICKS desde localStorage si no estÃ¡n cargados
    if (VALUE_PICKS.length === 0) {
        loadValuePicksFromStorage();
    }
    
    let picksHtml = '';
    
    if (VALUE_PICKS.length === 0) {
        picksHtml = `
            <div class="text-center py-10">
                <div class="text-6xl mb-4">ğŸ”</div>
                <p class="text-gray-400 text-lg mb-2">No hay picks de valor detectados</p>
                <p class="text-gray-500 text-sm">Los picks aparecerÃ¡n automÃ¡ticamente cuando analices matchups en la calculadora y se detecte valor alto (75%+)</p>
                <button onclick="navigateTo('tendencia')" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold">
                    ğŸ“ˆ Ir a analizar matchups
                </button>
            </div>
        `;
    } else {
        VALUE_PICKS.forEach((pick, index) => {
            const timeAgo = getTimeAgo(pick.detectedAt);
            const evClass = pick.ev && parseFloat(pick.ev) >= 10 ? 'text-green-400' : pick.ev && parseFloat(pick.ev) >= 0 ? 'text-lime-400' : 'text-yellow-400';
            const periodColor = pick.period === '1Q' ? 'yellow' : pick.period === '1H' ? 'pink' : 'green';
            
            picksHtml += `
                <div class="value-pick bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-xl p-4 mb-3 border ${index === 0 ? 'border-yellow-500 border-2' : 'border-purple-500/30'}">
                    ${index === 0 ? '<div class="text-yellow-400 text-xs font-bold mb-2">ğŸ¥‡ PICK MÃS RECIENTE</div>' : ''}
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-white font-bold text-lg">${pick.local} vs ${pick.away}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="bg-${periodColor}-500/30 text-${periodColor}-400 text-xs px-2 py-1 rounded font-bold">${pick.period}</span>
                                <span class="text-purple-300 font-semibold">${pick.betType} ${pick.line}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-black ${pick.probability >= 75 ? 'text-green-400' : 'text-yellow-400'}">${pick.probability}%</p>
                            <p class="text-xs text-gray-400 font-medium">probabilidad</p>
                        </div>
                    </div>
                    
                    <div class="bg-black/20 rounded-lg p-3 mb-3">
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div>
                                <p class="text-gray-400 text-xs">Tendencia</p>
                                <p class="text-white font-bold">${pick.trend}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs">LÃ­nea</p>
                                <p class="text-white font-bold">${pick.line}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs">EV</p>
                                <p class="font-bold ${evClass}">${pick.ev ? (parseFloat(pick.ev) >= 0 ? '+' : '') + pick.ev + '%' : '-'}</p>
                            </div>
                        </div>
                        <p class="text-gray-500 text-xs mt-2 text-center">â±ï¸ Detectado ${timeAgo}</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="analyzeFromValuePick('${pick.id}')" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-bold">
                            ğŸ“Š Analizar
                        </button>
                        <button onclick="registerFromValuePick('${pick.id}')" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold">
                            âœ… Registrar
                        </button>
                        <button onclick="removeValuePick('${pick.id}')" class="bg-red-600/50 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-bold">
                            ğŸ—‘ï¸ Descartar
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    return `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">ğŸ”¥ VALOR DETECTADO</h1>
                </div>
                <p class="text-gray-400 text-sm">Picks de alto valor detectados automÃ¡ticamente</p>
                ${VALUE_PICKS.length > 0 ? `<p class="text-purple-400 text-sm mt-1">${VALUE_PICKS.length} pick${VALUE_PICKS.length > 1 ? 's' : ''} guardado${VALUE_PICKS.length > 1 ? 's' : ''}</p>` : ''}
            </div>
            
            ${VALUE_PICKS.length > 1 ? `
                <div class="flex justify-end mb-4">
                    <button onclick="clearAllValuePicks()" class="text-red-400 hover:text-red-300 text-sm flex items-center gap-1">
                        ğŸ—‘ï¸ Limpiar todo
                    </button>
                </div>
            ` : ''}
            
            <div class="glass rounded-xl p-4">
                ${picksHtml}
            </div>
            
            <div class="mt-6 bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                <p class="text-blue-400 text-sm">ğŸ’¡ <strong>Tip:</strong> Los picks se guardan automÃ¡ticamente cuando la calculadora detecta probabilidad â‰¥70%. Se eliminan despuÃ©s de 24 horas.</p>
            </div>
            
            <div class="mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                <p class="text-yellow-400 text-sm">âš ï¸ <strong>Disclaimer:</strong> Estas sugerencias son basadas en anÃ¡lisis estadÃ­stico. Siempre haz tu propia investigaciÃ³n y apuesta responsablemente.</p>
            </div>
        </div>
    `;
}

// FunciÃ³n auxiliar para calcular tiempo transcurrido
function getTimeAgo(dateString) {
    const now = new Date();
    const detected = new Date(dateString);
    const diffMs = now - detected;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    
    if (diffMins < 1) return 'hace un momento';
    if (diffMins < 60) return `hace ${diffMins} min`;
    if (diffHours < 24) return `hace ${diffHours}h`;
    return 'hace mÃ¡s de 24h';
}

function selectBestPick(local, away) {
    localTeam = local;
    visitingTeam = away;
    navigateTo('tendencia');
}

function registerPick(period, betType, line, probability, oddsFromForm) {
    let odds = oddsFromForm ? parseFloat(oddsFromForm) : null;
    
    // Si no hay cuota del formulario, pedirla
    if (!odds || odds <= 1) {
        const oddsInput = prompt('Ingresa la cuota (ej: 1.85):');
        if (oddsInput === null) return;
        odds = parseFloat(oddsInput) || null;
    }
    
    // Calcular EV para guardar
    const ev = odds ? calcEV(probability, odds) : null;
    
    addPick({
        localTeam,
        awayTeam: visitingTeam,
        period,
        betType,
        line,
        probability,
        odds,
        ev // Guardar EV para anÃ¡lisis posterior
    });
}

// Registrar Bet Builder (picks combinados)
function registerBetBuilder() {
    const comboOdds = document.getElementById('combo_odds')?.value;
    if (!comboOdds || parseFloat(comboOdds) <= 1) {
        showNotification('âš ï¸ Ingresa la cuota combinada del Bet Builder', 'warning');
        return;
    }
    
    const odds = parseFloat(comboOdds);
    const legs = []; // Patas del bet builder
    let combinedProb = 1; // Probabilidad combinada (multiplicar)
    
    // Verificar cuÃ¡les estÃ¡n seleccionados
    const q1Checked = document.getElementById('combo_q1')?.checked;
    const halfChecked = document.getElementById('combo_half')?.checked;
    const fullChecked = document.getElementById('combo_full')?.checked;
    
    // Agregar Q1 si estÃ¡ seleccionado
    if (q1Checked && lineQ1) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.q1Home || 0) + (TEAM_STATS[visitingTeam]?.q1Away || 0),
            lineQ1, typeQ1
        );
        if (prob) {
            legs.push({ period: '1Q', betType: typeQ1, line: lineQ1, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    // Agregar 1H si estÃ¡ seleccionado
    if (halfChecked && lineHalf) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.halfHome || 0) + (TEAM_STATS[visitingTeam]?.halfAway || 0),
            lineHalf, typeHalf
        );
        if (prob) {
            legs.push({ period: '1H', betType: typeHalf, line: lineHalf, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    // Agregar FULL si estÃ¡ seleccionado
    if (fullChecked && lineFull) {
        const prob = calcProb(
            (TEAM_STATS[localTeam]?.fullHome || 0) + (TEAM_STATS[visitingTeam]?.fullAway || 0),
            lineFull, typeFull
        );
        if (prob) {
            legs.push({ period: 'FULL', betType: typeFull, line: lineFull, probability: prob });
            combinedProb *= (prob / 100);
        }
    }
    
    if (legs.length < 2) {
        showNotification('âš ï¸ Selecciona al menos 2 picks para el Bet Builder', 'warning');
        return;
    }
    
    // Calcular probabilidad combinada y EV
    const combinedProbPercent = Math.round(combinedProb * 100);
    const ev = calcEV(combinedProbPercent, odds);
    
    // Crear descripciÃ³n del combo
    const comboDesc = legs.map(l => `${l.period} ${l.betType} ${l.line}`).join(' + ');
    
    addPick({
        localTeam,
        awayTeam: visitingTeam,
        period: 'COMBO',
        betType: 'BET BUILDER',
        line: comboDesc,
        probability: combinedProbPercent,
        odds,
        ev,
        legs, // Guardar detalles de cada pata
        isCombo: true
    });
    
    showNotification(`ğŸ”¥ Bet Builder registrado: ${legs.length} picks combinados`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD PRO - GRÃFICOS Y ANÃLISIS AVANZADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let profitChart = null;
let teamChart = null;

function renderDashboard() {
    try {
    const stats = getPicksStats();
    const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending').sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    // Calcular profit acumulado para el grÃ¡fico
    let profitAcum = 0;
    const profitData = picks.map(pick => {
        if (pick.status === 'win') {
            profitAcum += (pick.odds - 1);
        } else if (pick.status === 'loss') {
            profitAcum -= 1;
        }
        return {
            date: new Date(pick.createdAt).toLocaleDateString('es-ES', {day:'2-digit', month:'short'}),
            profit: parseFloat(profitAcum.toFixed(2)),
            status: pick.status
        };
    });
    
    // Calcular rendimiento por equipo
    const teamStats = {};
    picks.forEach(pick => {
        const teams = [pick.localTeam, pick.awayTeam];
        teams.forEach(team => {
            if (!team) return;
            if (!teamStats[team]) teamStats[team] = { wins: 0, losses: 0, profit: 0 };
            if (pick.status === 'win') {
                teamStats[team].wins++;
                teamStats[team].profit += (pick.odds - 1);
            } else if (pick.status === 'loss') {
                teamStats[team].losses++;
                teamStats[team].profit -= 1;
            }
        });
    });
    
    // Top 5 equipos mÃ¡s rentables
    const topTeams = Object.entries(teamStats)
        .map(([team, data]) => ({
            team,
            ...data,
            winRate: data.wins + data.losses > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(0) : 0,
            total: data.wins + data.losses
        }))
        .filter(t => t.total >= 2)
        .sort((a,b) => b.profit - a.profit)
        .slice(0, 8);
    
    // CLV Stats (si tenemos datos)
    const picksWithCLV = Object.values(PICKS_DATABASE).filter(p => p.closingLine && p.line);
    let avgCLV = 0;
    if (picksWithCLV.length > 0) {
        const totalCLV = picksWithCLV.reduce((sum, p) => {
            const clv = parseFloat(p.line) - parseFloat(p.closingLine);
            return sum + (p.betType === 'OVER' ? clv : -clv);
        }, 0);
        avgCLV = (totalCLV / picksWithCLV.length).toFixed(2);
    }
    
    // AnÃ¡lisis por cuartos extendido (Q2, Q3, Q4)
    const quarterAnalysis = {
        '1Q': { wins: 0, losses: 0, profit: 0 },
        '2Q': { wins: 0, losses: 0, profit: 0 },
        '3Q': { wins: 0, losses: 0, profit: 0 },
        '4Q': { wins: 0, losses: 0, profit: 0 },
        '1H': { wins: 0, losses: 0, profit: 0 },
        '2H': { wins: 0, losses: 0, profit: 0 },
        'FULL': { wins: 0, losses: 0, profit: 0 }
    };
    
    picks.forEach(pick => {
        const period = pick.period;
        if (quarterAnalysis[period]) {
            if (pick.status === 'win') {
                quarterAnalysis[period].wins++;
                quarterAnalysis[period].profit += (pick.odds - 1);
            } else {
                quarterAnalysis[period].losses++;
                quarterAnalysis[period].profit -= 1;
            }
        }
    });
    
    const teamStatsHtml = topTeams.length > 0 ? topTeams.map(t => `
        <div class="flex justify-between items-center bg-white/5 rounded-lg p-3 mb-2">
            <div>
                <span class="text-white font-bold">${t.team}</span>
                <span class="text-gray-400 text-xs ml-2">(${t.total} picks)</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm ${parseFloat(t.winRate) >= 55 ? 'text-green-400' : parseFloat(t.winRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${t.winRate}%</span>
                <span class="font-bold ${t.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${t.profit >= 0 ? '+' : ''}${t.profit.toFixed(2)}u</span>
            </div>
        </div>
    `).join('') : '<p class="text-gray-400 text-center py-4">Necesitas mÃ¡s picks para ver estadÃ­sticas por equipo</p>';
    
    return `
        <div class="p-3 md:p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4 text-sm md:text-base">â† Volver</button>
            
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-2xl md:text-3xl font-bold text-white font-orbitron">ğŸ“‰ DASHBOARD PRO</h1>
                </div>
                <p class="text-cyan-400 text-xs md:text-sm">AnÃ¡lisis avanzado de rendimiento</p>
            </div>
            
            <!-- RESUMEN RÃPIDO -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 mb-6">
                <div class="bg-gradient-to-br from-green-500/20 to-emerald-600/20 rounded-xl p-3 md:p-4 text-center border border-green-500/30">
                    <p class="text-2xl md:text-3xl font-black text-green-400">${stats.winRate}%</p>
                    <p class="text-gray-300 text-xs font-semibold">Win Rate</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-500/20 to-blue-600/20 rounded-xl p-3 md:p-4 text-center border border-cyan-500/30">
                    <p class="text-2xl md:text-3xl font-black ${parseFloat(stats.profit) >= 0 ? 'text-cyan-400' : 'text-red-400'}">${parseFloat(stats.profit) >= 0 ? '+' : ''}${stats.profit}u</p>
                    <p class="text-gray-300 text-xs font-semibold">Profit</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500/20 to-pink-600/20 rounded-xl p-3 md:p-4 text-center border border-purple-500/30">
                    <p class="text-2xl md:text-3xl font-black ${parseFloat(stats.roi) >= 0 ? 'text-purple-400' : 'text-red-400'}">${parseFloat(stats.roi) >= 0 ? '+' : ''}${stats.roi}%</p>
                    <p class="text-gray-300 text-xs font-semibold">ROI</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-500/20 to-orange-600/20 rounded-xl p-3 md:p-4 text-center border border-yellow-500/30">
                    <p class="text-2xl md:text-3xl font-black text-yellow-400">${picks.length}</p>
                    <p class="text-gray-300 text-xs font-semibold">Picks</p>
                </div>
            </div>
            
            <!-- GRÃFICO DE PROFIT ACUMULADO -->
            <div class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-2xl p-3 md:p-5 mb-6 border border-gray-700">
                <h3 class="text-base md:text-lg font-bold text-white mb-4">ğŸ“ˆ EvoluciÃ³n de Profit</h3>
                <div style="height: 200px;" class="md:h-[250px]">
                    <canvas id="profitChart"></canvas>
                </div>
                ${picks.length < 3 ? '<p class="text-gray-400 text-center text-xs md:text-sm mt-2">Necesitas al menos 3 picks resueltos para ver el grÃ¡fico</p>' : ''}
            </div>
            
            <!-- CLV TRACKER -->
            <div class="bg-gradient-to-br from-indigo-600/20 to-purple-700/20 rounded-2xl p-3 md:p-5 mb-6 border border-indigo-500/50">
                <h3 class="text-base md:text-lg font-bold text-white mb-3">ğŸ¯ CLV Tracker (Closing Line Value)</h3>
                <p class="text-gray-300 text-xs md:text-sm mb-4">El CLV mide si apuestas antes de que la lÃ­nea se mueva a tu favor. <strong class="text-yellow-400">CLV positivo = pensÃ¡s como un sharp.</strong></p>
                
                <div class="grid grid-cols-2 gap-2 md:gap-4 mb-4">
                    <div class="bg-black/30 rounded-xl p-3 md:p-4 text-center">
                        <p class="text-xl md:text-2xl font-black ${parseFloat(avgCLV) >= 0 ? 'text-green-400' : 'text-red-400'}">${avgCLV > 0 ? '+' : ''}${avgCLV} pts</p>
                        <p class="text-gray-400 text-xs font-semibold">CLV Promedio</p>
                    </div>
                    <div class="bg-black/30 rounded-xl p-3 md:p-4 text-center">
                        <p class="text-xl md:text-2xl font-black text-cyan-400">${picksWithCLV.length}</p>
                        <p class="text-gray-400 text-xs font-semibold">Picks con CLV</p>
                    </div>
                </div>
                
                <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/30">
                    <p class="text-yellow-400 text-xs">ğŸ’¡ <strong>Tip:</strong> En "Mis Picks" puedes agregar la lÃ­nea de cierre a cada pick para calcular tu CLV.</p>
                </div>
            </div>
            
            <!-- RENDIMIENTO POR EQUIPO -->
            <div class="bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-2xl p-3 md:p-5 mb-6 border border-gray-700">
                <h3 class="text-base md:text-lg font-bold text-white mb-4">ğŸ€ Rendimiento por Equipo</h3>
                ${teamStatsHtml}
            </div>
            
            <!-- ANÃLISIS POR PERÃODO -->
            <div class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-2xl p-3 md:p-5 mb-6 border border-purple-500/50">
                <h3 class="text-base md:text-lg font-bold text-white mb-4">ğŸ“Š Rendimiento por PerÃ­odo</h3>
                <div class="grid grid-cols-3 gap-2 md:gap-3">
                    ${['1Q', '1H', 'FULL'].map(p => {
                        const data = quarterAnalysis[p];
                        const total = data.wins + data.losses;
                        const wr = total > 0 ? ((data.wins / total) * 100).toFixed(0) : '-';
                        const wrNum = total > 0 ? (data.wins / total) * 100 : 0;
                        const colors = { '1Q': 'yellow', '1H': 'pink', 'FULL': 'green' };
                        const color = colors[p];
                        return `
                            <div class="bg-${color}-500/10 rounded-xl p-3 md:p-4 text-center border border-${color}-500/30">
                                <p class="text-${color}-400 font-bold text-lg md:text-xl">${p}</p>
                                <p class="text-white font-bold text-sm md:text-base">${data.wins}W-${data.losses}L</p>
                                <p class="text-base md:text-lg font-black ${total > 0 && wrNum >= 50 ? 'text-green-400' : total > 0 ? 'text-red-400' : 'text-gray-500'}">${wr}%</p>
                                <p class="text-xs md:text-sm font-semibold ${data.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${data.profit >= 0 ? '+' : ''}${data.profit.toFixed(2)}u</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <!-- ANÃLISIS DE PATRONES PERSONALES -->
            <div class="bg-gradient-to-br from-emerald-600/20 to-teal-700/20 rounded-2xl p-3 md:p-5 mb-6 border border-emerald-500/50">
                <h3 class="text-base md:text-lg font-bold text-white mb-3">ğŸ“Š AnÃ¡lisis de Patrones Personales</h3>
                <p class="text-gray-300 text-xs md:text-sm mb-4">AnÃ¡lisis de tus picks histÃ³ricos para identificar tus fortalezas y Ã¡reas de mejora.</p>
                
                <div class="bg-black/30 rounded-xl p-3 md:p-4">
                    <div class="grid grid-cols-2 gap-3 md:gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-emerald-400 font-bold text-sm md:text-lg">Lo que analizo:</p>
                            <ul class="text-gray-300 text-xs text-left mt-2 space-y-1">
                                <li>â€¢ PerÃ­odos mÃ¡s rentables</li>
                                <li>â€¢ OVER vs UNDER performance</li>
                                <li>â€¢ Equipos donde aciertas mÃ¡s</li>
                                <li>â€¢ Rachas y consistencia</li>
                                <li>â€¢ ROI por tipo de apuesta</li>
                            </ul>
                        </div>
                        <div class="text-center">
                            <p class="text-emerald-400 font-bold text-sm md:text-lg">Datos:</p>
                            <p class="text-3xl md:text-4xl mt-2 font-black text-white">${picks.length}</p>
                            <p class="text-gray-400 text-xs mt-1">picks analizados</p>
                        </div>
                    </div>
                    ${picks.length >= 10 ? `
                        <div class="bg-emerald-500/20 rounded-lg p-3 border border-emerald-500/30">
                            <p class="text-emerald-400 text-xs md:text-sm text-center">âœ… Suficientes datos. Revisa las secciones anteriores para ver tus patrones.</p>
                        </div>
                    ` : `
                        <div class="bg-yellow-500/10 rounded-lg p-3 border border-yellow-500/30">
                            <p class="text-yellow-400 text-xs text-center">ğŸ“Š Registra al menos 10 picks para obtener anÃ¡lisis mÃ¡s precisos.</p>
                        </div>
                    `}
                </div>
            </div>
            
            <!-- CRÃ‰DITOS -->
            <div class="bg-white/5 rounded-xl p-4 text-center">
                <p class="text-gray-400 text-xs">NioSports Pro v2.0 - Modelo Predictivo Avanzado</p>
                <p class="text-gray-500 text-xs mt-1">Backtesting, B2B, PACE, CalibraciÃ³n, CLV Tracker</p>
            </div>
            
            <!-- BACKTESTING & CALIBRACIÃ“N -->
            ${(() => {
                const backtest = getBacktestStats();
                if (!backtest || backtest.totalPicks < 5) {
                    return `
                    <div class="bg-gradient-to-br from-amber-600/20 to-orange-700/20 rounded-2xl p-5 mt-6 border border-amber-500/50">
                        <h3 class="text-lg font-bold text-white mb-3">ğŸ”¬ Backtesting & CalibraciÃ³n</h3>
                        <p class="text-amber-300 text-sm text-center py-6">
                            Necesitas al menos 5 picks con resultado registrado para ver el anÃ¡lisis de backtesting.<br>
                            <span class="text-xs text-gray-400 mt-2 block">Usa el botÃ³n "ğŸ“Š Resultado" en cada pick para registrar el total real del partido.</span>
                        </p>
                    </div>`;
                }
                
                return `
                <div class="bg-gradient-to-br from-amber-600/20 to-orange-700/20 rounded-2xl p-5 mt-6 border border-amber-500/50">
                    <h3 class="text-lg font-bold text-white mb-4">ğŸ”¬ Backtesting & CalibraciÃ³n del Modelo</h3>
                    
                    <!-- Resumen de PrecisiÃ³n -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="bg-white/10 rounded-xl p-3 text-center">
                            <p class="text-2xl font-black ${parseFloat(backtest.overallHitRate) >= 52.38 ? 'text-green-400' : 'text-red-400'}">${backtest.overallHitRate}%</p>
                            <p class="text-xs text-gray-300">Hit Rate Real</p>
                            <p class="text-xs ${parseFloat(backtest.overallHitRate) >= 52.38 ? 'text-green-500' : 'text-red-500'}">${parseFloat(backtest.overallHitRate) >= 52.38 ? 'âœ“ Rentable' : 'âœ— < 52.38%'}</p>
                        </div>
                        <div class="bg-white/10 rounded-xl p-3 text-center">
                            <p class="text-2xl font-black text-cyan-400">${backtest.avgModelError || '-'}</p>
                            <p class="text-xs text-gray-300">Error Promedio</p>
                            <p class="text-xs text-gray-500">pts vs real</p>
                        </div>
                        <div class="bg-white/10 rounded-xl p-3 text-center">
                            <p class="text-2xl font-black ${parseFloat(backtest.roi) >= 0 ? 'text-green-400' : 'text-red-400'}">${backtest.roi}%</p>
                            <p class="text-xs text-gray-300">ROI</p>
                            <p class="text-xs text-gray-500">${backtest.totalPicks} picks</p>
                        </div>
                        <div class="bg-white/10 rounded-xl p-3 text-center">
                            <p class="text-2xl font-black text-yellow-400">${backtest.totalWins}/${backtest.totalWins + backtest.totalLosses}</p>
                            <p class="text-xs text-gray-300">Win/Total</p>
                            <p class="text-xs text-gray-500">${backtest.totalPushes} pushes</p>
                        </div>
                    </div>
                    
                    <!-- Hit Rate por PerÃ­odo -->
                    <div class="bg-black/20 rounded-xl p-4 mb-4">
                        <h4 class="text-white font-bold mb-3">ğŸ“Š PrecisiÃ³n por PerÃ­odo</h4>
                        <div class="grid grid-cols-3 gap-2">
                            ${backtest.byPeriod.filter(p => p.wins + p.losses > 0).map(p => `
                                <div class="bg-white/5 rounded-lg p-3 text-center">
                                    <p class="text-white font-bold">${p.period}</p>
                                    <p class="text-2xl font-black ${parseFloat(p.hitRate) >= 52.38 ? 'text-green-400' : parseFloat(p.hitRate) >= 45 ? 'text-yellow-400' : 'text-red-400'}">${p.hitRate}%</p>
                                    <p class="text-xs text-gray-400">${p.wins}W - ${p.losses}L</p>
                                    ${p.avgError !== '-' ? `<p class="text-xs text-cyan-400">Â±${p.avgError} pts error</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- GrÃ¡fico de CalibraciÃ³n -->
                    ${backtest.calibration.length >= 2 ? `
                    <div class="bg-black/20 rounded-xl p-4 mb-4">
                        <h4 class="text-white font-bold mb-3">ğŸ¯ CalibraciÃ³n del Modelo</h4>
                        <p class="text-xs text-gray-400 mb-3">Cuando el modelo dice X%, Â¿acierta X%? Una lÃ­nea diagonal perfecta = modelo bien calibrado.</p>
                        <div class="space-y-2">
                            ${backtest.calibration.map(c => {
                                const diff = c.actualHitRate - c.avgPredicted;
                                const isCalibrated = Math.abs(diff) < 10;
                                return `
                                <div class="flex items-center gap-3">
                                    <span class="text-white text-sm w-16">${c.range}%</span>
                                    <div class="flex-1 bg-gray-700 rounded-full h-4 relative">
                                        <div class="absolute h-4 rounded-full ${isCalibrated ? 'bg-green-500' : diff > 0 ? 'bg-blue-500' : 'bg-red-500'}" style="width: ${Math.min(100, c.actualHitRate)}%"></div>
                                        <div class="absolute h-4 w-1 bg-yellow-400" style="left: ${c.avgPredicted}%"></div>
                                    </div>
                                    <span class="text-xs ${isCalibrated ? 'text-green-400' : diff > 0 ? 'text-blue-400' : 'text-red-400'} w-20 text-right">
                                        Real: ${c.actualHitRate.toFixed(0)}% (${c.count})
                                    </span>
                                </div>`;
                            }).join('')}
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">ğŸŸ¡ = PredicciÃ³n | Barra = Hit Rate Real | (n) = muestra</p>
                    </div>
                    ` : '<p class="text-gray-400 text-xs text-center mb-4">Necesitas mÃ¡s picks por rango de probabilidad para ver calibraciÃ³n</p>'}
                    
                    <!-- BotÃ³n Exportar -->
                    <div class="flex justify-center">
                        <button onclick="exportPicksToCSV()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                            ğŸ“¥ Exportar a CSV
                        </button>
                    </div>
                </div>`;
            })()}
        </div>
    `;
    } catch (error) {
        console.error('Error en renderDashboard:', error);
        return `
            <div class="p-4 max-w-4xl mx-auto">
                <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
                <div class="bg-red-500/20 border border-red-500 rounded-xl p-6 text-center">
                    <p class="text-red-400 text-xl mb-2">âš ï¸ Error al cargar Dashboard</p>
                    <p class="text-gray-300 text-sm">${error.message}</p>
                </div>
            </div>
        `;
    }
}

// Inicializar grÃ¡ficos del Dashboard
function initDashboardCharts() {
    const picks = Object.values(PICKS_DATABASE).filter(p => p.status !== 'pending').sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    if (picks.length < 3) return;
    
    // Calcular datos para el grÃ¡fico
    let profitAcum = 0;
    const labels = [];
    const data = [];
    const colors = [];
    
    picks.forEach((pick, i) => {
        if (pick.status === 'win') {
            profitAcum += (pick.odds - 1);
            colors.push('rgba(34, 197, 94, 0.8)');
        } else if (pick.status === 'loss') {
            profitAcum -= 1;
            colors.push('rgba(239, 68, 68, 0.8)');
        }
        labels.push(`#${i + 1}`);
        data.push(parseFloat(profitAcum.toFixed(2)));
    });
    
    // Crear grÃ¡fico de lÃ­nea
    const ctx = document.getElementById('profitChart');
    if (!ctx) return;
    
    // Destruir grÃ¡fico anterior si existe
    if (profitChart) {
        profitChart.destroy();
    }
    
    profitChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Profit Acumulado (u)',
                data: data,
                borderColor: profitAcum >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)',
                backgroundColor: profitAcum >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: colors,
                pointBorderColor: colors,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Profit: ${context.raw >= 0 ? '+' : ''}${context.raw}u`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: function(value) {
                            return value + 'u';
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INGESTA VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIngesta() {
    const teams = getTeams();
    const existH2H = ingestTeam1 && ingestTeam2 ? getH2HData(ingestTeam1, ingestTeam2) : null;
    
    let o1 = '<option value="">Seleccionar...</option>';
    let o2 = '<option value="">Seleccionar...</option>';
    teams.forEach(t => {
        o1 += `<option value="${t}"${t===ingestTeam1?' selected':''}>${t}</option>`;
        if (t !== ingestTeam1) o2 += `<option value="${t}"${t===ingestTeam2?' selected':''}>${t}</option>`;
    });
    
    let html = `
        <div class="p-4 max-w-4xl mx-auto">
            <button onclick="navigateTo('home')" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg mb-4">â† Volver</button>
            <div class="text-center mb-6">
                <div class="logo-container justify-center mb-2">
                    ${LOGO_SVG}
                    <h1 class="text-3xl font-bold text-white font-orbitron">INGESTA H2H</h1>
                </div>
                <p class="text-green-400 text-sm mt-2">â˜ï¸ Los datos se guardan en Firebase automÃ¡ticamente</p>
            </div>
            
            <div class="glass rounded-xl p-5 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">1ï¸âƒ£ Seleccionar Equipos</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Equipo 1</label>
                        <select id="ingestTeam1" class="w-full p-3 font-bold rounded-lg text-white bg-white/10 border border-white/20">${o1}</select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Equipo 2</label>
                        <select id="ingestTeam2" class="w-full p-3 font-bold rounded-lg text-white bg-white/10 border border-white/20">${o2}</select>
                    </div>
                </div>
            </div>
    `;
    
    if (ingestTeam1 && ingestTeam2) {
        html += `
            <div class="glass rounded-xl p-5 mb-6">
                <h2 class="text-lg font-bold text-white mb-4">2ï¸âƒ£ Fecha y LocalÃ­a</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Fecha del Partido</label>
                        <input type="date" id="ingestDate" value="${ingestDate}" class="w-full p-3 font-bold rounded-lg text-white bg-white/10 border border-white/20">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Â¿QuiÃ©n es LOCAL? ğŸ </label>
                        <select id="ingestLocal" class="w-full p-3 font-bold rounded-lg text-white bg-white/10 border border-white/20">
                            <option value="">Seleccionar...</option>
                            <option value="${ingestTeam1}"${ingestLocalTeam===ingestTeam1?' selected':''}>${ingestTeam1}</option>
                            <option value="${ingestTeam2}"${ingestLocalTeam===ingestTeam2?' selected':''}>${ingestTeam2}</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        if (ingestLocalTeam && ingestDate) {
            html += `
                <div class="bg-slate-800 rounded-2xl p-5 mb-6 border border-slate-600">
                    <h2 class="text-lg font-bold text-white mb-4 text-center">3ï¸âƒ£ Puntos por Cuarto</h2>
                    <div class="score-grid">${renderScoreInputs()}</div>
                    ${renderTotals()}
                </div>
                <button onclick="saveGame()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl text-xl hover:scale-[1.02] transition mb-6">ğŸ’¾ GUARDAR EN FIREBASE</button>
            `;
        }
        
        if (existH2H) {
            let gh = existH2H.games.map((g,i) => `
                <div class="bg-slate-800/50 rounded-lg p-3 flex justify-between items-center">
                    <div>
                        <p class="text-gray-400 text-xs">${g.date}${g.overtimes>0?` <span class="text-yellow-400">(${g.overtimes}OT)</span>`:''}</p>
                        <p class="text-white font-bold">${g.localTeam} ${g.t1Total}-${g.t2Total} ${g.awayTeam}</p>
                        <p class="text-gray-500 text-xs">1H: ${g.t1Half}-${g.t2Half} | Total: ${g.totalPts}</p>
                    </div>
                    <button onclick="deleteGame('${ingestTeam1}','${ingestTeam2}',${i})" class="text-red-400 hover:text-red-300 text-xl">ğŸ—‘ï¸</button>
                </div>
            `).join('');
            
            html += `
                <div class="glass rounded-xl p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">ğŸ“‹ Historial ${ingestTeam1} vs ${ingestTeam2}</h2>
                        <span class="text-sm text-purple-400">${existH2H.totalGames} partidos</span>
                    </div>
                    <div class="bg-purple-900/30 rounded-lg p-3 mb-4">
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div><p class="text-gray-400">Prom 1Q</p><p class="text-white font-bold">${(existH2H.avgQ1.team1+existH2H.avgQ1.team2).toFixed(1)}</p></div>
                            <div><p class="text-gray-400">Prom 1H</p><p class="text-white font-bold">${(existH2H.avgHalf.team1+existH2H.avgHalf.team2).toFixed(1)}</p></div>
                            <div><p class="text-gray-400">Prom Full</p><p class="text-white font-bold">${(existH2H.avgPts.team1+existH2H.avgPts.team2).toFixed(1)}</p></div>
                        </div>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">${gh}</div>
                </div>
            `;
        } else if (ingestTeam1 && ingestTeam2) {
            html += `<div class="glass rounded-xl p-5 text-center"><p class="text-gray-400">No hay partidos registrados</p></div>`;
        }
    }
    
    html += '</div>';
    return html;
}

function renderScoreInputs() {
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const ot = checkOT();
    let cols = 5;
    if (ot.needOT1) cols++;
    if (ot.needOT2) cols++;
    if (ot.needOT3) cols++;
    
    const gs = `display:grid;grid-template-columns:80px repeat(${cols-1},minmax(50px,1fr));gap:0.4rem;`;
    
    let h = `<div style="${gs}" class="mb-3 text-center items-center">
        <div class="text-gray-500 text-xs font-bold">EQUIPO</div>
        <div class="text-gray-400 text-xs font-bold">1Â° C</div>
        <div class="text-gray-400 text-xs font-bold">2Â° C</div>
        <div class="text-gray-400 text-xs font-bold">3Â° C</div>
        <div class="text-gray-400 text-xs font-bold">4Â° C</div>`;
    if (ot.needOT1) h += `<div class="text-yellow-400 text-xs font-bold animate-pulse">OT1</div>`;
    if (ot.needOT2) h += `<div class="text-orange-400 text-xs font-bold animate-pulse">OT2</div>`;
    if (ot.needOT3) h += `<div class="text-red-400 text-xs font-bold animate-pulse">OT3</div>`;
    h += '</div>';
    
    let lr = `<div style="${gs}" class="mb-3 items-center">
        <div class="text-cyan-400 font-bold text-xs truncate">ğŸ  ${ingestLocalTeam}</div>
        <input type="number" id="localQ1" value="${ingestScores.localQ1}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ1',this.value)">
        <input type="number" id="localQ2" value="${ingestScores.localQ2}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ2',this.value)">
        <input type="number" id="localQ3" value="${ingestScores.localQ3}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ3',this.value)">
        <input type="number" id="localQ4" value="${ingestScores.localQ4}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('localQ4',this.value)">`;
    if (ot.needOT1) lr += `<input type="number" id="localOT1" value="${ingestScores.localOT1}" placeholder="0" class="score-input ot-input p-2 rounded-lg text-yellow-400 text-center text-lg font-bold w-full" oninput="updateScore('localOT1',this.value)">`;
    if (ot.needOT2) lr += `<input type="number" id="localOT2" value="${ingestScores.localOT2}" placeholder="0" class="score-input p-2 rounded-lg text-orange-400 text-center text-lg font-bold border-orange-500 w-full" oninput="updateScore('localOT2',this.value)">`;
    if (ot.needOT3) lr += `<input type="number" id="localOT3" value="${ingestScores.localOT3}" placeholder="0" class="score-input p-2 rounded-lg text-red-400 text-center text-lg font-bold border-red-500 w-full" oninput="updateScore('localOT3',this.value)">`;
    lr += '</div>';
    
    let ar = `<div style="${gs}" class="mb-4 items-center">
        <div class="text-orange-400 font-bold text-xs truncate">âœˆï¸ ${away}</div>
        <input type="number" id="awayQ1" value="${ingestScores.awayQ1}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ1',this.value)">
        <input type="number" id="awayQ2" value="${ingestScores.awayQ2}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ2',this.value)">
        <input type="number" id="awayQ3" value="${ingestScores.awayQ3}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ3',this.value)">
        <input type="number" id="awayQ4" value="${ingestScores.awayQ4}" placeholder="0" class="score-input p-2 rounded-lg text-white text-center text-lg font-bold w-full" oninput="updateScore('awayQ4',this.value)">`;
    if (ot.needOT1) ar += `<input type="number" id="awayOT1" value="${ingestScores.awayOT1}" placeholder="0" class="score-input ot-input p-2 rounded-lg text-yellow-400 text-center text-lg font-bold w-full" oninput="updateScore('awayOT1',this.value)">`;
    if (ot.needOT2) ar += `<input type="number" id="awayOT2" value="${ingestScores.awayOT2}" placeholder="0" class="score-input p-2 rounded-lg text-orange-400 text-center text-lg font-bold border-orange-500 w-full" oninput="updateScore('awayOT2',this.value)">`;
    if (ot.needOT3) ar += `<input type="number" id="awayOT3" value="${ingestScores.awayOT3}" placeholder="0" class="score-input p-2 rounded-lg text-red-400 text-center text-lg font-bold border-red-500 w-full" oninput="updateScore('awayOT3',this.value)">`;
    ar += '</div>';
    
    let warn = '';
    if (ot.needOT1) warn = '<div class="text-yellow-400 text-center text-sm mb-3 animate-pulse">âš ï¸ EMPATE DETECTADO - Ingresa puntos del Overtime</div>';
    
    return h + lr + ar + warn;
}

function renderTotals() {
    const s = getScores();
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const lH = s.lQ1+s.lQ2, aH = s.aQ1+s.aQ2;
    const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
    const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
    const hadOT = s.lOT1>0 || s.aOT1>0;
    let win = 'Empate', wc = 'text-gray-400';
    if (lT > aT) { win = ingestLocalTeam; wc = 'text-cyan-400'; }
    else if (aT > lT) { win = away; wc = 'text-orange-400'; }
    
    return `
        <div class="border-t border-slate-600 pt-4 mt-4">
            <h3 class="text-white font-bold text-center mb-3">ğŸ“Š TOTALES CALCULADOS</h3>
            <div id="totalsDisplay" class="grid grid-cols-3 gap-4">
                <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">1er Tiempo</p>
                    <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lH}</p>
                    <p class="text-orange-400 font-bold">${away}: ${aH}</p>
                    <p class="text-yellow-400 font-black text-xl mt-1">Total: ${lH+aH}</p>
                </div>
                <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">Tiempo Completo${hadOT?' + OT':''}</p>
                    <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lT}</p>
                    <p class="text-orange-400 font-bold">${away}: ${aT}</p>
                    <p class="text-purple-400 font-black text-xl mt-1">Total: ${lT+aT}</p>
                </div>
                <div class="bg-green-500/20 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs">Ganador${hadOT?' (OT)':''}</p>
                    <p class="text-3xl font-black ${wc}">${win}</p>
                    <p class="text-white font-bold">${lT}-${aT}</p>
                </div>
            </div>
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N Y EVENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigateTo(v) {
    currentView = v;
    if (v === 'home') {
        localTeam = visitingTeam = '';
        lineQ1 = lineHalf = lineFull = '';
    }
    if (v === 'ingesta' && !ingestTeam1) {
        ingestTeam1 = ingestTeam2 = ingestLocalTeam = ingestDate = '';
        ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    }
    render();
}

function goToIngestWithTeams() {
    ingestTeam1 = localTeam;
    ingestTeam2 = visitingTeam;
    ingestLocalTeam = ingestDate = '';
    ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    navigateTo('ingesta');
}

function updateScore(field, value) {
    ingestScores[field] = value;
    const ot = checkOT();
    const ot1E = document.getElementById('localOT1');
    const ot2E = document.getElementById('localOT2');
    if ((ot.needOT1 && !ot1E) || (!ot.needOT1 && ot1E) || (ot.needOT2 && !ot2E) || (!ot.needOT2 && ot2E && ot.needOT1)) {
        const scrollY = window.scrollY;
        render();
        window.scrollTo(0, scrollY);
        return;
    }
    const td = document.getElementById('totalsDisplay');
    if (td) {
        const s = getScores();
        const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
        const lH = s.lQ1+s.lQ2, aH = s.aQ1+s.aQ2;
        const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
        const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
        const hadOT = s.lOT1>0 || s.aOT1>0;
        let win = 'Empate', wc = 'text-gray-400';
        if (lT > aT) { win = ingestLocalTeam; wc = 'text-cyan-400'; }
        else if (aT > lT) { win = away; wc = 'text-orange-400'; }
        td.innerHTML = `
            <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">1er Tiempo</p>
                <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lH}</p>
                <p class="text-orange-400 font-bold">${away}: ${aH}</p>
                <p class="text-yellow-400 font-black text-xl mt-1">Total: ${lH+aH}</p>
            </div>
            <div class="bg-purple-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">Tiempo Completo${hadOT?' + OT':''}</p>
                <p class="text-cyan-400 font-bold">${ingestLocalTeam}: ${lT}</p>
                <p class="text-orange-400 font-bold">${away}: ${aT}</p>
                <p class="text-purple-400 font-black text-xl mt-1">Total: ${lT+aT}</p>
            </div>
            <div class="bg-green-500/20 rounded-lg p-3 text-center">
                <p class="text-gray-400 text-xs">Ganador${hadOT?' (OT)':''}</p>
                <p class="text-3xl font-black ${wc}">${win}</p>
                <p class="text-white font-bold">${lT}-${aT}</p>
            </div>
        `;
    }
}

function saveGame() {
    if (!firebaseConnected) {
        showNotification('âš ï¸ No hay conexiÃ³n con Firebase', 'warning');
        return;
    }
    
    const di = document.getElementById('ingestDate');
    if (di) ingestDate = di.value;
    ['localQ1','localQ2','localQ3','localQ4','awayQ1','awayQ2','awayQ3','awayQ4','localOT1','awayOT1','localOT2','awayOT2','localOT3','awayOT3'].forEach(id => {
        const inp = document.getElementById(id);
        if (inp) ingestScores[id] = inp.value;
    });
    if (!ingestTeam1 || !ingestTeam2 || !ingestLocalTeam || !ingestDate) {
        showNotification('âš ï¸ Completa todos los campos', 'warning');
        return;
    }
    const s = getScores();
    const lT = s.lQ1+s.lQ2+s.lQ3+s.lQ4+s.lOT1+s.lOT2+s.lOT3;
    const aT = s.aQ1+s.aQ2+s.aQ3+s.aQ4+s.aOT1+s.aOT2+s.aOT3;
    if (lT === 0 || aT === 0) {
        showNotification('âš ï¸ Ingresa los puntos', 'warning');
        return;
    }
    if (lT === aT) {
        showNotification('âš ï¸ Empate. Ingresa Overtime', 'warning');
        return;
    }
    const away = ingestLocalTeam === ingestTeam1 ? ingestTeam2 : ingestTeam1;
    const [y,m,d] = ingestDate.split('-');
    const ms = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const df = ms[parseInt(m)-1] + ' ' + parseInt(d) + ', ' + y;
    let ots = 0;
    if (s.lOT1>0 || s.aOT1>0) ots = 1;
    if (s.lOT2>0 || s.aOT2>0) ots = 2;
    if (s.lOT3>0 || s.aOT3>0) ots = 3;
    
    addH2HGame(ingestTeam1, ingestTeam2, {
        date: df,
        localTeam: ingestLocalTeam,
        awayTeam: away,
        localQ1: s.lQ1, localQ2: s.lQ2, localQ3: s.lQ3, localQ4: s.lQ4,
        awayQ1: s.aQ1, awayQ2: s.aQ2, awayQ3: s.aQ3, awayQ4: s.aQ4,
        localOT1: s.lOT1, awayOT1: s.aOT1,
        localOT2: s.lOT2, awayOT2: s.aOT2,
        localOT3: s.lOT3, awayOT3: s.aOT3,
        overtimes: ots
    });
    
    ingestScores = {localQ1:'',localQ2:'',localQ3:'',localQ4:'',awayQ1:'',awayQ2:'',awayQ3:'',awayQ4:'',localOT1:'',awayOT1:'',localOT2:'',awayOT2:'',localOT3:'',awayOT3:''};
    ingestDate = '';
    ingestLocalTeam = '';
    render();
}

function deleteGame(t1, t2, i) {
    if (confirm('Â¿Eliminar este partido de Firebase?')) {
        deleteH2HGame(t1, t2, i);
    }
}

function attachEvents() {
    document.getElementById('localSelect')?.addEventListener('change', async e => { 
        localTeam = e.target.value;
        resetContextualFactors(); // Reset antes de auto-detectar
        if (localTeam && visitingTeam) {
            await autoDetectContextualFactors(localTeam, visitingTeam);
        }
        render(); 
        setTimeout(checkForValuePicks, 100);
    });
    document.getElementById('visitingSelect')?.addEventListener('change', async e => { 
        visitingTeam = e.target.value;
        resetContextualFactors(); // Reset antes de auto-detectar
        if (localTeam && visitingTeam) {
            await autoDetectContextualFactors(localTeam, visitingTeam);
        }
        render(); 
        setTimeout(checkForValuePicks, 100);
    });
    document.getElementById('ingestTeam1')?.addEventListener('change', e => { ingestTeam1 = e.target.value; ingestLocalTeam = ''; render(); });
    document.getElementById('ingestTeam2')?.addEventListener('change', e => { ingestTeam2 = e.target.value; ingestLocalTeam = ''; render(); });
    document.getElementById('ingestDate')?.addEventListener('change', e => { ingestDate = e.target.value; });
    document.getElementById('ingestLocal')?.addEventListener('change', e => { ingestLocalTeam = e.target.value; render(); });
}

function setType(p, v) {
    if (p === 'Q1') typeQ1 = v;
    if (p === 'Half') typeHalf = v;
    if (p === 'Full') typeFull = v;
    render();
    setTimeout(checkForValuePicks, 100);
}

function updateLine(p, v) {
    if (p === 'Q1') lineQ1 = v;
    if (p === 'Half') lineHalf = v;
    if (p === 'Full') lineFull = v;
    render();
    setTimeout(checkForValuePicks, 100);
}

function updateOdds(p, v) {
    if (p === 'Q1') oddsQ1 = v;
    if (p === 'Half') oddsHalf = v;
    if (p === 'Full') oddsFull = v;
    render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANKROLL MANAGEMENT FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadBankrollFromFirebase() {
    database.ref('bankroll').on('value', (snapshot) => {
        if (snapshot.exists()) {
            BANKROLL_DATA = snapshot.val();
        }
        // Asegurar que picks siempre sea un array
        if (!BANKROLL_DATA.picks || !Array.isArray(BANKROLL_DATA.picks)) {
            BANKROLL_DATA.picks = [];
        }
        if (!BANKROLL_DATA.dailyBanks) {
            BANKROLL_DATA.dailyBanks = {};
        }
        if (!BANKROLL_DATA.settings) {
            BANKROLL_DATA.settings = { alertThreshold: 20, initialBank: 0 };
        }
        if (currentView === 'bankroll') render();
    });
}

function saveBankrollToFirebase() {
    if (!firebaseConnected) {
        alert('âš ï¸ No hay conexiÃ³n con Firebase');
        return false;
    }
    database.ref('bankroll').set(BANKROLL_DATA);
    return true;
}

function getTodayDate() {
    return new Date().toISOString().split('T')[0];
}

function canSetDailyBank() {
    return !BANKROLL_DATA.dailyBanks[getTodayDate()];
}

function setDailyBank(amount) {
    const today = getTodayDate();
    if (BANKROLL_DATA.dailyBanks[today]) {
        alert('âš ï¸ Ya has registrado el bank de hoy');
        return false;
    }
    BANKROLL_DATA.dailyBanks[today] = parseFloat(amount);
    if (BANKROLL_DATA.settings.initialBank === 0) {
        BANKROLL_DATA.settings.initialBank = parseFloat(amount);
    }
    saveBankrollToFirebase();
    render();
    return true;
}

function getCurrentBank() {
    const dates = Object.keys(BANKROLL_DATA.dailyBanks).sort();
    if (dates.length === 0) return 0;
    
    const latestDate = dates[dates.length - 1];
    let bank = BANKROLL_DATA.dailyBanks[latestDate];
    
    const picks = BANKROLL_DATA.picks.filter(p => p.date >= latestDate && p.status !== 'pending');
    picks.forEach(pick => {
        if (pick.status === 'won') bank += pick.profit;
        else if (pick.status === 'lost') bank -= pick.stake;
    });
    
    return bank;
}

function addPickToBankroll(pickData) {
    const pick = {
        id: Date.now(),
        date: getTodayDate(),
        time: new Date().toLocaleTimeString('es-ES'),
        type: pickData.type,
        odds: parseFloat(pickData.odds),
        stake: parseFloat(pickData.stake),
        profit: (parseFloat(pickData.stake) * parseFloat(pickData.odds)) - parseFloat(pickData.stake),
        category: pickData.category || 'NBA',
        notes: pickData.notes || '',
        status: 'pending'
    };
    
    BANKROLL_DATA.picks.unshift(pick);
    saveBankrollToFirebase();
    render();
}

function updatePickStatus(pickId, status) {
    const pick = BANKROLL_DATA.picks.find(p => p.id === pickId);
    if (pick) {
        pick.status = status;
        saveBankrollToFirebase();
        render();
    }
}

function deletePickFromBankroll(pickId) {
    BANKROLL_DATA.picks = BANKROLL_DATA.picks.filter(p => p.id !== pickId);
    saveBankrollToFirebase();
    render();
}

function getFilteredPicks() {
    if (!BANKROLL_DATA || !BANKROLL_DATA.picks || !Array.isArray(BANKROLL_DATA.picks)) {
        return [];
    }
    let picks = BANKROLL_DATA.picks.filter(p => p.status !== 'pending');
    
    if (filterPeriod !== 'all') {
        const today = new Date();
        const startDate = new Date();
        
        if (filterPeriod === 'today') startDate.setHours(0, 0, 0, 0);
        else if (filterPeriod === 'week') startDate.setDate(today.getDate() - 7);
        else if (filterPeriod === 'month') startDate.setMonth(today.getMonth() - 1);
        
        picks = picks.filter(p => new Date(p.date) >= startDate);
    }
    
    if (filterType !== 'all') picks = picks.filter(p => p.type === filterType);
    
    return picks;
}

function calculateStats() {
    const picks = getFilteredPicks();
    const totalPicks = picks.length;
    const wonPicks = picks.filter(p => p.status === 'won').length;
    const lostPicks = picks.filter(p => p.status === 'lost').length;
    
    const totalStaked = picks.reduce((sum, p) => sum + p.stake, 0);
    const totalProfit = picks.reduce((sum, p) => {
        return sum + (p.status === 'won' ? p.profit : -p.stake);
    }, 0);
    
    const strikeRate = totalPicks > 0 ? (wonPicks / totalPicks) * 100 : 0;
    const roi = totalStaked > 0 ? (totalProfit / totalStaked) * 100 : 0;
    const yield_ = totalPicks > 0 ? (totalProfit / totalStaked) * 100 : 0;
    const avgOdds = totalPicks > 0 ? picks.reduce((sum, p) => sum + p.odds, 0) / totalPicks : 0;
    
    let currentStreak = 0, streakType = 'none';
    for (let i = 0; i < picks.length; i++) {
        if (i === 0) {
            currentStreak = 1;
            streakType = picks[i].status;
        } else if (picks[i].status === streakType) {
            currentStreak++;
        } else break;
    }
    
    const singlePicks = picks.filter(p => p.type === 'single');
    const comboPicks = picks.filter(p => p.type === 'combo');
    
    return {
        totalPicks, wonPicks, lostPicks, strikeRate, roi,
        yield: yield_, avgOdds, totalProfit, totalStaked,
        currentStreak, streakType,
        singlePicks, comboPicks,
        currentBank: getCurrentBank(),
        initialBank: BANKROLL_DATA.settings.initialBank
    };
}

function exportToCSV() {
    const picks = BANKROLL_DATA.picks;
    let csv = 'Fecha,Hora,Tipo,Cuota,Importe,Ganancia,CategorÃ­a,Estado,Notas\n';
    picks.forEach(pick => {
        csv += `${pick.date},${pick.time},${pick.type},${pick.odds},${pick.stake},${pick.profit.toFixed(2)},${pick.category},${pick.status},"${pick.notes}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bankroll_export_${getTodayDate()}.csv`;
    a.click();
}

function createBankrollChart() {
    const canvas = document.getElementById('bankrollChart');
    if (!canvas) return;
    
    if (bankrollChart) bankrollChart.destroy();
    
    const sortedDates = Object.keys(BANKROLL_DATA.dailyBanks).sort();
    const labels = [];
    const data = [];
    
    sortedDates.forEach(date => {
        let bank = BANKROLL_DATA.dailyBanks[date];
        const dayPicks = BANKROLL_DATA.picks.filter(p => p.date === date && p.status !== 'pending');
        dayPicks.forEach(pick => {
            if (pick.status === 'won') bank += pick.profit;
            else if (pick.status === 'lost') bank -= pick.stake;
        });
        labels.push(date);
        data.push(bank);
    });
    
    bankrollChart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Bank',
                data: data,
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#fff' } },
                x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#fff' } }
            }
        }
    });
}

function showSetBankModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="glass-card rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-white mb-4">Registrar Bank de Hoy</h3>
            <input type="number" id="bankInput" step="0.01" placeholder="$0.00" 
                   class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white font-bold text-center text-2xl mb-4 focus:border-yellow-500 focus:outline-none">
            <div class="flex gap-4">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 py-3 bg-gray-600 rounded-lg text-white font-bold hover:bg-gray-700">
                    Cancelar
                </button>
                <button onclick="setDailyBank(document.getElementById('bankInput').value);this.closest('.fixed').remove()" 
                        class="flex-1 py-3 bg-green-600 rounded-lg text-white font-bold hover:bg-green-700">
                    Guardar
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showAddPickModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 overflow-y-auto';
    modal.innerHTML = `
        <div class="glass-card rounded-xl p-8 max-w-2xl w-full mx-4 my-8">
            <h3 class="text-2xl font-bold text-white mb-4">Agregar Nuevo Pick</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-gray-400 text-sm block mb-2">Tipo de Apuesta</label>
                    <select id="pickType" class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white">
                        <option value="single">ğŸ¯ Sencilla</option>
                        <option value="combo">ğŸ² Combinada</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm block mb-2">Cuota</label>
                        <input type="number" id="pickOdds" step="0.01" placeholder="2.00" 
                               class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white font-bold focus:border-yellow-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm block mb-2">Importe ($)</label>
                        <input type="number" id="pickStake" step="0.01" placeholder="100.00" 
                               class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white font-bold focus:border-yellow-500 focus:outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="text-gray-400 text-sm block mb-2">CategorÃ­a</label>
                    <select id="pickCategory" class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white">
                        <option value="NBA">ğŸ€ NBA</option>
                        <option value="NFL">ğŸˆ NFL</option>
                        <option value="FÃºtbol">âš½ FÃºtbol</option>
                        <option value="MLB">âš¾ MLB</option>
                        <option value="NHL">ğŸ’ NHL</option>
                        <option value="Otro">ğŸ² Otro</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-gray-400 text-sm block mb-2">Notas (opcional)</label>
                    <textarea id="pickNotes" rows="3" placeholder="AnÃ¡lisis, razÃ³n del pick, etc." 
                              class="w-full px-4 py-3 bg-white/10 border-2 border-white/20 rounded-lg text-white focus:border-yellow-500 focus:outline-none"></textarea>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 py-3 bg-gray-600 rounded-lg text-white font-bold hover:bg-gray-700">
                    Cancelar
                </button>
                <button onclick="submitPickToBankroll();this.closest('.fixed').remove()" 
                        class="flex-1 py-3 bg-purple-600 rounded-lg text-white font-bold hover:bg-purple-700">
                    Agregar Pick
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function submitPickToBankroll() {
    const type = document.getElementById('pickType').value;
    const odds = document.getElementById('pickOdds').value;
    const stake = document.getElementById('pickStake').value;
    const category = document.getElementById('pickCategory').value;
    const notes = document.getElementById('pickNotes').value;
    
    if (!odds || !stake || parseFloat(odds) <= 0 || parseFloat(stake) <= 0) {
        alert('Por favor completa todos los campos correctamente');
        return;
    }
    
    addPickToBankroll({ type, odds, stake, category, notes });
}

function renderBankrollView() {
    const stats = calculateStats();
    const canSetBank = canSetDailyBank();
    
    return `
        <!-- BotÃ³n Volver -->
        <button onclick="navigateTo('home')" class="mb-4 px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all flex items-center gap-2" style="background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); color: white;">
            â† Volver al Inicio
        </button>
        
        <!-- Hero Section - Bank Actual -->
        <div class="rounded-3xl p-8 mb-6 shadow-2xl border border-yellow-500/30" style="background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0d1b2a 100%);">
            <div class="flex items-center justify-between flex-wrap gap-6">
                <div>
                    <div class="flex items-center gap-3 mb-3">
                        <div class="text-5xl">ğŸ’°</div>
                        <h2 class="text-3xl font-display gradient-text-animated">BANKROLL</h2>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Bank Actual</p>
                    <p class="text-7xl font-display gradient-text-animated mb-3">$${stats.currentBank.toFixed(2)}</p>
                    <div class="flex items-center gap-4">
                        <div class="px-4 py-2 rounded-xl" style="background: ${stats.totalProfit >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};">
                            <p class="text-${stats.totalProfit >= 0 ? 'green' : 'red'}-400 text-2xl font-bold">
                                ${stats.totalProfit >= 0 ? '+' : ''}$${stats.totalProfit.toFixed(2)}
                            </p>
                        </div>
                        <div class="text-gray-400">
                            <p class="text-sm">Bank Inicial</p>
                            <p class="text-xl font-bold text-white">$${stats.initialBank.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    ${canSetBank ? `
                        <button onclick="showSetBankModal()" class="btn-primary px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-105 transition-all" style="background: linear-gradient(135deg, #FFD700 0%, #F59E0B 100%); color: #0d1b2a;">
                            ğŸ“ Registrar Bank de Hoy
                        </button>
                    ` : `
                        <div class="px-6 py-3 rounded-xl border-2 border-green-500/50" style="background: rgba(34, 197, 94, 0.1);">
                            <p class="text-green-400 text-lg font-bold">âœ… Bank registrado hoy</p>
                        </div>
                    `}
                    <button onclick="showAddPickModal()" class="px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-105 transition-all" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        â• Agregar Pick
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filtros y Exportar -->
        <div class="rounded-2xl p-4 mb-6 border border-white/10" style="background: rgba(27, 38, 59, 0.6);">
            <div class="flex gap-4 items-center flex-wrap">
                <select onchange="filterPeriod=this.value;render()" class="select-premium px-4 py-3 rounded-xl text-white font-semibold" style="background: rgba(13, 27, 42, 0.8); border: 2px solid rgba(255, 215, 0, 0.2);">
                    <option value="all">ğŸ“… Todo el tiempo</option>
                    <option value="today">ğŸ“… Hoy</option>
                    <option value="week">ğŸ“… Esta semana</option>
                    <option value="month">ğŸ“… Este mes</option>
                </select>
                <select onchange="filterType=this.value;render()" class="select-premium px-4 py-3 rounded-xl text-white font-semibold" style="background: rgba(13, 27, 42, 0.8); border: 2px solid rgba(255, 215, 0, 0.2);">
                    <option value="all">ğŸ² Todos los tipos</option>
                    <option value="single">ğŸ¯ Sencillas</option>
                    <option value="combo">ğŸ² Combinadas</option>
                </select>
                <button onclick="exportToCSV()" class="ml-auto px-6 py-3 rounded-xl font-bold hover:scale-105 transition-all" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
                    ğŸ“¥ Exportar CSV
                </button>
            </div>
        </div>
        
        <!-- MÃ©tricas Principales -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">ROI</p>
                <p class="text-4xl font-display text-${stats.roi >= 0 ? 'green' : 'red'}-400 font-bold">${stats.roi.toFixed(1)}%</p>
            </div>
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Yield</p>
                <p class="text-4xl font-display text-cyan-400 font-bold">${stats.yield.toFixed(1)}%</p>
            </div>
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Strike Rate</p>
                <p class="text-4xl font-display text-purple-400 font-bold">${stats.strikeRate.toFixed(1)}%</p>
            </div>
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Cuota Avg</p>
                <p class="text-4xl font-display gradient-text-animated font-bold">${stats.avgOdds.toFixed(2)}</p>
            </div>
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Racha</p>
                <p class="text-3xl font-display text-${stats.streakType === 'won' ? 'green' : 'red'}-400 font-bold">
                    ${stats.currentStreak}${stats.streakType === 'won' ? 'W' : stats.streakType === 'lost' ? 'L' : '-'}
                </p>
            </div>
            <div class="rounded-xl p-5 shadow-lg hover:scale-105 transition-all border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">Total Picks</p>
                <p class="text-4xl font-display text-white font-bold">${stats.totalPicks}</p>
            </div>
        </div>
        
        <!-- GrÃ¡fica de EvoluciÃ³n -->
        <div class="rounded-2xl p-6 mb-6 shadow-xl border border-yellow-500/30" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.9) 0%, rgba(27, 38, 59, 0.9) 100%);">
            <h3 class="text-2xl font-display gradient-text-animated mb-4">ğŸ“ˆ EVOLUCIÃ“N DEL BANK</h3>
            <div style="height: 350px;">
                <canvas id="bankrollChart"></canvas>
            </div>
        </div>
        
        <!-- EstadÃ­sticas Detalladas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="rounded-2xl p-6 shadow-xl border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <h3 class="text-xl font-display text-white mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“Š</span> POR TIPO DE APUESTA
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-4 rounded-xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                        <span class="text-gray-300 font-semibold">ğŸ¯ Sencillas</span>
                        <div class="text-right">
                            <p class="text-white font-bold text-lg">${stats.singlePicks.length} picks</p>
                            <p class="text-sm ${stats.singlePicks.filter(p => p.status === 'won').length > stats.singlePicks.filter(p => p.status === 'lost').length ? 'text-green-400' : 'text-red-400'}">
                                ${stats.singlePicks.filter(p => p.status === 'won').length}W - ${stats.singlePicks.filter(p => p.status === 'lost').length}L
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-4 rounded-xl" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                        <span class="text-gray-300 font-semibold">ğŸ² Combinadas</span>
                        <div class="text-right">
                            <p class="text-white font-bold text-lg">${stats.comboPicks.length} picks</p>
                            <p class="text-sm ${stats.comboPicks.filter(p => p.status === 'won').length > stats.comboPicks.filter(p => p.status === 'lost').length ? 'text-green-400' : 'text-red-400'}">
                                ${stats.comboPicks.filter(p => p.status === 'won').length}W - ${stats.comboPicks.filter(p => p.status === 'lost').length}L
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="rounded-2xl p-6 shadow-xl border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8) 0%, rgba(27, 38, 59, 0.8) 100%);">
                <h3 class="text-xl font-display text-white mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ’¡</span> RESUMEN
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-4 rounded-xl" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
                        <span class="text-green-300 font-semibold">âœ… Ganados</span>
                        <span class="text-green-400 font-bold text-2xl">${stats.wonPicks}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 rounded-xl" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
                        <span class="text-red-300 font-semibold">âŒ Perdidos</span>
                        <span class="text-red-400 font-bold text-2xl">${stats.lostPicks}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lista de Picks Recientes -->
        <div class="rounded-2xl p-6 shadow-xl border border-white/10" style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.9) 0%, rgba(27, 38, 59, 0.9) 100%);">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-display gradient-text-animated flex items-center gap-2">
                    <span class="text-3xl">ğŸ“‹</span> PICKS RECIENTES
                </h3>
            </div>
            <div class="space-y-3">
                ${(!BANKROLL_DATA.picks || BANKROLL_DATA.picks.length === 0) ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ“Š</div>
                        <p class="text-gray-400 text-xl mb-2">No hay picks registrados</p>
                        <p class="text-gray-500">Comienza agregando tu primer pick</p>
                    </div>
                ` : BANKROLL_DATA.picks.slice(0, 15).map(pick => `
                    <div class="rounded-xl p-4 hover:scale-[1.02] transition-all" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex-1 min-w-[300px]">
                                <div class="flex items-center gap-3 mb-3 flex-wrap">
                                    <span class="${pick.status === 'won' ? 'win-badge' : pick.status === 'lost' ? 'loss-badge' : 'pending-badge'} px-3 py-1 rounded-full text-xs font-bold">
                                        ${pick.status === 'won' ? 'âœ… GANADO' : pick.status === 'lost' ? 'âŒ PERDIDO' : 'â³ PENDIENTE'}
                                    </span>
                                    <span class="text-cyan-400 font-bold">${pick.type === 'single' ? 'ğŸ¯ Sencilla' : 'ğŸ² Combinada'}</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">${pick.category}</span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                    <div>
                                        <p class="text-gray-400 text-xs">Fecha</p>
                                        <p class="text-white font-semibold">${pick.date}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 text-xs">Cuota</p>
                                        <p class="gradient-text-animated font-bold text-lg">${pick.odds.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 text-xs">Stake</p>
                                        <p class="text-white font-bold">$${pick.stake.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 text-xs">Ganancia</p>
                                        <p class="text-green-400 font-bold">$${pick.profit.toFixed(2)}</p>
                                    </div>
                                </div>
                                ${pick.notes ? `<p class="text-gray-400 text-sm mt-2">ğŸ“ ${pick.notes}</p>` : ''}
                            </div>
                            <div class="flex gap-2">
                                ${pick.status === 'pending' ? `
                                    <button onclick="updatePickStatus(${pick.id}, 'won')" class="px-4 py-2 rounded-lg text-white font-bold hover:scale-110 transition-all" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                                        âœ…
                                    </button>
                                    <button onclick="updatePickStatus(${pick.id}, 'lost')" class="px-4 py-2 rounded-lg text-white font-bold hover:scale-110 transition-all" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                        âŒ
                                    </button>
                                ` : ''}
                                <button onclick="if(confirm('Â¿Eliminar pick?'))deletePickFromBankroll(${pick.id})" class="px-4 py-2 rounded-lg text-white font-bold hover:scale-110 transition-all" style="background: rgba(107, 114, 128, 0.8);">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}


document.addEventListener('DOMContentLoaded', async () => {
    // Cargar VALUE_PICKS desde localStorage
    loadValuePicksFromStorage();
    // Primero cargar estadÃ­sticas desde API
    await loadTeamStatsFromAPI();
    // Luego cargar datos de Firebase
    loadH2HFromFirebase();
    loadBankrollFromFirebase();
});
    </script>
</body>
</html>
